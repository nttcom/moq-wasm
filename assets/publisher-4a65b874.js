import{_ as M,M as O}from"./moqt_client_sample-4b7b2ba2.js";const f=900,j="secret";async function L(n,o,s,c,r,e,t){var v,B,a,S,k,I,A,w,E;const i=new Uint8Array(r.byteLength);r.copyTo(i);const d={type:r.type,timestamp:r.timestamp,duration:r.duration,byteLength:r.byteLength,data:Array.from(i),decoderConfig:{codec:(v=e==null?void 0:e.decoderConfig)==null?void 0:v.codec,codedHeight:(B=e==null?void 0:e.decoderConfig)==null?void 0:B.codedHeight,codedWidth:(a=e==null?void 0:e.decoderConfig)==null?void 0:a.codedWidth,colorSpace:(S=e==null?void 0:e.decoderConfig)==null?void 0:S.colorSpace,description:(k=e==null?void 0:e.decoderConfig)==null?void 0:k.description,displayAspectHeight:(I=e==null?void 0:e.decoderConfig)==null?void 0:I.displayAspectHeight,displayAspectWidth:(A=e==null?void 0:e.decoderConfig)==null?void 0:A.displayAspectWidth,hardwareAcceleration:(w=e==null?void 0:e.decoderConfig)==null?void 0:w.hardwareAcceleration,optimizeForLatency:(E=e==null?void 0:e.decoderConfig)==null?void 0:E.optimizeForLatency},temporalLayer:e==null?void 0:e.temporalLayerId},g=new TextEncoder,y=JSON.stringify({chunk:d}),C=g.encode(y);await t.sendSubgroupStreamObject(BigInt(n),o,s,c,void 0,C),c===BigInt(f-1)&&(await t.sendSubgroupStreamObject(BigInt(n),o,s,BigInt(f),3,Uint8Array.from([])),console.log("send Object(ObjectStatus=EndOfGroup)"))}const p=()=>document.getElementById("form");let l=null;function T(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const o={audio:!0,video:{width:{exact:1920},height:{exact:1080}}};l=await navigator.mediaDevices.getUserMedia(o);const s=document.getElementById("video");s.srcObject=l})}const u={video:{objectId:0n,groupId:-1n,subgroups:{0:{},1:{},2:{}}},audio:{objectId:0n,groupId:0n,subgroups:{0:{isSendedSubgroupHeader:!1}}}},b=new Worker("videoEncoder.ts");async function m(n,o,s){const c=p(),r=c["video-object-track-alias"].value,e=c["video-publisher-priority"].value;if(n.type==="key"){u.video.groupId++,u.video.objectId=BigInt(0);const t=Object.keys(u.video.subgroups).map(BigInt);for(const i of t)await s.sendSubgroupStreamHeaderMessage(BigInt(r),u.video.groupId,i,e),console.log("send subgroup stream header")}L(r,u.video.groupId,BigInt(o==null?void 0:o.svc.temporalLayerId),u.video.objectId,n,o,s),u.video.objectId++}const h=new Worker("audioEncoder.ts");function H(n){n.onSetup(async o=>{console.log({serverSetup:o})}),n.onAnnounce(async o=>{console.log({announceMessage:o});const s=o.track_namespace;await n.sendAnnounceOkMessage(s)}),n.onAnnounceResponce(async o=>{console.log({announceResponceMessage:o})}),n.onSubscribe(async(o,s,c)=>{console.log({subscribeMessage:o});const r=p(),e=BigInt(o.subscribe_id),t=BigInt(o.track_alias);if(console.log("subscribeId",e,"trackAlias",t),s){const i=0n,d=Array.from(r["forwarding-preference"]).filter(g=>g.checked)[0].value;await n.sendSubscribeOkMessage(e,i,j,d)}else{const i="subscribe error";await n.sendSubscribeErrorMessage(o.subscribe_id,c,i)}})}function P(n){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const s=p(),c=new BigUint64Array("0xff00000A".split(",").map(BigInt)),r=BigInt(s["max-subscribe-id"].value);await n.sendSetupMessage(c,r)})}function U(n){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const c=p()["announce-track-namespace"].value.split("/");await n.sendAnnounceMessage(c,j)})}function _(n){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(l==null){console.error("mediaStream is null");return}b.onmessage=async d=>{const{chunk:g,metadata:y}=d.data;console.log(g,y),m(g,y,n)},h.onmessage=async d=>{d.data};const[s]=l.getVideoTracks(),r=new MediaStreamTrackProcessor({track:s}).readable;b.postMessage({type:"keyframeInterval",keyframeInterval:f}),b.postMessage({type:"videoStream",videoStream:r},[r]);const[e]=l.getAudioTracks(),i=new MediaStreamTrackProcessor({track:e}).readable;h.postMessage({type:"audioStream",audioStream:i},[i])})}function W(n){P(n),U(n),_(n)}M().then(async()=>{T(),document.getElementById("connectBtn").addEventListener("click",async()=>{const s=p().url.value,c=new O(s);H(c),W(c),await c.start()})});
