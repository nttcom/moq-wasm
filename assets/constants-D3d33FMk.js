function b(u){if(typeof u=="bigint")return u;try{return BigInt(u)}catch{throw new Error(`Invalid alias value: ${u}`)}}function t(u){return b(u).toString()}class h{video={groupId:-1n,objectId:0n,subgroups:new Map([[0,{sentAliases:new Set}]])};audio={groupId:0n,objectId:0n,subgroups:new Map([[0,{sentAliases:new Set}]])};ensureVideoSubgroup(e){this.ensureSubgroup(this.video,e)}ensureAudioSubgroup(e){this.ensureSubgroup(this.audio,e)}advanceVideoGroup(){this.video.groupId+=1n,this.video.objectId=0n,this.resetHeaders(this.video)}getVideoGroupId(){return this.video.groupId}getVideoObjectId(){return this.video.objectId}incrementVideoObject(){this.video.objectId+=1n}hasVideoHeaderSent(e,o){return this.hasHeaderSent(this.video,e,o)}markVideoHeaderSent(e,o){this.markHeaderSent(this.video,e,o)}getAudioGroupId(){return this.audio.groupId}getAudioObjectId(){return this.audio.objectId}incrementAudioObject(){this.audio.objectId+=1n}shouldSendAudioHeader(e,o){return!this.hasHeaderSent(this.audio,e,o)}markAudioHeaderSent(e,o){this.markHeaderSent(this.audio,e,o)}listVideoSubgroups(){return Array.from(this.video.subgroups.keys())}resetAlias(e){const o=t(e);for(const s of this.video.subgroups.values())s.sentAliases.delete(o);for(const s of this.audio.subgroups.values())s.sentAliases.delete(o)}ensureSubgroup(e,o){e.subgroups.has(o)||e.subgroups.set(o,{sentAliases:new Set})}resetHeaders(e){for(const o of e.subgroups.values())o.sentAliases.clear()}hasHeaderSent(e,o,s){return this.ensureSubgroup(e,s),e.subgroups.get(s).sentAliases.has(t(o))}markHeaderSent(e,o,s){this.ensureSubgroup(e,s),e.subgroups.get(s).sentAliases.add(t(o))}}async function p({chunk:u,metadata:e,trackAliases:o,publisherPriority:s,client:n,transportState:i,sender:g}){if(!o.length)return;const d=Number(e?.svc?.temporalLayerId??0);if(i.ensureVideoSubgroup(d),u.type==="key"){i.advanceVideoGroup();for(const r of o)for(const a of i.listVideoSubgroups())await n.sendSubgroupStreamHeaderMessage(r,i.getVideoGroupId(),BigInt(a),s),i.markVideoHeaderSent(r,a)}else for(const r of o)i.hasVideoHeaderSent(r,d)||(await n.sendSubgroupStreamHeaderMessage(r,i.getVideoGroupId(),BigInt(d),s),i.markVideoHeaderSent(r,d));for(const r of o)await g(r,i.getVideoGroupId(),BigInt(d),i.getVideoObjectId(),u,n);i.incrementVideoObject()}const c=300;export{c as K,h as M,p as s};
