import{_ as C,M as O}from"./moqt_client_sample-0b69746b.js";const b=900,E="secret";async function L(n,o,s,c,r,e,t){var f,B,v,I,S,k,a,w,A;const i=new Uint8Array(r.byteLength);r.copyTo(i);const g={type:r.type,timestamp:r.timestamp,duration:r.duration,byteLength:r.byteLength,data:Array.from(i),decoderConfig:{codec:(f=e==null?void 0:e.decoderConfig)==null?void 0:f.codec,codedHeight:(B=e==null?void 0:e.decoderConfig)==null?void 0:B.codedHeight,codedWidth:(v=e==null?void 0:e.decoderConfig)==null?void 0:v.codedWidth,colorSpace:(I=e==null?void 0:e.decoderConfig)==null?void 0:I.colorSpace,description:(S=e==null?void 0:e.decoderConfig)==null?void 0:S.description,displayAspectHeight:(k=e==null?void 0:e.decoderConfig)==null?void 0:k.displayAspectHeight,displayAspectWidth:(a=e==null?void 0:e.decoderConfig)==null?void 0:a.displayAspectWidth,hardwareAcceleration:(w=e==null?void 0:e.decoderConfig)==null?void 0:w.hardwareAcceleration,optimizeForLatency:(A=e==null?void 0:e.decoderConfig)==null?void 0:A.optimizeForLatency},temporalLayer:e==null?void 0:e.temporalLayerId},p=new TextEncoder,h=JSON.stringify({chunk:g}),j=p.encode(h);await t.sendSubgroupStreamObject(BigInt(n),o,s,c,void 0,j),c===BigInt(b-1)&&(await t.sendSubgroupStreamObject(BigInt(n),o,s,BigInt(b),3,Uint8Array.from([])),console.log("send Object(ObjectStatus=EndOfGroup)"))}const u=()=>document.getElementById("form");let l=null;function M(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const o={audio:!1,video:{width:{exact:1920},height:{exact:1080}}};l=await navigator.mediaDevices.getUserMedia(o);const s=document.getElementById("video");s.srcObject=l})}const d={video:{objectId:0n,groupId:-1n,subgroups:{0:{}}},audio:{objectId:0n,groupId:0n,subgroups:{0:{isSendedSubgroupHeader:!1}}}},y=new Worker(new URL("/moq-wasm/assets/videoEncoder-5af129ac.js",self.location),{type:"module"});async function m(n,o,s){const c=u(),r=c["video-object-track-alias"].value,e=c["video-publisher-priority"].value;if(n.type==="key"){d.video.groupId++,d.video.objectId=BigInt(0);const t=Object.keys(d.video.subgroups).map(BigInt);for(const i of t)await s.sendSubgroupStreamHeaderMessage(BigInt(r),d.video.groupId,i,e),console.log("send subgroup stream header")}L(r,d.video.groupId,BigInt(o==null?void 0:o.svc.temporalLayerId),d.video.objectId,n,o,s),d.video.objectId++}const U=new Worker(new URL("/moq-wasm/assets/audioEncoder-988b805d.js",self.location),{type:"module"});function H(n){n.onSetup(async o=>{console.log({serverSetup:o})}),n.onAnnounce(async o=>{console.log({announceMessage:o});const s=o.track_namespace;await n.sendAnnounceOkMessage(s)}),n.onAnnounceResponce(async o=>{console.log({announceResponceMessage:o})}),n.onSubscribe(async(o,s,c)=>{console.log({subscribeMessage:o});const r=u(),e=BigInt(o.subscribe_id),t=BigInt(o.track_alias);if(console.log("subscribeId",e,"trackAlias",t),s){const i=0n,g=Array.from(r["forwarding-preference"]).filter(p=>p.checked)[0].value;await n.sendSubscribeOkMessage(e,i,E,g)}else{const i="subscribe error";await n.sendSubscribeErrorMessage(o.subscribe_id,c,i)}})}function T(n){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const s=u(),c=new BigUint64Array("0xff00000A".split(",").map(BigInt)),r=BigInt(s["max-subscribe-id"].value);await n.sendSetupMessage(c,r)})}function _(n){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const c=u()["announce-track-namespace"].value.split("/");await n.sendAnnounceMessage(c,E)})}function W(n){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(console.log("clicked sendSubgroupObjectBtn"),l==null){console.error("mediaStream is null");return}y.onmessage=async e=>{const{chunk:t,metadata:i}=e.data;m(t,i,n)},U.onmessage=async e=>{e.data};const[s]=l.getVideoTracks(),r=new MediaStreamTrackProcessor({track:s}).readable;y.postMessage({type:"keyframeInterval",keyframeInterval:b}),y.postMessage({type:"videoStream",videoStream:r},[r])})}function x(n){T(n),_(n),W(n)}C().then(async()=>{M(),document.getElementById("connectBtn").addEventListener("click",async()=>{const s=u().url.value,c=new O(s);H(c),x(c),await c.start()})});
