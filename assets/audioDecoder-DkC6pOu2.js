(function(){"use strict";function f(t){if(t.byteLength<4)throw new Error("Payload too small to contain metadata");const s=new DataView(t.buffer,t.byteOffset,t.byteLength).getUint32(0),n=4+s;if(t.byteLength<n)throw new Error("Payload too small to contain metadata");const a=t.slice(4,4+s),o=JSON.parse(new TextDecoder().decode(a)),r=t.slice(4+s);return{metadata:o,data:r}}const d=250,l=1800;class m{constructor(e=l){this.maxBufferSize=e}buffer=[];hasPoppedOnce=!1;firstInsertTimestamp=null;push(e,s,n){if(!n.objectPayloadLength)return;const a=f(n.objectPayload);if(!a)return;const o=n;o.cachedChunk=a,o.remotePTS=a.metadata.timestamp,o.localPTS=performance.timeOrigin+performance.now();const r=performance.now(),w={groupId:e,objectId:s,bufferInsertTimestamp:r,sentAt:a.metadata.sentAt,object:o},L=this.findInsertPos(e,s);this.buffer.splice(L,0,w),this.firstInsertTimestamp===null&&(this.firstInsertTimestamp=r),this.buffer.length>this.maxBufferSize&&(console.warn("[AudioJitterBuffer] Buffer full, dropping oldest entry"),this.buffer.shift())}pop(){return this.popWithMetadata()}popWithMetadata(){if(this.buffer.length===0)return null;if(!this.hasPoppedOnce){if(this.firstInsertTimestamp===null||performance.now()-this.firstInsertTimestamp<d)return null;const s=this.buffer[this.buffer.length-1];return s?(this.buffer.length=0,this.hasPoppedOnce=!0,s):null}const e=this.buffer[0];return this.buffer.shift(),e}findInsertPos(e,s){for(let n=this.buffer.length-1;n>=0;n--){const a=this.buffer[n];if(a.groupId===e&&a.objectId<s||a.groupId<e)return n+1}return 0}}function h(t,e=1e3){let s=0,n=performance.now();return{addBytes(a){s+=a;const o=performance.now();if(o-n>=e){const r=s*8/1e3;t(r),s=0,n=o}}}}const p=h(t=>{self.postMessage({type:"bitrate",media:"audio",kbps:t})}),b={codec:"opus",sampleRate:48e3,numberOfChannels:1,bitrate:64e3};let i,c=null;async function g(){function t(n){self.postMessage({type:"audioData",audioData:n}),n.close()}const e={output:t,error:n=>{console.log(n.message)}},s=new AudioDecoder(e);return s.configure(b),s}const T=5,u=new m(1800);setInterval(()=>{const t=u.pop();if(!t)return;console.log(t);const e=t?.object;e&&E(e)},T),self.onmessage=async t=>{const e={objectId:t.data.subgroupStreamObject.objectId,objectPayloadLength:t.data.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(t.data.subgroupStreamObject.objectPayload),objectStatus:t.data.subgroupStreamObject.objectStatus};p.addBytes(e.objectPayloadLength),u.push(t.data.groupId,e.objectId,e)};async function E(t){const e=t.cachedChunk;y(e.metadata.sentAt);const s=A(e.metadata.timestamp),n=new EncodedAudioChunk({type:e.metadata.type,timestamp:s,duration:e.metadata.duration??void 0,data:e.data});(!i||i.state==="closed")&&(i=await g()),await i.decode(n)}function y(t){const e=Date.now()-t;self.postMessage({type:"latency",media:"audio",ms:e})}function A(t){return c===null&&(c=t),t-c}})();
