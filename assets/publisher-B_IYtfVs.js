import{M as h}from"./moqtClient-DmrHV8BM.js";import{s as v,a as A,K as O,M as E}from"./constants-DoWPd8y7.js";const k="secret";function j(e,n=1e3){let o=0,s=performance.now();return{addBytes(t){o+=t;const i=performance.now();if(i-s>=n){const a=o*8/1e6;console.log(`${e}: ${a.toFixed(2)} Mbps`),o=0,s=i}}}}const C=j("chunkData bitrate"),S=new Map;async function L(e,n,o,s,t,i,a){const r=S.get(e);if(r&&r.groupId!==n){const d=r.lastObjectId+1n;await i.sendSubgroupStreamObject(e,r.groupId,0n,d,3,new Uint8Array(0)),console.log(`[MediaPublisher] Sent EndOfGroup trackAlias=${e} groupId=${r.groupId} subgroupId=0 objectId=${d}`)}C.addBytes(t.byteLength);const c=v({type:t.type,timestamp:t.timestamp,duration:t.duration??null,byteLength:t.byteLength,copyTo:d=>t.copyTo(d)},a);await i.sendSubgroupStreamObject(BigInt(e),n,o,s,void 0,c),S.set(e,{groupId:n,lastObjectId:s})}async function T(e,n,o,s,t,i,a){const r=v({type:t.type,timestamp:t.timestamp,duration:t.duration??null,byteLength:t.byteLength,copyTo:c=>t.copyTo(c)},a);await i.sendSubgroupStreamObject(BigInt(e),n,o,s,void 0,r)}const m=()=>document.getElementById("form");let p=null;const l=new h,u=new E;function w(){const e=l.getRawClient();if(!e)throw new Error("MOQT client not connected");return e}function P(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const n={audio:!0,video:{width:{exact:1920},height:{exact:1080}}};p=await navigator.mediaDevices.getUserMedia(n);const o=document.getElementById("video");o.srcObject=p})}const y=new Worker(new URL("/moq-wasm/assets/videoEncoder-D5QFLqch.js",import.meta.url),{type:"module"}),B=new Worker(new URL("/moq-wasm/assets/audioEncoder-DvNP4UnC.js",import.meta.url),{type:"module"});async function H(e,n,o){const s=m(),t=BigInt(s["audio-object-track-alias"].value),i=Number(s["audio-publisher-priority"].value),a=0;u.ensureAudioSubgroup(a);const r=u.shouldSendAudioCodec(t),c=r?{codec:"opus",sampleRate:48e3,channels:1}:void 0;u.shouldSendAudioHeader(t,a)&&(await o.sendSubgroupStreamHeaderMessage(t,u.getAudioGroupId(),BigInt(a),i),console.log("send subgroup stream header"),u.markAudioHeaderSent(t,a)),T(t,u.getAudioGroupId(),BigInt(a),u.getAudioObjectId(),e,o,c),r&&u.markAudioCodecSent(t),u.incrementAudioObject()}function U(){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const n=m(),o=new BigUint64Array("0xff00000A".split(",").map(BigInt)),s=BigInt(n["max-subscribe-id"].value);await l.sendSetupMessage(o,s)})}function x(){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const o=m()["announce-track-namespace"].value.split("/");await l.announce(o,k)})}function G(){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(console.log("clicked sendSubgroupObjectBtn"),p==null){console.error("mediaStream is null");return}let n;try{n=w()}catch(c){console.error(c);return}y.onmessage=async c=>{const d=c.data;if(d.type!=="chunk")return;const{chunk:g,metadata:b}=d,f=m(),I=BigInt(f["video-object-track-alias"].value),M=Number(f["video-publisher-priority"].value);await A({chunk:g,metadata:b,trackAliases:[I],publisherPriority:M,client:n,transportState:u,sender:L})},B.onmessage=async c=>{const d=c.data;if(d.type!=="chunk")return;const{chunk:g,metadata:b}=d;H(g,b,n)};const[o]=p.getVideoTracks(),t=new MediaStreamTrackProcessor({track:o}).readable;y.postMessage({type:"keyframeInterval",keyframeInterval:O}),y.postMessage({type:"videoStream",videoStream:t},[t]);const[i]=p.getAudioTracks(),r=new MediaStreamTrackProcessor({track:i}).readable;B.postMessage({type:"audioStream",audioStream:r},[r])})}function N(){U(),x(),G()}function R(){l.setOnServerSetupHandler(e=>{console.log({serverSetup:e})}),l.setOnAnnounceHandler(async e=>{console.log({announceMessage:e}),await w().sendAnnounceOkMessage(e.trackNamespace)}),l.setOnSubscribeResponseHandler(e=>{console.log({announceResponseMessage:e})}),l.setOnIncomingSubscribeHandler(async({subscribe:e,isSuccess:n,code:o,respondOk:s,respondError:t})=>{console.log({subscribeMessage:e});const i=m(),a=Array.from(i["forwarding-preference"]).filter(c=>c.checked)[0].value;if(n){await s(0n,k,a);return}await t(BigInt(o),"subscribe error")})}P();R();const q=document.getElementById("connectBtn");q.addEventListener("click",async()=>{const n=m().url.value;await l.connect(n,{sendSetup:!1}),N()});
