var B=Object.defineProperty;var G=(u,i,d)=>i in u?B(u,i,{enumerable:!0,configurable:!0,writable:!0,value:d}):u[i]=d;var c=(u,i,d)=>(G(u,typeof i!="symbol"?i+"":i,d),d);(function(){"use strict";function i(t){if(t.byteLength<4)throw new Error("Payload too small to contain metadata");const o=new DataView(t.buffer,t.byteOffset,t.byteLength).getUint32(0),r=4+o;if(t.byteLength<r)throw new Error("Payload too small to contain metadata");const s=t.slice(4,4+o),n=JSON.parse(new TextDecoder().decode(s)),a=t.slice(4+o);return{metadata:n,data:a}}const d=50,b=1800,m=500,I=3;class g{constructor(e=b,o,r){c(this,"buffer",[]);c(this,"minDelayMs",d);c(this,"lastPoppedGroupId",null);c(this,"lastPoppedObjectId",null);c(this,"keyframeInterval");this.maxBufferSize=e,this.mode=o,this.keyframeInterval=typeof r=="number"?BigInt(r):r??void 0}setMinDelay(e){!Number.isFinite(e)||e<0||(this.minDelayMs=e)}push(e,o,r){if(!r.objectPayloadLength)return;const s=i(r.objectPayload);if(!s)return;const n=r;if(n.cachedChunk=s,this.mode==="video_correctly"&&this.shouldRejectOldData(e,o)){console.warn(`[JitterBuffer] Rejecting old data. Expected: (group:${this.lastPoppedGroupId}, object:${this.lastPoppedObjectId}), Got: (group:${e}, object:${o})`);return}const a=performance.now(),S={groupId:e,objectId:o,timestamp:a,object:n,isEndOfGroup:r.objectStatus===I,referenceTime:E(s.metadata)},L=this.findInsertPos(e,o);this.buffer.splice(L,0,S),this.mode==="audio"&&this.dropStaleEntries(m),this.buffer.length>this.maxBufferSize&&(console.warn("JitterBuffer is full, removing the oldest element"),this.buffer.shift())}shouldRejectOldData(e,o){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?!1:e<this.lastPoppedGroupId||e===this.lastPoppedGroupId&&o<=this.lastPoppedObjectId}pop(){const e=this.popWithMetadata();return e?e.object:null}popWithMetadata(){return this.buffer.length===0?null:this.mode==="video_normal"||this.mode==="audio"?this.popNormalMode():this.popCorrectlyMode()}popNormalMode(){const e=this.buffer[0];return performance.now()-e.timestamp<this.minDelayMs?null:(this.buffer.shift(),this.recordPopResult(e),e)}popCorrectlyMode(){const e=this.getExpectedNextEntry();let o=this.buffer.findIndex(n=>n.groupId===e.groupId&&n.objectId===e.objectId);if(o===-1&&(o=this.findResyncIndex(),o===-1)){if(this.lastPoppedGroupId===null&&this.buffer.length>0){const n=this.buffer.slice(0,5).map(a=>`(g:${a.groupId}, o:${a.objectId})`);console.warn(`[JitterBuffer] Expected first entry not found. Expected: (g:${e.groupId}, o:${e.objectId}), Buffer: [${n.join(", ")}]`)}return null}const r=this.buffer[o];return performance.now()-r.timestamp<this.minDelayMs?null:(this.buffer.splice(o,1),this.recordPopResult(r),r)}recordPopResult(e){this.lastPoppedGroupId=e.groupId,this.lastPoppedObjectId=e.objectId,e.isEndOfGroup&&(this.lastPoppedGroupId=e.groupId+1n,this.lastPoppedObjectId=-1n)}getExpectedNextEntry(){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?{groupId:0n,objectId:0n}:this.keyframeInterval!==void 0&&this.lastPoppedObjectId===this.keyframeInterval-1n?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:{groupId:this.lastPoppedGroupId,objectId:this.lastPoppedObjectId+1n}}findInsertPos(e,o){for(let r=this.buffer.length-1;r>=0;r--){const s=this.buffer[r];if(s.groupId===e&&s.objectId<o||s.groupId<e)return r+1}return 0}findResyncIndex(){return this.buffer.length===0?-1:this.lastPoppedGroupId===null?0:this.buffer.findIndex(e=>e.objectId===0n&&e.groupId>this.lastPoppedGroupId)}dropStaleEntries(e){const o=Date.now();for(;this.buffer.length>0;){const s=this.buffer[0].referenceTime;if(s===void 0||o-s<=e)break;this.buffer.shift()}}}function E(t){if(typeof t.sentAt=="number")return t.sentAt;if(typeof t.timestamp=="number")return performance.timeOrigin+t.timestamp/1e3}function y(t,e=1e3){let o=0,r=performance.now();return{addBytes(s){o+=s;const n=performance.now();if(n-r>=e){const a=o*8/1e3;t(a),o=0,r=n}}}}const j=y(t=>{self.postMessage({type:"bitrate",media:"audio",kbps:t})}),P={codec:"opus",sampleRate:48e3,numberOfChannels:1,bitrate:64e3};let f,l=null,p=null;async function T(){function t(r){self.postMessage({type:"audioData",audioData:r}),r.close()}const e={output:t,error:r=>{console.log(r.message)}},o=new AudioDecoder(e);return o.configure(P),o}const O=5,h=new g(1800,"audio");h.setMinDelay(50),setInterval(()=>{const t=h.pop();t&&_(t)},O),self.onmessage=async t=>{const e={objectId:t.data.subgroupStreamObject.objectId,objectPayloadLength:t.data.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(t.data.subgroupStreamObject.objectPayload),objectStatus:t.data.subgroupStreamObject.objectStatus};j.addBytes(e.objectPayloadLength),h.push(t.data.groupId,e.objectId,e)};async function _(t){const e=t.cachedChunk;w(e.metadata.sentAt);const o=M(e.metadata.timestamp),r=new EncodedAudioChunk({type:e.metadata.type,timestamp:o,duration:e.metadata.duration??void 0,data:e.data});(!f||f.state==="closed")&&(f=await T()),await f.decode(r)}function w(t){if(typeof t!="number")return;const e=Date.now()-t;!Number.isFinite(e)||e<0||self.postMessage({type:"latency",media:"audio",ms:e})}function M(t){return(l===null||p===null)&&(l=t,p=performance.now()*1e3),p+(t-l)}})();
