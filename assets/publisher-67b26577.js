import{_ as y,M as f}from"./moqt_client_sample-0b69746b.js";const g=900,p="secret";function B(e){const n={type:e.type,timestamp:e.timestamp,duration:e.duration??0},t=JSON.stringify(n),o=new TextEncoder().encode(t),s=o.length,a=new Uint8Array(e.byteLength);e.copyTo(a);const r=4+s+a.length,c=new Uint8Array(r);return new DataView(c.buffer).setUint32(0,s),c.set(o,4),c.set(a,4+s),c}function v(){let e=0,n=performance.now();return{addBytes(t){e+=t;const o=performance.now();if(o-n>=1e3){const s=e*8/1e6;console.log(`chunkData bitrate: ${s.toFixed(2)} Mbps`),e=0,n=o}}}}const k=v();async function I(e,n,t,o,s,a){k.addBytes(s.byteLength);const r=B(s);await a.sendSubgroupStreamObject(BigInt(e),n,t,o,void 0,r),o===BigInt(g-1)&&(await a.sendSubgroupStreamObject(BigInt(e),n,t,BigInt(g),3,Uint8Array.from([])),console.log("send Object(ObjectStatus=EndOfGroup)"))}const d=()=>document.getElementById("form");let u=null;function w(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const n={audio:!1,video:{width:{exact:1920},height:{exact:1080}}};u=await navigator.mediaDevices.getUserMedia(n);const t=document.getElementById("video");t.srcObject=u})}const i={video:{objectId:0n,groupId:-1n,subgroups:{0:{}}},audio:{objectId:0n,groupId:0n,subgroups:{0:{isSendedSubgroupHeader:!1}}}},l=new Worker(new URL("/moq-wasm/assets/videoEncoder-60f952e3.js",self.location),{type:"module"});async function S(e,n,t){const o=d(),s=o["video-object-track-alias"].value,a=o["video-publisher-priority"].value;if(e.type==="key"){i.video.groupId++,i.video.objectId=BigInt(0);const r=Object.keys(i.video.subgroups).map(BigInt);for(const c of r)await t.sendSubgroupStreamHeaderMessage(BigInt(s),i.video.groupId,c,a),console.log("send subgroup stream header")}I(s,i.video.groupId,BigInt(n==null?void 0:n.svc.temporalLayerId),i.video.objectId,e,t),i.video.objectId++}const E=new Worker(new URL("/moq-wasm/assets/audioEncoder-988b805d.js",self.location),{type:"module"});function A(e){e.onSetup(async n=>{console.log({serverSetup:n})}),e.onAnnounce(async n=>{console.log({announceMessage:n});const t=n.track_namespace;await e.sendAnnounceOkMessage(t)}),e.onAnnounceResponce(async n=>{console.log({announceResponceMessage:n})}),e.onSubscribe(async(n,t,o)=>{console.log({subscribeMessage:n});const s=d(),a=BigInt(n.subscribe_id),r=BigInt(n.track_alias);if(console.log("subscribeId",a,"trackAlias",r),t){const c=0n,m=Array.from(s["forwarding-preference"]).filter(b=>b.checked)[0].value;await e.sendSubscribeOkMessage(a,c,p,m)}else{const c="subscribe error";await e.sendSubscribeErrorMessage(n.subscribe_id,o,c)}})}function j(e){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const t=d(),o=new BigUint64Array("0xff00000A".split(",").map(BigInt)),s=BigInt(t["max-subscribe-id"].value);await e.sendSetupMessage(o,s)})}function M(e){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const o=d()["announce-track-namespace"].value.split("/");await e.sendAnnounceMessage(o,p)})}function O(e){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(console.log("clicked sendSubgroupObjectBtn"),u==null){console.error("mediaStream is null");return}l.onmessage=async a=>{const{chunk:r,metadata:c}=a.data;S(r,c,e)},E.onmessage=async a=>{a.data};const[t]=u.getVideoTracks(),s=new MediaStreamTrackProcessor({track:t}).readable;l.postMessage({type:"keyframeInterval",keyframeInterval:g}),l.postMessage({type:"videoStream",videoStream:s},[s])})}function L(e){j(e),M(e),O(e)}y().then(async()=>{w(),document.getElementById("connectBtn").addEventListener("click",async()=>{const t=d().url.value,o=new f(t);A(o),L(o),await o.start()})});
