(function(){"use strict";function w(e){if(e.byteLength<4)throw new Error("Payload too small to contain metadata");const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(0),r=4+o;if(e.byteLength<r)throw new Error("Payload too small to contain metadata");const n=e.slice(4,4+o),i=JSON.parse(new TextDecoder().decode(n)),a=e.slice(4+o);return{metadata:i,data:a}}function A(e){try{return w(e)}catch{return null}}function B(e){if(!e)return{};const t={};for(const o of e.extensions)switch(o.type){case"captureTimestamp":t.captureTimestampMicros=o.value.microsSinceUnixEpoch;break;case"videoConfig":t.videoConfig=o.value.data;break;case"videoFrameMarking":t.videoFrameMarking=o.value.data;break;case"audioLevel":t.audioLevel=o.value.level;break}return t}function L(e){let t="";for(let o=0;o<e.length;o++)t+=String.fromCharCode(e[o]);return btoa(t)}const D=250,F=5,C=9e3,S=3,j=20;class _{constructor(t=C,o="fast",r){this.maxBufferSize=t,this.mode=o,this.keyframeInterval=typeof r=="number"?BigInt(r):r??void 0}buffer=[];minDelayMs=D;lastPoppedGroupId=null;lastPoppedObjectId=null;keyframeInterval;lastPopWallTime=null;pendingEndGroupTail=new Map;bufferedAheadFrames=F;setMinDelay(t){t<0||(this.minDelayMs=t)}setBufferedAheadFrames(t){!Number.isFinite(t)||t<=0||(this.bufferedAheadFrames=Math.max(1,Math.floor(t)))}push(t,o,r,n){if(!r.objectPayloadLength)return;const i=A(r.objectPayload);if(!i){const P=r.locHeader,h=P?.extensions??[];if(!P||h.length===0)console.debug("[VideoJitterBuffer] Missing metadata and LOC header",{groupId:t,objectId:o,payloadLength:r.objectPayloadLength});else{const ee=h.some(I=>I.type==="captureTimestamp"),te=h.some(I=>I.type==="videoConfig");console.debug("[VideoJitterBuffer] Using LOC header fallback",{groupId:t,objectId:o,payloadLength:r.objectPayloadLength,locExtensionCount:h.length,hasCaptureTimestamp:ee,hasVideoConfig:te})}}const a=i??x(r,o);if(!a){console.debug("[VideoJitterBuffer] Failed to build chunk from payload",{groupId:t,objectId:o,payloadLength:r.objectPayloadLength});return}const d=r;if(d.cachedChunk=a,d.remotePTS=a.metadata.timestamp,d.localPTS=performance.timeOrigin+performance.now(),typeof a.metadata.sentAt=="number"&&n?.(Date.now()-a.metadata.sentAt),this.mode==="correctly"&&this.shouldRejectOldData(t,o)){console.warn(`[VideoJitterBuffer] Rejecting old data. Expected: (group:${this.lastPoppedGroupId}, object:${this.lastPoppedObjectId}), Got: (group:${t}, object:${o})`);return}const u={groupId:t,objectId:o,bufferInsertTimestamp:performance.now(),sentAt:a.metadata.sentAt,object:d,isEndOfGroup:r.objectStatus===S},p=this.findInsertPos(t,o);this.buffer.splice(p,0,u),this.buffer.length>this.maxBufferSize&&(console.warn("[VideoJitterBuffer] Buffer full, dropping oldest entry"),this.buffer.shift())}pop(){return this.popWithMetadata()}popWithMetadata(){return this.buffer.length===0?null:this.mode==="buffered"?this.popBufferedMode():this.mode==="fast"?this.popFastMode():this.mode==="normal"?this.popNormalMode():this.popCorrectlyMode()}popBufferedMode(){for(;;){if(this.buffer.length===0)return null;const t=this.buffer[0].groupId;if(this.buffer.some(n=>n.groupId>=t+2n)){for(;this.buffer.length>0&&this.buffer[0].groupId===t;)this.buffer.shift();continue}if(this.buffer.length<=this.bufferedAheadFrames)return null;const r=this.buffer.shift();return r?(this.recordPopResult(r,Date.now()),r):null}}popFastMode(){if(this.buffer.length===0)return null;const t=this.buffer[0].groupId;if(this.buffer.some(n=>n.groupId>t))for(;this.buffer.length>0&&this.buffer[0].groupId===t;)this.buffer.shift();const r=this.buffer.shift();return r?(this.recordPopResult(r,Date.now()),r):null}popNormalMode(){const t=this.buffer[0],o=Date.now(),r=t.sentAt;return o-r<this.minDelayMs?null:(this.buffer.shift(),this.recordPopResult(t,o),t)}popCorrectlyMode(){const t=this.getExpectedNextEntry();let o=this.buffer.findIndex(u=>u.groupId===t.groupId&&u.objectId===t.objectId);if(o===-1&&(o=this.findResyncIndex(),o===-1)){if(this.lastPoppedGroupId===null&&this.buffer.length>0){const u=this.buffer.slice(0,5).map(p=>`(g:${p.groupId}, o:${p.objectId})`);console.warn(`[VideoJitterBuffer] Expected first entry not found. Expected: (g:${t.groupId}, o:${t.objectId}), Buffer: [${u.join(", ")}]`)}return null}const r=this.buffer[o],n=Date.now(),i=r.sentAt,a=n-i,d=this.lastPopWallTime===null?Number.POSITIVE_INFINITY:n-this.lastPopWallTime;return a<this.minDelayMs||d<j?null:(this.buffer.splice(o,1),this.recordPopResult(r,n),r)}shouldRejectOldData(t,o){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?!1:t<this.lastPoppedGroupId||t===this.lastPoppedGroupId&&o<=this.lastPoppedObjectId}recordPopResult(t,o){this.lastPopWallTime=o,this.lastPoppedGroupId=t.groupId,this.lastPoppedObjectId=t.objectId,t.isEndOfGroup&&this.pendingEndGroupTail.set(t.groupId,t.objectId)}getExpectedNextEntry(){if(this.lastPoppedGroupId===null||this.lastPoppedObjectId===null)return{groupId:0n,objectId:0n};const t=this.pendingEndGroupTail.get(this.lastPoppedGroupId);return t!==void 0&&this.lastPoppedObjectId>=t?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:this.keyframeInterval!==void 0&&this.lastPoppedObjectId===this.keyframeInterval-1n?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:{groupId:this.lastPoppedGroupId,objectId:this.lastPoppedObjectId+1n}}findInsertPos(t,o){for(let r=this.buffer.length-1;r>=0;r--){const n=this.buffer[r];if(n.groupId===t&&n.objectId<o||n.groupId<t)return r+1}return 0}findResyncIndex(){return this.buffer.length===0?-1:this.lastPoppedGroupId===null?0:this.buffer.findIndex(t=>t.objectId===0n&&t.groupId>this.lastPoppedGroupId)}}function x(e,t){const o=B(e.locHeader),r=o.captureTimestampMicros,n=typeof r=="number"?Math.floor(r/1e3):Date.now();return{metadata:{type:t===0n?"key":"delta",timestamp:typeof r=="number"?r:0,duration:null,sentAt:n,descriptionBase64:o.videoConfig?L(o.videoConfig):void 0},data:e.objectPayload}}const G=300;function O(e,t=1e3){let o=0,r=performance.now();return{addBytes(n){o+=n;const i=performance.now();if(i-r>=t){const a=o*8/1e3;e(a),o=0,r=i}}}}const v=O(e=>{self.postMessage({type:"bitrate",kbps:e})}),N=BigInt(G),k={hardwareAcceleration:"prefer-hardware",scalabilityMode:"L1T1"};let f,l=!0;async function R(e){function t(n){self.postMessage({type:"frame",frame:n,width:n.displayWidth,height:n.displayHeight}),n.close()}const o={output:t,error:n=>{console.warn("[videoDecoder] decoder error",n),f=void 0,s=null}},r=new VideoDecoder(o);return r.configure(e),r}const V=33,c={maxBufferSize:9e3,mode:"fast",minDelayMs:250,bufferedAheadFrames:5};let m=M(),b={...c};function E(e){const t=e?.mode??c.mode,o=typeof e?.minDelayMs=="number"&&Number.isFinite(e.minDelayMs)&&e.minDelayMs>=0?e.minDelayMs:c.minDelayMs,r=typeof e?.maxBufferSize=="number"&&Number.isFinite(e.maxBufferSize)&&e.maxBufferSize>0?Math.floor(e.maxBufferSize):c.maxBufferSize,n=typeof e?.bufferedAheadFrames=="number"&&Number.isFinite(e.bufferedAheadFrames)&&e.bufferedAheadFrames>0?Math.floor(e.bufferedAheadFrames):c.bufferedAheadFrames;return{mode:t,minDelayMs:o,maxBufferSize:r,bufferedAheadFrames:n}}function M(e){const t=E(e),o=new _(t.maxBufferSize,t.mode,N);return o.setMinDelay(t.minDelayMs),o.setBufferedAheadFrames(t.bufferedAheadFrames),o}function z(e){b=E({...b,...e}),m=M(b)}let s=null,g=null,y=!1;setInterval(()=>{const e=m.popWithMetadata();if(e){if(e.isEndOfGroup)return;H(e.groupId,e.object)}},V);function J(e){return e.type==="config"}function U(e){return e.type==="catalog"}self.onmessage=async e=>{if(J(e.data)){z(e.data.config);return}if(U(e.data)){Z(e.data.codec);return}const t={objectId:e.data.subgroupStreamObject.objectId,objectPayloadLength:e.data.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(e.data.subgroupStreamObject.objectPayload),objectStatus:e.data.subgroupStreamObject.objectStatus,locHeader:e.data.subgroupStreamObject.locHeader};v.addBytes(t.objectPayloadLength),m.push(e.data.groupId,t.objectId,t,o=>$(o))};async function H(e,t){const o=t.cachedChunk;W(o.metadata.sentAt);const r=Q(o.metadata);if(!r)return;const n=X(r),i=new EncodedVideoChunk({type:o.metadata.type,timestamp:o.metadata.timestamp,duration:o.metadata.duration??void 0,data:o.data});if(!((!f||f.state==="closed")&&(f=await R(n),s=r,q(r,n),l=!0,o.metadata.type!=="key"))&&!(l&&o.metadata.type!=="key"))try{await f.decode(i),o.metadata.type==="key"&&(l=!1)}catch(a){if(Y(a)){l=!0,console.warn("[videoDecoder] decode requires key frame; waiting for next key frame",{groupId:e.toString(),objectId:t.objectId.toString(),chunkType:o.metadata.type});return}throw a}}function W(e){if(typeof e!="number")return;const t=Date.now()-e;t<0||K(t)}function Y(e){return e instanceof DOMException?e.name==="DataError"&&e.message.includes("A key frame is required"):!1}function $(e){e<0||self.postMessage({type:"receiveLatency",media:"video",ms:e})}function K(e){e<0||self.postMessage({type:"renderingLatency",media:"video",ms:e})}function q(e,t){const o=t.description instanceof Uint8Array?t.description.byteLength:void 0;self.postMessage({type:"decoderConfig",codec:e.codec,descriptionLength:o})}function Z(e){e&&g!==e&&(g=e,s&&s.codec!==e&&console.warn("[videoDecoder] catalog codec changed after decoder initialization; ignoring new codec",{initializedCodec:s.codec,catalogCodec:e}))}function Q(e){if(s)return s;const t=e.codec??g??void 0;return t?(y=!1,{codec:t,descriptionBase64:e.descriptionBase64,avcFormat:e.avcFormat}):(y||(y=!0,console.warn("[videoDecoder] skip decode until catalog codec is available")),null)}function X(e){if(e.codec.startsWith("avc")){const t=e.descriptionBase64?T(e.descriptionBase64):void 0;return{...k,codec:e.codec,description:t,avc:{format:e.avcFormat??"avc"}}}return{codec:e.codec,description:e.descriptionBase64?T(e.descriptionBase64):void 0}}function T(e){const t=atob(e),o=t.length,r=new Uint8Array(o);for(let n=0;n<o;n++)r[n]=t.charCodeAt(n);return r}})();
