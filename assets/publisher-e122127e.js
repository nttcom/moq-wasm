import{_ as B,M as f}from"./moqt_client_sample-31a172f3.js";const p=900,b="secret";function I(e){const n={type:e.type,timestamp:e.timestamp,duration:e.duration??0},t=JSON.stringify(n),o=new TextEncoder().encode(t),s=o.length,a=new Uint8Array(e.byteLength);e.copyTo(a);const r=4+s+a.length,c=new Uint8Array(r);return new DataView(c.buffer).setUint32(0,s),c.set(o,4),c.set(a,4+s),c}function v(){let e=0,n=performance.now();return{addBytes(t){e+=t;const o=performance.now();if(o-n>=1e3){const s=e*8/1e6;console.log(`chunkData bitrate: ${s.toFixed(2)} Mbps`),e=0,n=o}}}}const k=v();let l={groupId:BigInt(0),subgroupId:BigInt(0),objectId:BigInt(0)};async function w(e,n,t,o,s,a){k.addBytes(s.byteLength);const r=I(s);await a.sendSubgroupStreamObject(BigInt(e),n,t,o,void 0,r),n>l.groupId&&(await a.sendSubgroupStreamObject(BigInt(e),l.groupId,BigInt(0),BigInt(p),3,Uint8Array.from([])),console.log("send Object(ObjectStatus=EndOfGroup)")),l={groupId:n,subgroupId:t,objectId:o}}const d=()=>document.getElementById("form");let u=null;function S(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const n={audio:!1,video:{width:{exact:1920},height:{exact:1080}}};u=await navigator.mediaDevices.getUserMedia(n);const t=document.getElementById("video");t.srcObject=u})}const i={video:{objectId:0n,groupId:-1n,subgroups:{0:{}}},audio:{objectId:0n,groupId:0n,subgroups:{0:{isSendedSubgroupHeader:!1}}}},g=new Worker(new URL("/moq-wasm/assets/videoEncoder-abed5da4.js",self.location),{type:"module"});async function E(e,n,t){const o=d(),s=o["video-object-track-alias"].value,a=o["video-publisher-priority"].value;if(e.type==="key"){i.video.groupId++,i.video.objectId=BigInt(0);const r=Object.keys(i.video.subgroups).map(BigInt);for(const c of r)await t.sendSubgroupStreamHeaderMessage(BigInt(s),i.video.groupId,c,a),console.log("send subgroup stream header")}w(s,i.video.groupId,BigInt(n==null?void 0:n.svc.temporalLayerId),i.video.objectId,e,t),i.video.objectId++}const A=new Worker(new URL("/moq-wasm/assets/audioEncoder-988b805d.js",self.location),{type:"module"});function j(e){e.onSetup(async n=>{console.log({serverSetup:n})}),e.onAnnounce(async n=>{console.log({announceMessage:n});const t=n.track_namespace;await e.sendAnnounceOkMessage(t)}),e.onAnnounceResponce(async n=>{console.log({announceResponceMessage:n})}),e.onSubscribe(async(n,t,o)=>{console.log({subscribeMessage:n});const s=d(),a=BigInt(n.subscribe_id),r=BigInt(n.track_alias);if(console.log("subscribeId",a,"trackAlias",r),t){const c=0n,m=Array.from(s["forwarding-preference"]).filter(y=>y.checked)[0].value;await e.sendSubscribeOkMessage(a,c,b,m)}else{const c="subscribe error";await e.sendSubscribeErrorMessage(n.subscribe_id,o,c)}})}function M(e){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const t=d(),o=new BigUint64Array("0xff00000A".split(",").map(BigInt)),s=BigInt(t["max-subscribe-id"].value);await e.sendSetupMessage(o,s)})}function O(e){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const o=d()["announce-track-namespace"].value.split("/");await e.sendAnnounceMessage(o,b)})}function L(e){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(console.log("clicked sendSubgroupObjectBtn"),u==null){console.error("mediaStream is null");return}g.onmessage=async a=>{const{chunk:r,metadata:c}=a.data;E(r,c,e)},A.onmessage=async a=>{a.data};const[t]=u.getVideoTracks(),s=new MediaStreamTrackProcessor({track:t}).readable;g.postMessage({type:"keyframeInterval",keyframeInterval:p}),g.postMessage({type:"videoStream",videoStream:s},[s])})}function h(e){M(e),O(e),L(e)}B().then(async()=>{S(),document.getElementById("connectBtn").addEventListener("click",async()=>{const t=d().url.value,o=new f(t);j(o),h(o),await o.start()})});
