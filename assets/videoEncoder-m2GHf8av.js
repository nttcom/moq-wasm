(function(){"use strict";function u(e,o=1e3){let i=0,r=performance.now();return{addBytes(n){i+=n;const s=performance.now();if(s-r>=o){const v=i*8/1e3;e(v),i=0,r=s}}}}let t,d,a=null;const f=u(e=>{self.postMessage({type:"bitrate",kbps:e})});function g(e,o){f.addBytes(e.byteLength),self.postMessage({type:"chunk",chunk:e,metadata:o})}async function c(){const e={output:g,error:r=>{console.log(r.message)}},o=a??y();try{if(!(await VideoEncoder.isConfigSupported(o)).supported){self.postMessage({type:"configError",reason:"unsupported",config:o});return}}catch{self.postMessage({type:"configError",reason:"unsupported",config:o});return}const i=new VideoEncoder(e);try{i.configure(o)}catch(r){console.error("[videoEncoder] configure failed",r),self.postMessage({type:"configError",reason:"unsupported",config:o});return}return console.info("[videoEncoder] initialized",o),i}async function p(e){let o=0;if(console.log("initializeVideoEncoder"),t=await c(),!t)return;const i=e.getReader();for(;;){const r=await i.read();if(r.done)break;const n=r.value;if(t.encodeQueueSize>10){console.error("videoEncoder.encodeQueueSize > 10",t.encodeQueueSize),n.close();continue}(!t||t.state==="closed")&&(console.log("Re-initialize video encoder"),t=await c(),o=0);const s=o%d==0;t.encode(n,{keyFrame:s}),o++,n.close()}}self.onmessage=async e=>{if(console.debug("videoEncoder worker received message",e.data),e.data.type==="keyframeInterval")d=e.data.keyframeInterval;else if(e.data.type==="encoderConfig")a=l(e.data.config),t&&t.state!=="closed"&&(t.configure(a),console.info("[videoEncoder] reconfigured",a));else if(e.data.type==="videoStream"){const o=e.data.videoStream;if(!o){console.error("MediaStreamTrack が渡されていません");return}await p(o)}};function l(e){return{codec:e.codec,avc:e.codec.startsWith("avc")?{format:"annexb"}:void 0,width:e.width,height:e.height,bitrate:e.bitrate,framerate:30,scalabilityMode:"L1T1",latencyMode:"realtime"}}function y(){return l({codec:"avc1.640028",width:1280,height:720,bitrate:1e6})}})();
