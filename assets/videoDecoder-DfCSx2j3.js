(function(){"use strict";function B(e){if(e.byteLength<4)throw new Error("Payload too small to contain metadata");const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(0),n=4+o;if(e.byteLength<n)throw new Error("Payload too small to contain metadata");const r=e.slice(4,4+o),i=JSON.parse(new TextDecoder().decode(r)),s=e.slice(4+o);return{metadata:i,data:s}}const D=250,G=5,F=9e3,_=3,L=20;class S{constructor(t=F,o="fast",n){this.maxBufferSize=t,this.mode=o,this.keyframeInterval=typeof n=="number"?BigInt(n):n??void 0}buffer=[];minDelayMs=D;lastPoppedGroupId=null;lastPoppedObjectId=null;keyframeInterval;lastPopWallTime=null;pendingEndGroupTail=new Map;bufferedAheadFrames=G;setMinDelay(t){t<0||(this.minDelayMs=t)}setBufferedAheadFrames(t){!Number.isFinite(t)||t<=0||(this.bufferedAheadFrames=Math.max(1,Math.floor(t)))}push(t,o,n,r){if(!n.objectPayloadLength)return;const i=B(n.objectPayload);if(!i)return;const s=n;if(s.cachedChunk=i,s.remotePTS=i.metadata.timestamp,s.localPTS=performance.timeOrigin+performance.now(),typeof i.metadata.sentAt=="number"&&r?.(Date.now()-i.metadata.sentAt),this.mode==="correctly"&&this.shouldRejectOldData(t,o)){console.warn(`[VideoJitterBuffer] Rejecting old data. Expected: (group:${this.lastPoppedGroupId}, object:${this.lastPoppedObjectId}), Got: (group:${t}, object:${o})`);return}const m={groupId:t,objectId:o,bufferInsertTimestamp:performance.now(),sentAt:i.metadata.sentAt,object:s,isEndOfGroup:n.objectStatus===_},c=this.findInsertPos(t,o);this.buffer.splice(c,0,m),this.buffer.length>this.maxBufferSize&&(console.warn("[VideoJitterBuffer] Buffer full, dropping oldest entry"),this.buffer.shift())}pop(){return this.popWithMetadata()}popWithMetadata(){return this.buffer.length===0?null:this.mode==="buffered"?this.popBufferedMode():this.mode==="fast"?this.popFastMode():this.mode==="normal"?this.popNormalMode():this.popCorrectlyMode()}popBufferedMode(){for(;;){if(this.buffer.length===0)return null;const t=this.buffer[0].groupId;if(this.buffer.some(r=>r.groupId>=t+2n)){for(;this.buffer.length>0&&this.buffer[0].groupId===t;)this.buffer.shift();continue}if(this.buffer.length<=this.bufferedAheadFrames)return null;const n=this.buffer.shift();return n?(this.recordPopResult(n,Date.now()),n):null}}popFastMode(){if(this.buffer.length===0)return null;const t=this.buffer[0].groupId;if(this.buffer.some(r=>r.groupId>t))for(;this.buffer.length>0&&this.buffer[0].groupId===t;)this.buffer.shift();const n=this.buffer.shift();return n?(this.recordPopResult(n,Date.now()),n):null}popNormalMode(){const t=this.buffer[0],o=Date.now(),n=t.sentAt;return o-n<this.minDelayMs?null:(this.buffer.shift(),this.recordPopResult(t,o),t)}popCorrectlyMode(){const t=this.getExpectedNextEntry();let o=this.buffer.findIndex(c=>c.groupId===t.groupId&&c.objectId===t.objectId);if(o===-1&&(o=this.findResyncIndex(),o===-1)){if(this.lastPoppedGroupId===null&&this.buffer.length>0){const c=this.buffer.slice(0,5).map(A=>`(g:${A.groupId}, o:${A.objectId})`);console.warn(`[VideoJitterBuffer] Expected first entry not found. Expected: (g:${t.groupId}, o:${t.objectId}), Buffer: [${c.join(", ")}]`)}return null}const n=this.buffer[o],r=Date.now(),i=n.sentAt,s=r-i,m=this.lastPopWallTime===null?Number.POSITIVE_INFINITY:r-this.lastPopWallTime;return s<this.minDelayMs||m<L?null:(this.buffer.splice(o,1),this.recordPopResult(n,r),n)}shouldRejectOldData(t,o){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?!1:t<this.lastPoppedGroupId||t===this.lastPoppedGroupId&&o<=this.lastPoppedObjectId}recordPopResult(t,o){this.lastPopWallTime=o,this.lastPoppedGroupId=t.groupId,this.lastPoppedObjectId=t.objectId,t.isEndOfGroup&&this.pendingEndGroupTail.set(t.groupId,t.objectId)}getExpectedNextEntry(){if(this.lastPoppedGroupId===null||this.lastPoppedObjectId===null)return{groupId:0n,objectId:0n};const t=this.pendingEndGroupTail.get(this.lastPoppedGroupId);return t!==void 0&&this.lastPoppedObjectId>=t?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:this.keyframeInterval!==void 0&&this.lastPoppedObjectId===this.keyframeInterval-1n?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:{groupId:this.lastPoppedGroupId,objectId:this.lastPoppedObjectId+1n}}findInsertPos(t,o){for(let n=this.buffer.length-1;n>=0;n--){const r=this.buffer[n];if(r.groupId===t&&r.objectId<o||r.groupId<t)return n+1}return 0}findResyncIndex(){return this.buffer.length===0?-1:this.lastPoppedGroupId===null?0:this.buffer.findIndex(t=>t.objectId===0n&&t.groupId>this.lastPoppedGroupId)}}const N=300;function x(e,t=1e3){let o=0,n=performance.now();return{addBytes(r){o+=r;const i=performance.now();if(i-n>=t){const s=o*8/1e3;e(s),o=0,n=i}}}}const R=x(e=>{self.postMessage({type:"bitrate",kbps:e})}),g=BigInt(N),O={codec:"avc1.640028",avc:{format:"annexb"},hardwareAcceleration:"prefer-hardware",width:1920,height:1080,scalabilityMode:"L1T1"};let f;async function I(e){function t(r){self.postMessage({type:"frame",frame:r,width:r.displayWidth,height:r.displayHeight}),r.close()}const o={output:t,error:r=>{console.log(r.message),f=void 0}},n=new VideoDecoder(o);return n.configure(e),console.info("[videoDecoder] (re)initializing decoder with config:",e),n}const C=33,l={maxBufferSize:9e3,mode:"fast",minDelayMs:250,bufferedAheadFrames:5};let p=E(),h={...l};function y(e){const t=e?.mode??l.mode,o=typeof e?.minDelayMs=="number"&&Number.isFinite(e.minDelayMs)&&e.minDelayMs>=0?e.minDelayMs:l.minDelayMs,n=typeof e?.maxBufferSize=="number"&&Number.isFinite(e.maxBufferSize)&&e.maxBufferSize>0?Math.floor(e.maxBufferSize):l.maxBufferSize,r=typeof e?.bufferedAheadFrames=="number"&&Number.isFinite(e.bufferedAheadFrames)&&e.bufferedAheadFrames>0?Math.floor(e.bufferedAheadFrames):l.bufferedAheadFrames;return{mode:t,minDelayMs:o,maxBufferSize:n,bufferedAheadFrames:r}}function E(e){const t=y(e),o=new S(t.maxBufferSize,t.mode,g);return o.setMinDelay(t.minDelayMs),o.setBufferedAheadFrames(t.bufferedAheadFrames),o}function V(e){h=y({...h,...e}),p=E(h)}let a=null,b=!1,d=null,u=null;function $(e,t){if(!a){(e!==0n||t!==0n)&&console.warn(`[Video] First frame must be groupId=0, objectId=0 (keyframe). Got: groupId=${e}, objectId=${t}`);return}if(e!==a.groupId){if(!b){const o=g-1n;a.objectId!==o&&console.debug(`[Video] Group ended with unexpected objectId. Expected: ${o}, Got: ${a.objectId}, Group: ${a.groupId} -> ${e}`)}t!==0n&&console.warn(`[Video] New group should start with objectId 0. Got: ${t}, GroupId: ${e}`);return}t!==a.objectId+1n&&console.warn(`[Video] Non-sequential objectId detected. Expected: ${a.objectId+1n}, Got: ${t}, Gap: ${t-a.objectId-1n}`)}function z(e,t){b=!1,a={groupId:e,objectId:t}}function k(){b=!0}setInterval(()=>{const e=p.popWithMetadata();if(e){if(e.isEndOfGroup){k();return}U(e.groupId,e.object)}},C);function v(e){return e.type==="config"}self.onmessage=async e=>{if(v(e.data)){V(e.data.config);return}const t={objectId:e.data.subgroupStreamObject.objectId,objectPayloadLength:e.data.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(e.data.subgroupStreamObject.objectPayload),objectStatus:e.data.subgroupStreamObject.objectStatus};R.addBytes(t.objectPayloadLength),p.push(e.data.groupId,t.objectId,t,o=>Y(o))};async function U(e,t){$(e,t.objectId),z(e,t.objectId);const o=t.cachedChunk;J(o.metadata.sentAt);const n=H(o.metadata);if(!n)return;const r=T(n),i=P(n);if(i&&o.metadata.type!=="key"){u=n;return}u&&o.metadata.type==="key"&&(P(u)&&await w(T(u),u),u=null);const s=new EncodedVideoChunk({type:o.metadata.type,timestamp:o.metadata.timestamp,duration:o.metadata.duration??void 0,data:o.data});(!f||f.state==="closed")&&(f=await I(r),d=n,M(n,r),o.metadata.type!=="key")||i&&(await w(r,n),o.metadata.type!=="key")||await f.decode(s)}async function w(e,t){try{f?.close()}catch(o){console.warn("[videoDecoder] failed to close before reconfigure",o)}f=await I(e),console.log("[videoDecoder] reinitialize with config:",e),d=t,M(t,e)}function J(e){if(typeof e!="number")return;const t=Date.now()-e;t<0||W(t)}function Y(e){e<0||self.postMessage({type:"receiveLatency",media:"video",ms:e})}function W(e){e<0||self.postMessage({type:"renderingLatency",media:"video",ms:e})}function M(e,t){const o=t.description instanceof Uint8Array?t.description.byteLength:void 0;self.postMessage({type:"decoderConfig",codec:e.codec,descriptionLength:o})}function H(e){if(!(e.codec||e.descriptionBase64)&&!d)return null;const o=e.codec??d?.codec,n=e.descriptionBase64??d?.descriptionBase64;return o?{codec:o,descriptionBase64:n}:null}function T(e){if(e.codec.startsWith("avc")){const t=e.descriptionBase64?j(e.descriptionBase64):void 0;return{...O,codec:e.codec,description:t}}return{codec:e.codec,description:e.descriptionBase64?j(e.descriptionBase64):void 0}}function P(e){return d?d.codec!==e.codec||d.descriptionBase64!==e.descriptionBase64:!0}function j(e){const t=atob(e),o=t.length,n=new Uint8Array(o);for(let r=0;r<o;r++)n[r]=t.charCodeAt(r);return n}})();
