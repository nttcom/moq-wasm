import{M as A}from"./moqtClient-Clv5CNT1.js";/* empty css              */import{s as O,a as T,K as L,M as C}from"./constants-BxWFIYxl.js";import{M as h,a as N,b as j,c as E}from"./catalog-BYlufEzj.js";const S="secret";function P(e,t=1e3){let n=0,a=performance.now();return{addBytes(o){n+=o;const i=performance.now();if(i-a>=t){const r=n*8/1e6;console.log(`${e}: ${r.toFixed(2)} Mbps`),n=0,a=i}}}}const U=P("chunkData bitrate"),v=new Map;async function D(e,t,n,a,o,i,r){console.debug("[MediaPublisher] sendVideoObjectMessage",{trackAlias:e.toString(),groupId:t.toString(),subgroupId:n.toString(),objectId:a.toString(),byteLength:o.byteLength});const s=v.get(e);if(s&&s.groupId!==t){const d=s.lastObjectId+1n;await i.sendSubgroupStreamObject(e,s.groupId,0n,d,3,new Uint8Array(0),void 0),console.log(`[MediaPublisher] Sent EndOfGroup trackAlias=${e} groupId=${s.groupId} subgroupId=0 objectId=${d}`)}U.addBytes(o.byteLength);const c=new Uint8Array(o.byteLength);o.copyTo(c),await i.sendSubgroupStreamObject(BigInt(e),t,n,a,void 0,c,r),v.set(e,{groupId:t,lastObjectId:a})}const m=()=>document.getElementById("form");let k=null;const l=new A,M=new C,b=new Set;function B(){const e=l.getRawClient();if(!e)throw new Error("MOQT client not connected");return e}function H(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const t={audio:!0,video:{width:{exact:1920},height:{exact:1080}}};k=await navigator.mediaDevices.getUserMedia(t);const n=document.getElementById("video");n.srcObject=k})}const w=new Worker(new URL("/moq-wasm/assets/videoEncoder-DDdRjd8v.js",import.meta.url),{type:"module"}),I=h.map(e=>({bitrate:e.bitrate,trackName:e.trackName,worker:new Worker(new URL("/moq-wasm/assets/audioEncoder-DvNP4UnC.js",import.meta.url),{type:"module"})}));function y(e){return e.split("/").map(t=>t.trim()).filter(t=>t.length>0)}function R(e){return Array.from(e["forwarding-preference"]).filter(t=>t.checked)[0].value}function V(e){return e===N}function _(e){return E.some(t=>t.trackName===e)}function q(e){return h.some(t=>t.trackName===e)}function x(e,t){const n=new Set;for(const a of E)for(const o of e.getTrackSubscribers(t,a.trackName))n.add(o.toString());return Array.from(n,a=>BigInt(a))}function F(e,t,n){return Array.from(e.getTrackSubscribers(t,n),a=>BigInt(a))}async function G(e,t,n){const a=t.toString();if(b.has(a))return;const o=new TextEncoder().encode(j(n));await e.sendSubgroupStreamHeaderMessage(t,0n,0n,0),await e.sendSubgroupStreamObject(t,0n,0n,0n,void 0,o,void 0),b.add(a),console.info("[MediaPublisher] sent catalog",{trackAlias:a,trackNamespace:n})}function $(){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const t=m(),n=new BigUint64Array("0xff00000A".split(",").map(BigInt)),a=BigInt(t["max-subscribe-id"].value);await l.sendSetupMessage(n,a)})}function K(){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const t=m(),n=y(t["announce-track-namespace"].value);await l.announce(n,S)})}function W(){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(console.log("clicked sendSubgroupObjectBtn"),k==null){console.error("mediaStream is null");return}let t;try{t=B()}catch(r){console.error(r);return}w.onmessage=async r=>{const s=r.data;if(s.type!=="chunk")return;const{chunk:c,metadata:d}=s;console.debug("[MediaPublisher] video chunk",{byteLength:c.byteLength,type:c.type,timestamp:c.timestamp});const u=m(),g=y(u["announce-track-namespace"].value),p=Number(u["video-publisher-priority"].value),f=x(t,g);f.length&&await O({chunk:c,metadata:d,trackAliases:f,publisherPriority:p,client:t,transportState:M,sender:D})};for(const r of I)r.worker.onmessage=async s=>{const c=s.data;if(c.type!=="chunk")return;const{chunk:d,metadata:u}=c,g=m(),p=y(g["announce-track-namespace"].value),f=F(t,p,r.trackName);f.length&&await T({chunk:d,metadata:u,trackAliases:f,client:t,transportState:M})};const[n]=k.getVideoTracks(),o=new MediaStreamTrackProcessor({track:n}).readable;w.postMessage({type:"keyframeInterval",keyframeInterval:L}),w.postMessage({type:"videoStream",videoStream:o},[o]);const[i]=k.getAudioTracks();I.forEach((r,s)=>{r.worker.postMessage({type:"config",config:{bitrate:r.bitrate}});const c=s===0?i:i.clone(),u=new MediaStreamTrackProcessor({track:c}).readable;r.worker.postMessage({type:"audioStream",audioStream:u},[u])})})}function J(){$(),K(),W()}function Q(){l.setOnServerSetupHandler(e=>{console.log({serverSetup:e})}),l.setOnAnnounceHandler(async e=>{console.log({announceMessage:e}),await B().sendAnnounceOkMessage(e.trackNamespace)}),l.setOnSubscribeResponseHandler(e=>{console.log({announceResponseMessage:e})}),l.setOnIncomingSubscribeHandler(async({subscribe:e,isSuccess:t,code:n,respondOk:a,respondError:o})=>{console.log({subscribeMessage:e});const i=m(),r=R(i),s=y(i["announce-track-namespace"].value),c=e.trackNamespace??[],d=e.trackName??"",u=c.join("/")===s.join("/");if(t){if(!u){await o(404n,"unknown namespace");return}if(V(d)){await a(0n,S,"subgroup");const p=B();await G(p,BigInt(e.trackAlias),s);return}if(_(d)||q(d)){await a(0n,S,r);return}await o(404n,"unknown track");return}const g=`subscribe error: code=${n}`;await o(BigInt(n),g)})}function Y(){document.getElementById("closeBtn").addEventListener("click",async()=>{await l.disconnect(),b.clear()})}H();Q();Y();const z=document.getElementById("connectBtn");z.addEventListener("click",async()=>{const t=m().url.value;await l.connect(t,{sendSetup:!1}),b.clear(),J()});
