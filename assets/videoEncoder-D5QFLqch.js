(function(){"use strict";function u(e,o=1e3){let i=0,t=performance.now();return{addBytes(n){i+=n;const s=performance.now();if(s-t>=o){const v=i*8/1e3;e(v),i=0,t=s}}}}let r,d,c=null,a=null;const p=u(e=>{self.postMessage({type:"bitrate",kbps:e})});function g(e,o){p.addBytes(e.byteLength),a===null&&(a=e.timestamp,console.info("[videoEncoder] Set timestamp offset:",a));const i=e.timestamp-a,t=new ArrayBuffer(e.byteLength);e.copyTo(t);const n=new EncodedVideoChunk({type:e.type,timestamp:i,duration:e.duration??void 0,data:t});self.postMessage({type:"chunk",chunk:n,metadata:o})}async function l(){const e={output:g,error:t=>{console.log(t.message)}},o=c??y();try{if(!(await VideoEncoder.isConfigSupported(o)).supported){self.postMessage({type:"configError",reason:"unsupported",config:o});return}}catch{self.postMessage({type:"configError",reason:"unsupported",config:o});return}const i=new VideoEncoder(e);try{i.configure(o)}catch(t){console.error("[videoEncoder] configure failed",t),self.postMessage({type:"configError",reason:"unsupported",config:o});return}return console.info("[videoEncoder] initialized",o),i}async function m(e){let o=0;if(a=null,console.log("initializeVideoEncoder"),r=await l(),!r)return;const i=e.getReader();for(;;){const t=await i.read();if(t.done)break;const n=t.value;if((!r||r.state==="closed")&&(console.log("Re-initialize video encoder"),r=await l(),o=0,!r)){console.error("Failed to initialize video encoder, dropping frame"),n.close();continue}if(r.encodeQueueSize>10){console.error("videoEncoder.encodeQueueSize > 10",r.encodeQueueSize),n.close();continue}const s=o%d==0;r.encode(n,{keyFrame:s}),o++,n.close()}}self.onmessage=async e=>{if(console.debug("videoEncoder worker received message",e.data),e.data.type==="keyframeInterval")d=e.data.keyframeInterval;else if(e.data.type==="encoderConfig"){const o=f(e.data.config);if(c=o,r&&r.state!=="closed")try{r.configure(o),console.info("[videoEncoder] reconfigured",o)}catch(i){console.error("[videoEncoder] reconfigure failed",i),self.postMessage({type:"configError",reason:"reconfigure_failed",config:o})}}else if(e.data.type==="videoStream"){const o=e.data.videoStream;if(!o){console.error("MediaStreamTrack が渡されていません");return}await m(o)}};function f(e){return{codec:e.codec,avc:e.codec.startsWith("avc")?{format:"annexb"}:void 0,width:e.width,height:e.height,bitrate:e.bitrate,framerate:30,scalabilityMode:"L1T1",latencyMode:"realtime"}}function y(){return f({codec:"avc1.640028",width:1280,height:720,bitrate:1e6})}})();
