import{M}from"./moqtClient-9749a8f2.js";import{s as h,K as O,M as E}from"./constants-cd6b919a.js";const w="secret";function j(e,t=1e3){let n=0,a=performance.now();return{addBytes(o){n+=o;const r=performance.now();if(r-a>=t){const s=n*8/1e6;console.log(`${e}: ${s.toFixed(2)} Mbps`),n=0,a=r}}}}const L=j("chunkData bitrate"),B=new Map;function k(e){const t={type:e.type,timestamp:e.timestamp,duration:e.duration??0},n=JSON.stringify(t),a=new TextEncoder().encode(n),o=a.length,r=new Uint8Array(e.byteLength);e.copyTo(r);const s=4+o+r.length,i=new Uint8Array(s);return new DataView(i.buffer).setUint32(0,o),i.set(a,4),i.set(r,4+o),i}async function T(e,t,n,a,o,r){const s=B.get(e);if(s&&s.groupId!==t){const c=s.lastObjectId+1n;await r.sendSubgroupStreamObject(e,s.groupId,0n,c,3,new Uint8Array(0)),console.log(`[MediaPublisher] Sent EndOfGroup trackAlias=${e} groupId=${s.groupId} subgroupId=0 objectId=${c}`)}L.addBytes(o.byteLength);const i=k(o);await r.sendSubgroupStreamObject(BigInt(e),t,n,a,void 0,i),B.set(e,{groupId:t,lastObjectId:a})}async function U(e,t,n,a,o,r){const s=k(o);await r.sendSubgroupStreamObject(BigInt(e),t,n,a,void 0,s)}const l=()=>document.getElementById("form");let p=null;const u=new M,d=new E;function v(){const e=u.getRawClient();if(!e)throw new Error("MOQT client not connected");return e}function C(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const t={audio:!0,video:{width:{exact:1920},height:{exact:1080}}};p=await navigator.mediaDevices.getUserMedia(t);const n=document.getElementById("video");n.srcObject=p})}const y=new Worker(new URL("/moq-wasm/assets/videoEncoder-ee64133c.js",self.location),{type:"module"}),S=new Worker(new URL("/moq-wasm/assets/audioEncoder-fabc5171.js",self.location),{type:"module"});async function H(e,t,n){const a=l(),o=BigInt(a["audio-object-track-alias"].value),r=Number(a["audio-publisher-priority"].value),s=0;d.ensureAudioSubgroup(s),d.shouldSendAudioHeader(o,s)&&(await n.sendSubgroupStreamHeaderMessage(o,d.getAudioGroupId(),BigInt(s),r),console.log("send subgroup stream header"),d.markAudioHeaderSent(o,s)),U(o,d.getAudioGroupId(),BigInt(s),d.getAudioObjectId(),e,n),d.incrementAudioObject()}function P(){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const t=l(),n=new BigUint64Array("0xff00000A".split(",").map(BigInt)),a=BigInt(t["max-subscribe-id"].value);await u.sendSetupMessage(n,a)})}function x(){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const n=l()["announce-track-namespace"].value.split("/");await u.announce(n,w)})}function G(){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(console.log("clicked sendSubgroupObjectBtn"),p==null){console.error("mediaStream is null");return}let t;try{t=v()}catch(c){console.error(c);return}y.onmessage=async c=>{const m=c.data;if(m.type!=="chunk")return;const{chunk:g,metadata:b}=m,f=l(),I=BigInt(f["video-object-track-alias"].value),A=Number(f["video-publisher-priority"].value);await h({chunk:g,metadata:b,trackAliases:[I],publisherPriority:A,client:t,transportState:d,sender:T})},S.onmessage=async c=>{const m=c.data;if(m.type!=="chunk")return;const{chunk:g,metadata:b}=m;H(g,b,t)};const[n]=p.getVideoTracks(),o=new MediaStreamTrackProcessor({track:n}).readable;y.postMessage({type:"keyframeInterval",keyframeInterval:O}),y.postMessage({type:"videoStream",videoStream:o},[o]);const[r]=p.getAudioTracks(),i=new MediaStreamTrackProcessor({track:r}).readable;S.postMessage({type:"audioStream",audioStream:i},[i])})}function N(){P(),x(),G()}function R(){u.setOnServerSetupHandler(e=>{console.log({serverSetup:e})}),u.setOnAnnounceHandler(async e=>{console.log({announceMessage:e}),await v().sendAnnounceOkMessage(e.trackNamespace)}),u.setOnSubscribeResponseHandler(e=>{console.log({announceResponseMessage:e})}),u.setOnIncomingSubscribeHandler(async({subscribe:e,isSuccess:t,code:n,respondOk:a,respondError:o})=>{console.log({subscribeMessage:e});const r=l(),s=Array.from(r["forwarding-preference"]).filter(c=>c.checked)[0].value;if(t){await a(0n,w,s);return}const i="subscribe error";await o(BigInt(n),i)})}C();R();const V=document.getElementById("connectBtn");V.addEventListener("click",async()=>{const t=l().url.value;await u.connect(t,{sendSetup:!1}),N()});
