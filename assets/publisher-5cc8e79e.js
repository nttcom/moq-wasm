import{_ as O,M}from"./moqt_client_sample-4b7b2ba2.js";const B=300,E="secret";async function L(o,n,r,c,s,e,i){var b,y,f,v,k,A,h,w,j;const t=new Uint8Array(s.byteLength);s.copyTo(t);const g={type:s.type,timestamp:s.timestamp,duration:s.duration,byteLength:s.byteLength,data:Array.from(t),decoderConfig:{codec:(b=e==null?void 0:e.decoderConfig)==null?void 0:b.codec,codedHeight:(y=e==null?void 0:e.decoderConfig)==null?void 0:y.codedHeight,codedWidth:(f=e==null?void 0:e.decoderConfig)==null?void 0:f.codedWidth,colorSpace:(v=e==null?void 0:e.decoderConfig)==null?void 0:v.colorSpace,description:(k=e==null?void 0:e.decoderConfig)==null?void 0:k.description,displayAspectHeight:(A=e==null?void 0:e.decoderConfig)==null?void 0:A.displayAspectHeight,displayAspectWidth:(h=e==null?void 0:e.decoderConfig)==null?void 0:h.displayAspectWidth,hardwareAcceleration:(w=e==null?void 0:e.decoderConfig)==null?void 0:w.hardwareAcceleration,optimizeForLatency:(j=e==null?void 0:e.decoderConfig)==null?void 0:j.optimizeForLatency},temporalLayer:e==null?void 0:e.temporalLayerId},u=new TextEncoder,p=JSON.stringify({chunk:g}),S=u.encode(p);await i.sendSubgroupStreamObject(BigInt(o),n,r,c,void 0,S),c===BigInt(B-1)&&(await i.sendSubgroupStreamObject(BigInt(o),n,r,BigInt(B),3,Uint8Array.from([])),console.log("send Object(ObjectStatus=EndOfGroup)"))}async function T(o,n,r,c,s,e,i){var b,y,f;const t=new Uint8Array(s.byteLength);s.copyTo(t);const g={type:s.type,timestamp:s.timestamp,duration:s.duration,byteLength:s.byteLength,data:Array.from(t),decoderConfig:{codec:(b=e==null?void 0:e.decoderConfig)==null?void 0:b.codec,numberOfChannels:(y=e==null?void 0:e.decoderConfig)==null?void 0:y.numberOfChannels,sampleRate:(f=e==null?void 0:e.decoderConfig)==null?void 0:f.sampleRate}},u=new TextEncoder,p=JSON.stringify({chunk:g}),S=u.encode(p);await i.sendSubgroupStreamObject(BigInt(o),n,r,c,void 0,S)}const l=()=>document.getElementById("form");let a=null;function H(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const n={audio:!0,video:{width:1920,height:1080}};a=await navigator.mediaDevices.getUserMedia(n);const r=document.getElementById("video");r.srcObject=a})}const d={video:{objectId:0n,groupId:-1n,subgroups:{0:{},1:{},2:{}}},audio:{objectId:0n,groupId:0n,subgroups:{0:{isSendedSubgroupHeader:!1}}}},I=new Worker("videoEncoder.ts");async function m(o,n,r){const c=l(),s=c["video-object-track-alias"].value,e=c["video-publisher-priority"].value;if(o.type==="key"){d.video.groupId++,d.video.objectId=BigInt(0);const i=Object.keys(d.video.subgroups).map(BigInt);for(const t of i)await r.sendSubgroupStreamHeaderMessage(BigInt(s),d.video.groupId,t,e),console.log("send subgroup stream header")}L(s,d.video.groupId,BigInt(n==null?void 0:n.svc.temporalLayerId),d.video.objectId,o,n,r),d.video.objectId++}const C=new Worker("audioEncoder.ts");async function P(o,n,r){const c=l(),s=c["audio-object-track-alias"].value,e=c["audio-publisher-priority"].value,i=0;d.audio.subgroups[i].isSendedSubgroupHeader||(await r.sendSubgroupStreamHeaderMessage(BigInt(s),d.audio.groupId,BigInt(i),e),console.log("send subgroup stream header"),d.audio.subgroups[i].isSendedSubgroupHeader=!0),T(s,d.audio.groupId,BigInt(i),d.audio.objectId,o,n,r),d.audio.objectId++}function U(o){o.onSetup(async n=>{console.log({serverSetup:n})}),o.onAnnounce(async n=>{console.log({announceMessage:n});const r=n.track_namespace;await o.sendAnnounceOkMessage(r)}),o.onAnnounceResponce(async n=>{console.log({announceResponceMessage:n})}),o.onSubscribe(async(n,r,c)=>{console.log({subscribeMessage:n});const s=l(),e=BigInt(n.subscribe_id),i=BigInt(n.track_alias);if(console.log("subscribeId",e,"trackAlias",i),r){const t=0n,g=Array.from(s["forwarding-preference"]).filter(u=>u.checked)[0].value;await o.sendSubscribeOkMessage(e,t,E,g)}else{const t="subscribe error";await o.sendSubscribeErrorMessage(n.subscribe_id,c,t)}})}function _(o){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const r=l(),c=new BigUint64Array("0xff00000A".split(",").map(BigInt)),s=BigInt(r["max-subscribe-id"].value);await o.sendSetupMessage(c,s)})}function W(o){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const c=l()["announce-track-namespace"].value.split("/");await o.sendAnnounceMessage(c,E)})}function x(o){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(a==null){console.error("mediaStream is null");return}I.onmessage=async g=>{const{chunk:u,metadata:p}=g.data;console.log(u,p),m(u,p,o)},C.onmessage=async g=>{const{chunk:u,metadata:p}=g.data;P(u,p,o)};const[r]=a.getVideoTracks(),s=new MediaStreamTrackProcessor({track:r}).readable;I.postMessage({type:"keyframeInterval",keyframeInterval:B}),I.postMessage({type:"videoStream",videoStream:s},[s]);const[e]=a.getAudioTracks(),t=new MediaStreamTrackProcessor({track:e}).readable;C.postMessage({type:"audioStream",audioStream:t},[t])})}function N(o){_(o),W(o),x(o)}O().then(async()=>{H(),document.getElementById("connectBtn").addEventListener("click",async()=>{const r=l().url.value,c=new M(r);U(c),N(c),await c.start()})});
