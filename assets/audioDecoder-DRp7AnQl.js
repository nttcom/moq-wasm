(function(){"use strict";function p(e){if(e.byteLength<4)throw new Error("Payload too small to contain metadata");const n=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(0),o=4+n;if(e.byteLength<o)throw new Error("Payload too small to contain metadata");const s=e.slice(4,4+n),r=JSON.parse(new TextDecoder().decode(s)),i=e.slice(4+n);return{metadata:r,data:i}}const m=1800;class h{constructor(t=m,n="latest"){this.maxBufferSize=t,this.mode=n}buffer=[];hasPoppedOnce=!1;mode="latest";setMode(t){this.mode=t}push(t,n,o,s){if(!o.objectPayloadLength)return;const r=p(o.objectPayload);if(!r)return;const i=o;i.cachedChunk=r,i.remotePTS=r.metadata.timestamp,i.localPTS=performance.timeOrigin+performance.now(),s?.(Date.now()-r.metadata.sentAt);const f=performance.now(),C={groupId:t,objectId:n,bufferInsertTimestamp:f,sentAt:r.metadata.sentAt,object:i},P=this.findInsertPos(t,n);this.buffer.splice(P,0,C),this.buffer.length>this.maxBufferSize&&(console.warn("[AudioJitterBuffer] Buffer full, dropping oldest entry"),this.buffer.shift())}pop(){return this.popWithMetadata()}popWithMetadata(){if(console.log("[AudioJitterBuffer] popWithMetadata called, current mode:",this.mode),this.buffer.length===0)return null;if(this.mode==="latest"){const n=this.buffer.pop();return this.buffer.length=0,n??null}if(!this.hasPoppedOnce){const n=this.buffer.pop();return this.hasPoppedOnce=!0,n??null}const t=this.buffer[0];return this.buffer.shift(),t}findInsertPos(t,n){for(let o=this.buffer.length-1;o>=0;o--){const s=this.buffer[o];if(s.groupId===t&&s.objectId<n||s.groupId<t)return o+1}return 0}}function g(e,t=1e3){let n=0,o=performance.now();return{addBytes(s){n+=s;const r=performance.now();if(r-o>=t){const i=n*8/1e3;e(i),n=0,o=r}}}}const b=g(e=>{self.postMessage({type:"bitrate",media:"audio",kbps:e})}),d={codec:"opus",sampleRate:48e3,numberOfChannels:1};let a,y=null,l=null,c=null;async function T(e,t){function n(r){self.postMessage({type:"audioData",audioData:r}),r.close()}const o={output:n,error:r=>{console.log(r.message)}},s=new AudioDecoder(o);return s.configure(e),l=t,console.info("[audioDecoder] (re)initializing decoder with config:",e),console.info("[audioDecoder] desiredSignature:",t),s}const E=5,u=new h(1800,"latest");setInterval(()=>{const e=u.pop();if(!e)return;console.debug(e);const t=e?.object;t&&A(t)},E),self.onmessage=async e=>{if(e.data.type==="config"){const o=e.data.config;(o.mode==="ordered"||o.mode==="latest")&&(u.setMode(o.mode),console.info("[audioDecoder] Set jitter buffer mode:",o.mode));return}const t=e.data,n={objectId:t.subgroupStreamObject.objectId,objectPayloadLength:t.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(t.subgroupStreamObject.objectPayload),objectStatus:t.subgroupStreamObject.objectStatus};b.addBytes(n.objectPayloadLength),u.push(t.groupId,n.objectId,n,o=>w(o))};async function A(e){const t=e.cachedChunk;B(t.metadata.sentAt);const n=j(t.metadata);if(!n)return;const o=O(n),s=_(n);if(!a||a.state==="closed"||l!==s)try{console.info("[audioDecoder] (re)initializing decoder with config:",o),console.info("[audioDecoder] desiredSignature:",s),a&&a.state!=="closed"&&a.close(),a=await T(o,s),y=null,c=n}catch(f){console.error("[audioDecoder] configure failed",f);return}const r=L(t.metadata.timestamp),i=new EncodedAudioChunk({type:t.metadata.type,timestamp:r,duration:t.metadata.duration??void 0,data:t.data});await a.decode(i)}function B(e){S(Date.now()-e)}function w(e){e<0||self.postMessage({type:"receiveLatency",media:"audio",ms:e})}function S(e){e<0||self.postMessage({type:"renderingLatency",media:"audio",ms:e})}function L(e){return 0}function j(e){if(!(e.codec||e.descriptionBase64||e.sampleRate||e.channels)&&!c)return null;const n=e.codec??(e.descriptionBase64?"mp4a.40.2":void 0)??c?.codec,o=e.sampleRate??c?.sampleRate??d.sampleRate,s=e.channels??c?.channels??d.numberOfChannels,r=e.descriptionBase64??c?.descriptionBase64;return n?{codec:n,sampleRate:o,channels:s,descriptionBase64:r}:null}function O(e){if(e.codec.startsWith("mp4a")){const t=e.descriptionBase64?D(e.descriptionBase64):void 0;return{codec:e.codec,sampleRate:e.sampleRate,numberOfChannels:e.channels,description:t}}return{codec:d.codec,sampleRate:e.sampleRate,numberOfChannels:e.channels}}function D(e){const t=atob(e),n=t.length,o=new Uint8Array(n);for(let s=0;s<n;s++)o[s]=t.charCodeAt(s);return o}function _(e){const t=e.descriptionBase64??"";return`${e.codec}:${e.sampleRate}:${e.channels}:${t}`}})();
