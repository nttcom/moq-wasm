(function(){"use strict";function h(e){if(e.byteLength<4)throw new Error("Payload too small to contain metadata");const n=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(0),o=4+n;if(e.byteLength<o)throw new Error("Payload too small to contain metadata");const s=e.slice(4,4+n),i=JSON.parse(new TextDecoder().decode(s)),a=e.slice(4+n);return{metadata:i,data:a}}const m=1e3,b=1800;class g{constructor(t=b){this.maxBufferSize=t}buffer=[];hasPoppedOnce=!1;firstInsertTimestamp=null;push(t,n,o,s){if(!o.objectPayloadLength)return;const i=h(o.objectPayload);if(!i)return;const a=o;a.cachedChunk=i,a.remotePTS=i.metadata.timestamp,a.localPTS=performance.timeOrigin+performance.now(),s?.(Date.now()-i.metadata.sentAt);const d=performance.now(),D={groupId:t,objectId:n,bufferInsertTimestamp:d,sentAt:i.metadata.sentAt,object:a},P=this.findInsertPos(t,n);this.buffer.splice(P,0,D),this.firstInsertTimestamp===null&&(this.firstInsertTimestamp=d),this.buffer.length>this.maxBufferSize&&(console.warn("[AudioJitterBuffer] Buffer full, dropping oldest entry"),this.buffer.shift())}pop(){return this.popWithMetadata()}popWithMetadata(){if(this.buffer.length===0)return null;if(!this.hasPoppedOnce){if(this.firstInsertTimestamp===null||performance.now()-this.firstInsertTimestamp<m)return null;const n=this.buffer.findIndex(i=>!!i.object.cachedChunk?.metadata?.codec||!!i.object.cachedChunk?.metadata?.descriptionBase64),o=n>=0?n:0,s=this.buffer.splice(o,1)[0];return this.hasPoppedOnce=!0,s??null}const t=this.buffer[0];return this.buffer.shift(),t}findInsertPos(t,n){for(let o=this.buffer.length-1;o>=0;o--){const s=this.buffer[o];if(s.groupId===t&&s.objectId<n||s.groupId<t)return o+1}return 0}}function T(e,t=1e3){let n=0,o=performance.now();return{addBytes(s){n+=s;const i=performance.now();if(i-o>=t){const a=n*8/1e3;e(a),n=0,o=i}}}}const y=T(e=>{self.postMessage({type:"bitrate",media:"audio",kbps:e})}),f={codec:"opus",sampleRate:48e3,numberOfChannels:1};let r,u=null,l=null,c=null;async function A(e,t){function n(i){self.postMessage({type:"audioData",audioData:i}),i.close()}const o={output:n,error:i=>{console.log(i.message)}},s=new AudioDecoder(o);return s.configure(e),l=t,console.info("[audioDecoder] (re)initializing decoder with config:",e),console.info("[audioDecoder] desiredSignature:",t),s}const E=5,p=new g(1800);setInterval(()=>{const e=p.pop();if(!e)return;console.debug(e);const t=e?.object;t&&w(t)},E),self.onmessage=async e=>{const t={objectId:e.data.subgroupStreamObject.objectId,objectPayloadLength:e.data.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(e.data.subgroupStreamObject.objectPayload),objectStatus:e.data.subgroupStreamObject.objectStatus};y.addBytes(t.objectPayloadLength),p.push(e.data.groupId,t.objectId,t,n=>L(n))};async function w(e){const t=e.cachedChunk;B(t.metadata.sentAt);const n=I(t.metadata);if(!n)return;const o=j(n),s=O(n);if(!r||r.state==="closed"||l!==s)try{console.info("[audioDecoder] (re)initializing decoder with config:",o),console.info("[audioDecoder] desiredSignature:",s),r&&r.state!=="closed"&&r.close(),r=await A(o,s),u=null,c=n}catch(d){console.error("[audioDecoder] configure failed",d);return}const i=C(t.metadata.timestamp),a=new EncodedAudioChunk({type:t.metadata.type,timestamp:i,duration:t.metadata.duration??void 0,data:t.data});await r.decode(a)}function B(e){S(Date.now()-e)}function L(e){e<0||self.postMessage({type:"receiveLatency",media:"audio",ms:e})}function S(e){e<0||self.postMessage({type:"renderingLatency",media:"audio",ms:e})}function C(e){return u===null&&(u=e),e-u}function I(e){if(!(e.codec||e.descriptionBase64||e.sampleRate||e.channels)&&!c)return null;const n=e.codec??(e.descriptionBase64?"mp4a.40.2":void 0)??c?.codec,o=e.sampleRate??c?.sampleRate??f.sampleRate,s=e.channels??c?.channels??f.numberOfChannels,i=e.descriptionBase64??c?.descriptionBase64;return n?{codec:n,sampleRate:o,channels:s,descriptionBase64:i}:null}function j(e){if(e.codec.startsWith("mp4a")){const t=e.descriptionBase64?_(e.descriptionBase64):void 0;return{codec:e.codec,sampleRate:e.sampleRate,numberOfChannels:e.channels,description:t}}return{codec:f.codec,sampleRate:e.sampleRate,numberOfChannels:e.channels}}function _(e){const t=atob(e),n=t.length,o=new Uint8Array(n);for(let s=0;s<n;s++)o[s]=t.charCodeAt(s);return o}function O(e){const t=e.descriptionBase64??"";return`${e.codec}:${e.sampleRate}:${e.channels}:${t}`}})();
