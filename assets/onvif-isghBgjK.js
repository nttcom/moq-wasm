import{M as H,p as O}from"./moqtClient-Clv5CNT1.js";const l=new H,M=new Worker(new URL("/moq-wasm/assets/videoDecoder-DbPKuoFa.js",import.meta.url),{type:"module"}),D=[{type:"absolute",label:"AbsoluteMove"},{type:"relative",label:"RelativeMove"},{type:"continuous",label:"ContinuousMove"},{type:"stop",label:"Stop",disabled:["pan","tilt","zoom","speed"]},{type:"center",label:"Center",disabled:["pan","tilt","zoom"]}],j={pan:"Pan",tilt:"Tilt",zoom:"Zoom",speed:"Speed"},C={pan:0,tilt:0,zoom:0,speed:1};let A=!1,g=null,w=0n,y=null,f=[],I=!1,m=null;function P(){if(A)return;A=!0;const e=new MediaStreamTrackGenerator({kind:"video"}),n=e.writable.getWriter(),t=new MediaStream([e]),a=document.getElementById("video");a&&(a.srcObject=t),M.onmessage=async o=>{o.data.type==="frame"&&(await n.ready,await n.write(o.data.frame),o.data.frame.close(),a&&await a.play())}}function U(e){P(),l.setOnSubgroupObjectHandler(e,(n,t)=>{const a=new Uint8Array(t.objectPayload);M.postMessage({groupId:n,subgroupStreamObject:{objectId:t.objectId,objectPayloadLength:t.objectPayloadLength,objectPayload:a,objectStatus:t.objectStatus,locHeader:t.locHeader}},[a.buffer])})}function i(e,n){const t=document.getElementById("status");if(!t)return;t.innerHTML=`<span></span>${e}`;const a=t.querySelector("span");a instanceof HTMLElement&&(a.style.background=n?"#2ec4b6":"#ff9f1c")}function q(e){const n=document.getElementById("command-alias");n&&(n.textContent=e===null?"-":e.toString())}function T(e){const n=document.getElementById("catalog-alias");n&&(n.textContent=e===null?"-":e.toString())}function v(e){const n=document.getElementById("selected-video-track");n&&(n.textContent=e??"-")}function x(){const e=l.getRawClient();if(!e)throw new Error("MOQT client not connected");return e}function B(e){return e.split("/").map(n=>n.trim()).filter(n=>n.length>0)}function E(e){try{return BigInt(e)}catch{return 0n}}function $(e){m=e,v(e),F(e)}function F(e){if(!e)return;const n=f.find(t=>t.name===e);n?.codec&&M.postMessage({type:"catalog",codec:n.codec})}function b(e,n,t){if(!t)return;const a=document.createElement("span");a.textContent=`${n}=${t}`,e.appendChild(a)}function z(e){if(typeof e=="number")return e.toFixed(2).replace(/\.?0+$/,"")}function V(e){if(typeof e=="number")return e>=1e6?`${(e/1e6).toFixed(2).replace(/\.?0+$/,"")}Mbps`:e>=1e3?`${Math.round(e/1e3)}kbps`:`${Math.round(e)}bps`}function W(e){if(typeof e=="number")return`${Math.round(e)}ms`}function _(e){if(typeof e=="boolean")return e?"live":"ended"}function k(){const e=document.getElementById("catalog-list");if(!e)return;if(e.innerHTML="",f.length===0){const t=document.createElement("div");t.className="muted",t.textContent="No catalog data yet.",e.appendChild(t),v(m);return}let n=m??"";if(n&&!f.some(t=>t.name===n)&&(n=""),!n){const t=f[0]?.name;t&&($(t),n=t)}for(const[t,a]of f.entries()){const o=document.createElement("label");o.className="catalog-item";const c=document.createElement("div");c.className="command-title",c.textContent=a.label||`Track ${t+1}`;const d=document.createElement("div");d.className="catalog-subtitle",d.textContent=a.namespace?`${a.name} @ ${a.namespace}`:a.name;const u=document.createElement("div"),r=document.createElement("input");r.type="radio",r.name="catalog-profile",r.value=a.name,r.checked=n===a.name||!n&&t===0,r.addEventListener("change",()=>{$(a.name)});const p=document.createElement("span");p.textContent=a.name,u.append(r,p);const s=document.createElement("div");s.className="catalog-meta",b(s,"role",a.role),b(s,"packaging",a.packaging),b(s,"status",_(a.isLive)),b(s,"resolution",a.resolution),b(s,"codec",a.codec),b(s,"fps",z(a.framerate)),b(s,"bitrate",V(a.bitrate)),b(s,"latency",W(a.targetLatency)),o.append(c,d,u,s),e.appendChild(o)}v(m)}function R(e){l.setOnSubgroupObjectHandler(e,(n,t)=>{const a=new Uint8Array(t.objectPayload),o=new TextDecoder().decode(a);try{const c=O(o);f=G(c),k(),F(m),i("catalog received",!0)}catch(c){console.error(c),i("catalog parse failed",!1)}})}function G(e){return(e.tracks??e.addTracks??[]).map(t=>{const a=t.label??t.name,o=typeof t.width=="number"&&typeof t.height=="number"?`${t.width}x${t.height}`:void 0;return{name:t.name,label:a,namespace:t.namespace,codec:t.codec,resolution:o,role:t.role,packaging:t.packaging,isLive:t.isLive,targetLatency:t.targetLatency,framerate:t.framerate,bitrate:t.bitrate}})}function h(e,n){const t=e.querySelector(`input[data-field="${n}"]`);if(!t)return C[n];const a=Number(t.value),o=Number.isFinite(a)?a:C[n],c=Math.round(o*10)/10;return t.value=c.toFixed(1),c}async function J(e,n){const t=x();if(g===null){i("command track not subscribed",!1);return}const a=h(n,"pan"),o=h(n,"tilt"),c=h(n,"zoom"),d=h(n,"speed"),u=e==="stop"?{type:"stop"}:e==="center"?{type:"center",speed:d}:{type:e,pan:a,tilt:o,zoom:c,speed:d},r=new TextEncoder().encode(JSON.stringify(u));await t.sendDatagramObject(g,0n,w,0,r),w+=1n,i(`sent ${e}`,!0)}function K(){const e=document.getElementById("command-grid");if(e){e.innerHTML="";for(const n of D){const t=document.createElement("div");t.className="command";const a=document.createElement("div");a.className="command-header";const o=document.createElement("div");o.className="command-title",o.textContent=n.label;const c=document.createElement("button");c.type="button",c.textContent="Send",c.addEventListener("click",()=>{J(n.type,t).catch(r=>{console.error(r),i("command send failed",!1)})}),a.append(o,c);const d=document.createElement("div");d.className="command-inputs";const u=new Set(n.disabled??[]);Object.keys(j).forEach(r=>{const p=document.createElement("label");p.textContent=j[r];const s=document.createElement("input");s.type="number",s.step="0.1",s.inputMode="decimal",s.value=C[r].toFixed(1),s.dataset.field=r,u.has(r)&&(s.disabled=!0),p.appendChild(s),d.appendChild(p)}),t.append(a,d),e.appendChild(t)}}}function Q(){const e=document.getElementById("moqt-url");if(!e)return;document.querySelectorAll("button[data-url]").forEach(t=>{t.addEventListener("click",()=>{const a=t.dataset.url;a&&(e.value=a)})})}function Z(){const e=document.getElementById("settings-modal");e&&(e.classList.add("open"),e.setAttribute("aria-hidden","false"))}function L(){const e=document.getElementById("settings-modal");e&&(e.classList.remove("open"),e.setAttribute("aria-hidden","true"))}async function X(){x();const e=B(document.getElementById("subscribe-namespace").value),n=document.getElementById("catalog-track").value,t=document.getElementById("auth-info").value,a=E(document.getElementById("catalog-subscribe-id").value),o=E(document.getElementById("catalog-track-alias").value);if(!e.length){i("namespace required",!1);return}R(o),await l.subscribe(a,o,e,n,t),y=o,T(y),i("catalog subscribed",!0)}async function Y(){if(I){i("video already subscribed",!1);return}x();const e=B(document.getElementById("subscribe-namespace").value),n=m?.trim()??"",t=document.getElementById("auth-info").value,a=E(document.getElementById("video-subscribe-id").value),o=E(document.getElementById("video-track-alias").value);if(!e.length||!n){i("video track required",!1);return}U(o),await l.subscribe(a,o,e,n,t),I=!0,i(`video subscribed: ${n}`,!0)}async function ee(){const e=document.getElementById("moqt-url").value,n=B(document.getElementById("publish-namespace").value),t=B(document.getElementById("subscribe-namespace").value),a=n.join("/"),o=document.getElementById("command-track").value,c=document.getElementById("auth-info").value,d=E(document.getElementById("max-subscribe-id").value);if(!n.length||!t.length){i("namespace required",!1);return}f=[],I=!1,y=null,m=null,k(),T(y),v(m),i("connecting",!0),await l.connect(e,{sendSetup:!1}),l.setOnConnectionClosedHandler(()=>{i("disconnected",!1)}),await l.sendSetupMessage(new BigUint64Array([0xff00000an]),d),l.setOnIncomingSubscribeHandler(async({subscribe:u,isSuccess:r,code:p,respondOk:s,respondError:N})=>{if(!r){await N(BigInt(p),"subscribe rejected");return}if(u.trackName!==o||u.trackNamespace.join("/")!==a){await N(404n,"unknown track");return}await s(0n,c,"datagram"),g=u.trackAlias,q(g)}),await l.announce(n,c),i("connected",!0)}async function te(){await l.disconnect(),g=null,w=0n,y=null,f=[],I=!1,m=null,l.clearSubgroupObjectHandlers(),q(g),T(y),k(),v(m),i("disconnected",!1)}const ne=document.getElementById("connect-btn"),ae=document.getElementById("disconnect-btn"),oe=document.getElementById("catalog-subscribe-btn"),ce=document.getElementById("video-subscribe-btn"),se=document.getElementById("settings-btn"),ie=document.getElementById("settings-close-btn"),re=document.getElementById("settings-save-btn"),S=document.getElementById("settings-modal");ne?.addEventListener("click",()=>{ee().catch(e=>{console.error(e),i("connection failed",!1)})});ae?.addEventListener("click",()=>{te().catch(e=>{console.error(e)})});oe?.addEventListener("click",()=>{X().catch(e=>{console.error(e),i("catalog subscribe failed",!1)})});ce?.addEventListener("click",()=>{Y().catch(e=>{console.error(e),i("video subscribe failed",!1)})});se?.addEventListener("click",()=>{Z()});ie?.addEventListener("click",()=>{L()});re?.addEventListener("click",()=>{L()});S?.addEventListener("click",e=>{e.target===S&&L()});document.addEventListener("keydown",e=>{e.key==="Escape"&&S?.classList.contains("open")&&L()});K();Q();k();
