import{_ as C,M as O}from"./moqt_client_sample-4b7b2ba2.js";const y=900,E="secret";async function M(n,o,c,s,r,e,t){var f,B,v,I,S,k,A,a,w;const i=new Uint8Array(r.byteLength);r.copyTo(i);const l={type:r.type,timestamp:r.timestamp,duration:r.duration,byteLength:r.byteLength,data:Array.from(i),decoderConfig:{codec:(f=e==null?void 0:e.decoderConfig)==null?void 0:f.codec,codedHeight:(B=e==null?void 0:e.decoderConfig)==null?void 0:B.codedHeight,codedWidth:(v=e==null?void 0:e.decoderConfig)==null?void 0:v.codedWidth,colorSpace:(I=e==null?void 0:e.decoderConfig)==null?void 0:I.colorSpace,description:(S=e==null?void 0:e.decoderConfig)==null?void 0:S.description,displayAspectHeight:(k=e==null?void 0:e.decoderConfig)==null?void 0:k.displayAspectHeight,displayAspectWidth:(A=e==null?void 0:e.decoderConfig)==null?void 0:A.displayAspectWidth,hardwareAcceleration:(a=e==null?void 0:e.decoderConfig)==null?void 0:a.hardwareAcceleration,optimizeForLatency:(w=e==null?void 0:e.decoderConfig)==null?void 0:w.optimizeForLatency},temporalLayer:e==null?void 0:e.temporalLayerId},p=new TextEncoder,h=JSON.stringify({chunk:l}),j=p.encode(h);await t.sendSubgroupStreamObject(BigInt(n),o,c,s,void 0,j),s===BigInt(y-1)&&(await t.sendSubgroupStreamObject(BigInt(n),o,c,BigInt(y),3,Uint8Array.from([])),console.log("send Object(ObjectStatus=EndOfGroup)"))}const u=()=>document.getElementById("form");let g=null;function L(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const o={audio:!1,video:{width:{exact:1920},height:{exact:1080}}};g=await navigator.mediaDevices.getUserMedia(o);const c=document.getElementById("video");c.srcObject=g})}const d={video:{objectId:0n,groupId:-1n,subgroups:{0:{}}},audio:{objectId:0n,groupId:0n,subgroups:{0:{isSendedSubgroupHeader:!1}}}},b=new Worker("videoEncoder.ts");async function H(n,o,c){const s=u(),r=s["video-object-track-alias"].value,e=s["video-publisher-priority"].value;if(n.type==="key"){d.video.groupId++,d.video.objectId=BigInt(0);const t=Object.keys(d.video.subgroups).map(BigInt);for(const i of t)await c.sendSubgroupStreamHeaderMessage(BigInt(r),d.video.groupId,i,e),console.log("send subgroup stream header")}M(r,d.video.groupId,BigInt(o==null?void 0:o.svc.temporalLayerId),d.video.objectId,n,o,c),d.video.objectId++}const T=new Worker("audioEncoder.ts");function U(n){n.onSetup(async o=>{console.log({serverSetup:o})}),n.onAnnounce(async o=>{console.log({announceMessage:o});const c=o.track_namespace;await n.sendAnnounceOkMessage(c)}),n.onAnnounceResponce(async o=>{console.log({announceResponceMessage:o})}),n.onSubscribe(async(o,c,s)=>{console.log({subscribeMessage:o});const r=u(),e=BigInt(o.subscribe_id),t=BigInt(o.track_alias);if(console.log("subscribeId",e,"trackAlias",t),c){const i=0n,l=Array.from(r["forwarding-preference"]).filter(p=>p.checked)[0].value;await n.sendSubscribeOkMessage(e,i,E,l)}else{const i="subscribe error";await n.sendSubscribeErrorMessage(o.subscribe_id,s,i)}})}function _(n){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const c=u(),s=new BigUint64Array("0xff00000A".split(",").map(BigInt)),r=BigInt(c["max-subscribe-id"].value);await n.sendSetupMessage(s,r)})}function m(n){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const s=u()["announce-track-namespace"].value.split("/");await n.sendAnnounceMessage(s,E)})}function W(n){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(console.log("clicked sendSubgroupObjectBtn"),g==null){console.error("mediaStream is null");return}b.onmessage=async e=>{const{chunk:t,metadata:i}=e.data;console.log(t,i),H(t,i,n)},T.onmessage=async e=>{e.data};const[c]=g.getVideoTracks(),r=new MediaStreamTrackProcessor({track:c}).readable;b.postMessage({type:"keyframeInterval",keyframeInterval:y}),b.postMessage({type:"videoStream",videoStream:r},[r])})}function x(n){_(n),m(n),W(n)}C().then(async()=>{L(),document.getElementById("connectBtn").addEventListener("click",async()=>{const c=u().url.value,s=new O(c);U(s),x(s),await s.start()})});
