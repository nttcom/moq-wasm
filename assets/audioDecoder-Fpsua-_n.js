(function(){"use strict";function M(e){if(e.byteLength<4)throw new Error("Payload too small to contain metadata");const n=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(0),o=4+n;if(e.byteLength<o)throw new Error("Payload too small to contain metadata");const r=e.slice(4,4+n),a=JSON.parse(new TextDecoder().decode(r)),s=e.slice(4+n);return{metadata:a,data:s}}function C(e){try{return M(e)}catch{return null}}function h(e){if(!e)return{};const t={};for(const n of e.extensions)switch(n.type){case"captureTimestamp":t.captureTimestampMicros=n.value.microsSinceUnixEpoch;break;case"videoConfig":t.videoConfig=n.value.data;break;case"videoFrameMarking":t.videoFrameMarking=n.value.data;break;case"audioLevel":t.audioLevel=n.value.level;break}return t}const g=1e3;function E(){return Math.round((performance.timeOrigin+performance.now())*g)}function b(e){return(E()-e)/g}const S=1800;class A{constructor(t=S,n="ordered"){this.maxBufferSize=t,this.mode=n}buffer=[];hasPoppedOnce=!1;mode="ordered";setMode(t){this.mode=t}push(t,n,o,r){if(!o.objectPayloadLength)return!1;const a=h(o.locHeader),s=y(a.captureTimestampMicros),l=C(o.objectPayload);if(!l){const B=o.locHeader,m=B?.extensions??[];if(!B||m.length===0)console.debug("[AudioJitterBuffer] Missing metadata and LOC header",{groupId:t,objectId:n,payloadLength:o.objectPayloadLength});else{const Y=m.some($=>$.type==="captureTimestamp");console.debug("[AudioJitterBuffer] Using LOC header fallback",{groupId:t,objectId:n,payloadLength:o.objectPayloadLength,locExtensionCount:m.length,hasCaptureTimestamp:Y})}}const f=l??O(o);if(!f)return console.debug("[AudioJitterBuffer] Failed to build chunk from payload",{groupId:t,objectId:n,payloadLength:o.objectPayloadLength}),!1;const p=o;p.cachedChunk=f,p.remotePTS=f.metadata.timestamp,p.localPTS=performance.timeOrigin+performance.now(),typeof s=="number"&&r?.(b(s));const J=performance.now(),z={groupId:t,objectId:n,bufferInsertTimestamp:J,captureTimestampMicros:s,object:p},G=this.findInsertPos(t,n);return this.buffer.splice(G,0,z),this.buffer.length>this.maxBufferSize&&(console.warn("[AudioJitterBuffer] Buffer full, dropping oldest entry"),this.buffer.shift()),!0}pop(){return this.popWithMetadata()}popWithMetadata(){if(this.buffer.length===0)return null;if(this.mode==="latest"){const n=this.buffer.pop();return this.buffer.length=0,n??null}if(!this.hasPoppedOnce){const n=this.buffer.pop();return this.hasPoppedOnce=!0,n??null}const t=this.buffer[0];return this.buffer.shift(),t}findInsertPos(t,n){for(let o=this.buffer.length-1;o>=0;o--){const r=this.buffer[o];if(r.groupId===t&&r.objectId<n||r.groupId<t)return o+1}return 0}getBufferedFrameCount(){return this.buffer.length}getMaxBufferSize(){return this.maxBufferSize}}function O(e){const t=h(e.locHeader),n=y(t.captureTimestampMicros);return{metadata:{type:"key",timestamp:typeof n=="number"?n:0,duration:null},data:e.objectPayload}}function y(e){if(!(typeof e!="number"||!Number.isFinite(e)||e<0))return e}function w(e,t=1e3){let n=0,o=performance.now();return{addBytes(r){n+=r;const a=performance.now();if(a-o>=t){const s=n*8/1e3;e(s),n=0,o=a}}}}const P=w(e=>{self.postMessage({type:"bitrate",media:"audio",kbps:e})}),i={codec:"opus",sampleRate:48e3,numberOfChannels:1};let c,_=null,T=null,u=null;async function R(e,t){function n(a){self.postMessage({type:"audioData",audioData:a}),a.close()}const o={output:n,error:a=>{console.warn("[audioDecoder] decoder error",a)}},r=new AudioDecoder(o);return r.configure(e),T=t,r}const j=5,d=new A(1800,"ordered");setInterval(()=>{const e=d.pop();if(!e)return;L("pop");const t=e?.object;t&&k(t,e.captureTimestampMicros)},j),self.onmessage=async e=>{if(e.data.type==="config"){const r=e.data.config;(r.mode==="ordered"||r.mode==="latest")&&d.setMode(r.mode);return}const t=e.data,n={objectId:t.subgroupStreamObject.objectId,objectPayloadLength:t.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(t.subgroupStreamObject.objectPayload),objectStatus:t.subgroupStreamObject.objectStatus,locHeader:t.subgroupStreamObject.locHeader};P.addBytes(n.objectPayloadLength),d.push(t.groupId,n.objectId,n,r=>F(r))&&L("push")};async function k(e,t){const n=e.cachedChunk;D(t);const o=N(n.metadata);if(!o)return;const r=I(o),a=v(o);if(!c||c.state==="closed"||T!==a)try{c&&c.state!=="closed"&&c.close(),c=await R(r,a),_=null,u=o}catch(f){console.error("[audioDecoder] configure failed",f);return}const s=H(n.metadata.timestamp),l=new EncodedAudioChunk({type:n.metadata.type,timestamp:s,duration:n.metadata.duration??void 0,data:n.data});await c.decode(l)}function D(e){typeof e=="number"&&x(b(e))}function F(e){e<0||self.postMessage({type:"receiveLatency",media:"audio",ms:e})}function x(e){e<0||self.postMessage({type:"renderingLatency",media:"audio",ms:e})}function L(e){self.postMessage({type:"jitterBufferActivity",media:"audio",event:e,bufferedFrames:d.getBufferedFrameCount(),capacityFrames:d.getMaxBufferSize()})}function H(e){return 0}function N(e){if(!(e.codec||e.descriptionBase64||e.sampleRate||e.channels)&&!u)return{codec:i.codec,sampleRate:i.sampleRate,channels:i.numberOfChannels};const n=e.codec??(e.descriptionBase64?"mp4a.40.2":void 0)??u?.codec??i.codec,o=e.sampleRate??u?.sampleRate??i.sampleRate,r=e.channels??u?.channels??i.numberOfChannels,a=e.descriptionBase64??u?.descriptionBase64;return{codec:n,sampleRate:o,channels:r,descriptionBase64:a}}function I(e){if(e.codec.startsWith("mp4a")){const t=e.descriptionBase64?U(e.descriptionBase64):void 0;return{codec:e.codec,sampleRate:e.sampleRate,numberOfChannels:e.channels,description:t}}return{codec:i.codec,sampleRate:e.sampleRate,numberOfChannels:e.channels}}function U(e){const t=atob(e),n=t.length,o=new Uint8Array(n);for(let r=0;r<n;r++)o[r]=t.charCodeAt(r);return o}function v(e){const t=e.descriptionBase64??"";return`${e.codec}:${e.sampleRate}:${e.channels}:${t}`}})();
