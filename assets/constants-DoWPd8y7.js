function m(t,e){const o={type:t.type,timestamp:t.timestamp,duration:t.duration??null,sentAt:Date.now(),...e},d=new TextEncoder().encode(JSON.stringify(o)),n=new Uint8Array(4+d.length+t.byteLength);new DataView(n.buffer).setUint32(0,d.length),n.set(d,4);const a=new Uint8Array(t.byteLength);return t.copyTo(a),n.set(a,4+d.length),n}function v(t){if(typeof t=="bigint")return t;try{return BigInt(t)}catch{throw new Error(`Invalid alias value: ${t}`)}}function r(t){return v(t).toString()}class I{video={groupId:-1n,objectId:0n,subgroups:new Map([[0,{sentAliases:new Set}]])};audio={groupId:0n,objectId:0n,subgroups:new Map([[0,{sentAliases:new Set}]])};audioCodecSent=new Set;videoCodecSent=new Set;ensureVideoSubgroup(e){this.ensureSubgroup(this.video,e)}ensureAudioSubgroup(e){this.ensureSubgroup(this.audio,e)}advanceVideoGroup(){this.video.groupId+=1n,this.video.objectId=0n,this.resetHeaders(this.video)}getVideoGroupId(){return this.video.groupId}getVideoObjectId(){return this.video.objectId}incrementVideoObject(){this.video.objectId+=1n}hasVideoHeaderSent(e,o){return this.hasHeaderSent(this.video,e,o)}markVideoHeaderSent(e,o){this.markHeaderSent(this.video,e,o)}getAudioGroupId(){return this.audio.groupId}getAudioObjectId(){return this.audio.objectId}incrementAudioObject(){this.audio.objectId+=1n}shouldSendAudioHeader(e,o){return!this.hasHeaderSent(this.audio,e,o)}markAudioHeaderSent(e,o){this.markHeaderSent(this.audio,e,o)}shouldSendAudioCodec(e){return!this.audioCodecSent.has(r(e))}markAudioCodecSent(e){this.audioCodecSent.add(r(e))}listVideoSubgroups(){return Array.from(this.video.subgroups.keys())}shouldSendVideoCodec(e){return!this.videoCodecSent.has(r(e))}markVideoCodecSent(e){this.videoCodecSent.add(r(e))}resetAlias(e){const o=r(e);for(const d of this.video.subgroups.values())d.sentAliases.delete(o);for(const d of this.audio.subgroups.values())d.sentAliases.delete(o);this.audioCodecSent.delete(o),this.videoCodecSent.delete(o)}ensureSubgroup(e,o){e.subgroups.has(o)||e.subgroups.set(o,{sentAliases:new Set})}resetHeaders(e){for(const o of e.subgroups.values())o.sentAliases.clear()}hasHeaderSent(e,o,d){return this.ensureSubgroup(e,d),e.subgroups.get(d).sentAliases.has(r(o))}markHeaderSent(e,o,d){this.ensureSubgroup(e,d),e.subgroups.get(d).sentAliases.add(r(o))}}async function y({chunk:t,metadata:e,trackAliases:o,publisherPriority:d,client:n,transportState:i,sender:a,fallbackCodec:p}){if(!o.length)return;const u=Number(e?.svc?.temporalLayerId??0);i.ensureVideoSubgroup(u);const f=o.some(s=>i.shouldSendVideoCodec(s)),c=e?.decoderConfig,l=p??"avc1.640028",g=c?.codec??l,h=g!==void 0?c?.description?{codec:g,descriptionBase64:V(c.description)}:{codec:g}:void 0,b=t.type==="key"||f?h:void 0;if(t.type==="key"){i.advanceVideoGroup();for(const s of o)for(const S of i.listVideoSubgroups())await n.sendSubgroupStreamHeaderMessage(s,i.getVideoGroupId(),BigInt(S),d),i.markVideoHeaderSent(s,S)}else for(const s of o)i.hasVideoHeaderSent(s,u)||(await n.sendSubgroupStreamHeaderMessage(s,i.getVideoGroupId(),BigInt(u),d),i.markVideoHeaderSent(s,u));for(const s of o)await a(s,i.getVideoGroupId(),BigInt(u),i.getVideoObjectId(),t,n,b),b&&i.markVideoCodecSent(s);i.incrementVideoObject()}function V(t){const e=new Uint8Array(t);let o="";for(let d=0;d<e.byteLength;d++)o+=String.fromCharCode(e[d]);return btoa(o)}const A=300;export{A as K,I as M,y as a,m as s};
