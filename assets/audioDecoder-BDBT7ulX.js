(function(){"use strict";function c(s){if(s.byteLength<4)throw new Error("Payload too small to contain metadata");const t=new DataView(s.buffer,s.byteOffset,s.byteLength).getUint32(0),o=4+t;if(s.byteLength<o)throw new Error("Payload too small to contain metadata");const n=s.slice(4,4+t),r=JSON.parse(new TextDecoder().decode(n)),a=s.slice(4+t);return{metadata:r,data:a}}const f=50,l=1800,p=500,h=3;class b{constructor(e=l,t,o){this.maxBufferSize=e,this.mode=t,this.keyframeInterval=typeof o=="number"?BigInt(o):o??void 0}buffer=[];minDelayMs=f;lastPoppedGroupId=null;lastPoppedObjectId=null;keyframeInterval;setMinDelay(e){!Number.isFinite(e)||e<0||(this.minDelayMs=e)}push(e,t,o){if(!o.objectPayloadLength)return;const n=c(o.objectPayload);if(!n)return;const r=o;if(r.cachedChunk=n,r.remotePTS=n.metadata.timestamp,r.localPTS=performance.timeOrigin+performance.now(),this.mode==="video_correctly"&&this.shouldRejectOldData(e,t)){console.warn(`[JitterBuffer] Rejecting old data. Expected: (group:${this.lastPoppedGroupId}, object:${this.lastPoppedObjectId}), Got: (group:${e}, object:${t})`);return}const a={groupId:e,objectId:t,bufferInsertTimestamp:performance.now(),sentAt:n.metadata.sentAt,object:r,isEndOfGroup:o.objectStatus===h},O=this.findInsertPos(e,t);this.buffer.splice(O,0,a),this.mode==="audio"&&this.dropStaleEntries(p),this.buffer.length>this.maxBufferSize&&(console.warn("JitterBuffer is full, removing the oldest element"),this.buffer.shift())}shouldRejectOldData(e,t){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?!1:e<this.lastPoppedGroupId||e===this.lastPoppedGroupId&&t<=this.lastPoppedObjectId}pop(){return this.popWithMetadata()}popWithMetadata(){return this.buffer.length===0?null:this.mode==="video_normal"||this.mode==="audio"?this.popNormalMode():this.popCorrectlyMode()}popNormalMode(){const e=this.buffer[0];return performance.now()-e.bufferInsertTimestamp<this.minDelayMs?null:(this.buffer.shift(),this.recordPopResult(e),e)}popCorrectlyMode(){const e=this.getExpectedNextEntry();let t=this.buffer.findIndex(r=>r.groupId===e.groupId&&r.objectId===e.objectId);if(t===-1&&(t=this.findResyncIndex(),t===-1)){if(this.lastPoppedGroupId===null&&this.buffer.length>0){const r=this.buffer.slice(0,5).map(a=>`(g:${a.groupId}, o:${a.objectId})`);console.warn(`[JitterBuffer] Expected first entry not found. Expected: (g:${e.groupId}, o:${e.objectId}), Buffer: [${r.join(", ")}]`)}return null}const o=this.buffer[t];return performance.now()-o.bufferInsertTimestamp<this.minDelayMs?null:(this.buffer.splice(t,1),this.recordPopResult(o),o)}recordPopResult(e){this.lastPoppedGroupId=e.groupId,this.lastPoppedObjectId=e.objectId,e.isEndOfGroup&&(this.lastPoppedGroupId=e.groupId+1n,this.lastPoppedObjectId=-1n)}getExpectedNextEntry(){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?{groupId:0n,objectId:0n}:this.keyframeInterval!==void 0&&this.lastPoppedObjectId===this.keyframeInterval-1n?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:{groupId:this.lastPoppedGroupId,objectId:this.lastPoppedObjectId+1n}}findInsertPos(e,t){for(let o=this.buffer.length-1;o>=0;o--){const n=this.buffer[o];if(n.groupId===e&&n.objectId<t||n.groupId<e)return o+1}return 0}findResyncIndex(){return this.buffer.length===0?-1:this.lastPoppedGroupId===null?0:this.buffer.findIndex(e=>e.objectId===0n&&e.groupId>this.lastPoppedGroupId)}dropStaleEntries(e){const t=Date.now();for(;this.buffer.length>0;){const o=this.buffer[0];if(t-o.sentAt<=e)break;this.buffer.shift()}}}function m(s,e=1e3){let t=0,o=performance.now();return{addBytes(n){t+=n;const r=performance.now();if(r-o>=e){const a=t*8/1e3;s(a),t=0,o=r}}}}const I=m(s=>{self.postMessage({type:"bitrate",media:"audio",kbps:s})}),g={codec:"opus",sampleRate:48e3,numberOfChannels:1,bitrate:64e3};let i,d=null;async function E(){function s(o){self.postMessage({type:"audioData",audioData:o}),o.close()}const e={output:s,error:o=>{console.log(o.message)}},t=new AudioDecoder(e);return t.configure(g),t}const j=5,u=new b(1800,"audio");u.setMinDelay(50),setInterval(()=>{const s=u.pop();if(!s)return;console.log(s);const e=s?.object;e&&y(e)},j),self.onmessage=async s=>{const e={objectId:s.data.subgroupStreamObject.objectId,objectPayloadLength:s.data.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(s.data.subgroupStreamObject.objectPayload),objectStatus:s.data.subgroupStreamObject.objectStatus};I.addBytes(e.objectPayloadLength),u.push(s.data.groupId,e.objectId,e)};async function y(s){const e=s.cachedChunk;P(e.metadata.sentAt);const t=T(e.metadata.timestamp),o=new EncodedAudioChunk({type:e.metadata.type,timestamp:t,duration:e.metadata.duration??void 0,data:e.data});(!i||i.state==="closed")&&(i=await E()),await i.decode(o)}function P(s){const e=Date.now()-s;self.postMessage({type:"latency",media:"audio",ms:e})}function T(s){return d===null&&(d=s),s-d}})();
