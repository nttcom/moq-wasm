import{M}from"./moqtClient-D5SqoAWn.js";import{s as h,K as O,M as E}from"./constants-D3d33FMk.js";const S="secret";function j(e,t=1e3){let n=0,r=performance.now();return{addBytes(o){n+=o;const a=performance.now();if(a-r>=t){const s=n*8/1e6;console.log(`${e}: ${s.toFixed(2)} Mbps`),n=0,r=a}}}}const C=j("chunkData bitrate"),w=new Map;function k(e){const t={type:e.type,timestamp:e.timestamp,duration:e.duration??0},n=JSON.stringify(t),r=new TextEncoder().encode(n),o=r.length,a=new Uint8Array(e.byteLength);e.copyTo(a);const s=4+o+a.length,i=new Uint8Array(s);return new DataView(i.buffer).setUint32(0,o),i.set(r,4),i.set(a,4+o),i}async function L(e,t,n,r,o,a){const s=w.get(e);if(s&&s.groupId!==t){const c=s.lastObjectId+1n;await a.sendSubgroupStreamObject(e,s.groupId,0n,c,3,new Uint8Array(0)),console.log(`[MediaPublisher] Sent EndOfGroup trackAlias=${e} groupId=${s.groupId} subgroupId=0 objectId=${c}`)}C.addBytes(o.byteLength);const i=k(o);await a.sendSubgroupStreamObject(BigInt(e),t,n,r,void 0,i),w.set(e,{groupId:t,lastObjectId:r})}async function T(e,t,n,r,o,a){const s=k(o);await a.sendSubgroupStreamObject(BigInt(e),t,n,r,void 0,s)}const l=()=>document.getElementById("form");let p=null;const u=new M,d=new E;function v(){const e=u.getRawClient();if(!e)throw new Error("MOQT client not connected");return e}function U(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const t={audio:!0,video:{width:{exact:1920},height:{exact:1080}}};p=await navigator.mediaDevices.getUserMedia(t);const n=document.getElementById("video");n.srcObject=p})}const y=new Worker(new URL("/moq-wasm/assets/videoEncoder-Q7tlg8rw.js",import.meta.url),{type:"module"}),B=new Worker(new URL("/moq-wasm/assets/audioEncoder-C5ddj3Cv.js",import.meta.url),{type:"module"});async function H(e,t,n){const r=l(),o=BigInt(r["audio-object-track-alias"].value),a=Number(r["audio-publisher-priority"].value),s=0;d.ensureAudioSubgroup(s),d.shouldSendAudioHeader(o,s)&&(await n.sendSubgroupStreamHeaderMessage(o,d.getAudioGroupId(),BigInt(s),a),console.log("send subgroup stream header"),d.markAudioHeaderSent(o,s)),T(o,d.getAudioGroupId(),BigInt(s),d.getAudioObjectId(),e,n),d.incrementAudioObject()}function P(){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const t=l(),n=new BigUint64Array("0xff00000A".split(",").map(BigInt)),r=BigInt(t["max-subscribe-id"].value);await u.sendSetupMessage(n,r)})}function x(){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const n=l()["announce-track-namespace"].value.split("/");await u.announce(n,S)})}function G(){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(console.log("clicked sendSubgroupObjectBtn"),p==null){console.error("mediaStream is null");return}let t;try{t=v()}catch(c){console.error(c);return}y.onmessage=async c=>{const m=c.data;if(m.type!=="chunk")return;const{chunk:g,metadata:b}=m,f=l(),I=BigInt(f["video-object-track-alias"].value),A=Number(f["video-publisher-priority"].value);await h({chunk:g,metadata:b,trackAliases:[I],publisherPriority:A,client:t,transportState:d,sender:L})},B.onmessage=async c=>{const m=c.data;if(m.type!=="chunk")return;const{chunk:g,metadata:b}=m;H(g,b,t)};const[n]=p.getVideoTracks(),o=new MediaStreamTrackProcessor({track:n}).readable;y.postMessage({type:"keyframeInterval",keyframeInterval:O}),y.postMessage({type:"videoStream",videoStream:o},[o]);const[a]=p.getAudioTracks(),i=new MediaStreamTrackProcessor({track:a}).readable;B.postMessage({type:"audioStream",audioStream:i},[i])})}function N(){P(),x(),G()}function R(){u.setOnServerSetupHandler(e=>{console.log({serverSetup:e})}),u.setOnAnnounceHandler(async e=>{console.log({announceMessage:e}),await v().sendAnnounceOkMessage(e.trackNamespace)}),u.setOnSubscribeResponseHandler(e=>{console.log({announceResponseMessage:e})}),u.setOnIncomingSubscribeHandler(async({subscribe:e,isSuccess:t,code:n,respondOk:r,respondError:o})=>{console.log({subscribeMessage:e});const a=l(),s=Array.from(a["forwarding-preference"]).filter(c=>c.checked)[0].value;if(t){await r(0n,S,s);return}await o(BigInt(n),"subscribe error")})}U();R();const V=document.getElementById("connectBtn");V.addEventListener("click",async()=>{const t=l().url.value;await u.connect(t,{sendSetup:!1}),N()});
