var S=Object.defineProperty;var L=(a,i,u)=>i in a?S(a,i,{enumerable:!0,configurable:!0,writable:!0,value:u}):a[i]=u;var c=(a,i,u)=>(L(a,typeof i!="symbol"?i+"":i,u),u);(function(){"use strict";function i(t){if(t.byteLength<4)return null;const o=new DataView(t.buffer,t.byteOffset,t.byteLength).getUint32(0),r=4+o;if(t.byteLength<r)return null;const s=t.slice(4,4+o),n=JSON.parse(new TextDecoder().decode(s)),d=t.slice(4+o);return{metadata:n,data:d}}const u=50,l=1800,h=500,b=3;class m{constructor(e=l,o,r){c(this,"buffer",[]);c(this,"minDelayMs",u);c(this,"lastPoppedGroupId",null);c(this,"lastPoppedObjectId",null);c(this,"keyframeInterval");this.maxBufferSize=e,this.mode=o,this.keyframeInterval=typeof r=="number"?BigInt(r):r??void 0}setMinDelay(e){!Number.isFinite(e)||e<0||(this.minDelayMs=e)}push(e,o,r){if(!r.objectPayloadLength)return;const s=i(r.objectPayload);if(!s)return;const n=r;if(n.cachedChunk=s,this.mode==="video_correctly"&&this.shouldRejectOldData(e,o)){console.warn(`[JitterBuffer] Rejecting old data. Expected: (group:${this.lastPoppedGroupId}, object:${this.lastPoppedObjectId}), Got: (group:${e}, object:${o})`);return}const d=performance.now(),_={groupId:e,objectId:o,timestamp:d,object:n,isEndOfGroup:r.objectStatus===b,referenceTime:I(s.metadata)},M=this.findInsertPos(e,o);this.buffer.splice(M,0,_),this.mode==="audio"&&this.dropStaleEntries(h),this.buffer.length>this.maxBufferSize&&(console.warn("JitterBuffer is full, removing the oldest element"),this.buffer.shift())}shouldRejectOldData(e,o){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?!1:e<this.lastPoppedGroupId||e===this.lastPoppedGroupId&&o<=this.lastPoppedObjectId}pop(){const e=this.popWithMetadata();return e?e.object:null}popWithMetadata(){return this.buffer.length===0?null:this.mode==="video_normal"||this.mode==="audio"?this.popNormalMode():this.popCorrectlyMode()}popNormalMode(){const e=this.buffer[0];return performance.now()-e.timestamp<this.minDelayMs?null:(this.buffer.shift(),this.recordPopResult(e),e)}popCorrectlyMode(){const e=this.getExpectedNextEntry();let o=this.buffer.findIndex(n=>n.groupId===e.groupId&&n.objectId===e.objectId);if(o===-1&&(o=this.findResyncIndex(),o===-1)){if(this.lastPoppedGroupId===null&&this.buffer.length>0){const n=this.buffer.slice(0,5).map(d=>`(g:${d.groupId}, o:${d.objectId})`);console.warn(`[JitterBuffer] Expected first entry not found. Expected: (g:${e.groupId}, o:${e.objectId}), Buffer: [${n.join(", ")}]`)}return null}const r=this.buffer[o];return performance.now()-r.timestamp<this.minDelayMs?null:(this.buffer.splice(o,1),this.recordPopResult(r),r)}recordPopResult(e){this.lastPoppedGroupId=e.groupId,this.lastPoppedObjectId=e.objectId,e.isEndOfGroup&&(this.lastPoppedGroupId=e.groupId+1n,this.lastPoppedObjectId=-1n)}getExpectedNextEntry(){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?{groupId:0n,objectId:0n}:this.keyframeInterval!==void 0&&this.lastPoppedObjectId===this.keyframeInterval-1n?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:{groupId:this.lastPoppedGroupId,objectId:this.lastPoppedObjectId+1n}}findInsertPos(e,o){for(let r=this.buffer.length-1;r>=0;r--){const s=this.buffer[r];if(s.groupId===e&&s.objectId<o||s.groupId<e)return r+1}return 0}findResyncIndex(){return this.buffer.length===0?-1:this.lastPoppedGroupId===null?0:this.buffer.findIndex(e=>e.objectId===0n&&e.groupId>this.lastPoppedGroupId)}dropStaleEntries(e){const o=Date.now();for(;this.buffer.length>0;){const s=this.buffer[0].referenceTime;if(s===void 0||o-s<=e)break;this.buffer.shift()}}}function I(t){if(typeof t.sentAt=="number")return t.sentAt;if(typeof t.timestamp=="number")return performance.timeOrigin+t.timestamp/1e3}function g(t,e=1e3){let o=0,r=performance.now();return{addBytes(s){o+=s;const n=performance.now();if(n-r>=e){const d=o*8/1e3;t(d),o=0,r=n}}}}const E=g(t=>{self.postMessage({type:"bitrate",media:"audio",kbps:t})}),j={codec:"opus",sampleRate:48e3,numberOfChannels:1,bitrate:64e3};let f;async function y(){function t(r){self.postMessage({type:"audioData",audioData:r}),r.close()}const e={output:t,error:r=>{console.log(r.message)}},o=new AudioDecoder(e);return o.configure(j),o}const P=5,p=new m(1800,"audio");p.setMinDelay(50),setInterval(()=>{const t=p.pop();t&&T(t)},P),self.onmessage=async t=>{const e={objectId:t.data.subgroupStreamObject.objectId,objectPayloadLength:t.data.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(t.data.subgroupStreamObject.objectPayload),objectStatus:t.data.subgroupStreamObject.objectStatus};E.addBytes(e.objectPayloadLength),p.push(t.data.groupId,e.objectId,e)};async function T(t){const e=t.cachedChunk;O(e.metadata.sentAt);const o=new EncodedAudioChunk({type:e.metadata.type,timestamp:e.metadata.timestamp,duration:e.metadata.duration??void 0,data:e.data});(!f||f.state==="closed")&&(f=await y()),await f.decode(o)}function O(t){if(typeof t!="number")return;const e=Date.now()-t;!Number.isFinite(e)||e<0||self.postMessage({type:"latency",media:"audio",ms:e})}})();
