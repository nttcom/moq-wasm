(function(){"use strict";function A(e){if(e.byteLength<4)throw new Error("Payload too small to contain metadata");const r=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(0),o=4+r;if(e.byteLength<o)throw new Error("Payload too small to contain metadata");const n=e.slice(4,4+r),i=JSON.parse(new TextDecoder().decode(n)),a=e.slice(4+r);return{metadata:i,data:a}}function S(e){try{return A(e)}catch{return null}}function T(e){if(!e)return{};const t={};for(const r of e.extensions)switch(r.type){case"captureTimestamp":t.captureTimestampMicros=r.value.microsSinceUnixEpoch;break;case"videoConfig":t.videoConfig=r.value.data;break;case"videoFrameMarking":t.videoFrameMarking=r.value.data;break;case"audioLevel":t.audioLevel=r.value.level;break}return t}function _(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return btoa(t)}const B=1e3;function j(){return Math.round((performance.timeOrigin+performance.now())*B)}function g(e){return(j()-e)/B}const x=250,O=5,v=9e3,G=3,N=20;class k{constructor(t=v,r="fast",o){this.maxBufferSize=t,this.mode=r,this.keyframeInterval=typeof o=="number"?BigInt(o):o??void 0}buffer=[];minDelayMs=x;lastPoppedGroupId=null;lastPoppedObjectId=null;keyframeInterval;lastPopWallTime=null;pendingEndGroupTail=new Map;bufferedAheadFrames=O;setMinDelay(t){t<0||(this.minDelayMs=t)}setBufferedAheadFrames(t){!Number.isFinite(t)||t<=0||(this.bufferedAheadFrames=Math.max(1,Math.floor(t)))}push(t,r,o,n){if(!o.objectPayloadLength)return!1;const i=T(o.locHeader),a=P(i.captureTimestampMicros),s=S(o.objectPayload);if(!s){const D=o.locHeader,b=D?.extensions??[];if(!D||b.length===0)console.debug("[VideoJitterBuffer] Missing metadata and LOC header",{groupId:t,objectId:r,payloadLength:o.objectPayloadLength});else{const ue=b.some(E=>E.type==="captureTimestamp"),fe=b.some(E=>E.type==="videoConfig");console.debug("[VideoJitterBuffer] Using LOC header fallback",{groupId:t,objectId:r,payloadLength:o.objectPayloadLength,locExtensionCount:b.length,hasCaptureTimestamp:ue,hasVideoConfig:fe})}}const f=s??R(o,r);if(!f)return console.debug("[VideoJitterBuffer] Failed to build chunk from payload",{groupId:t,objectId:r,payloadLength:o.objectPayloadLength}),!1;const m=o;if(m.cachedChunk=f,m.remotePTS=f.metadata.timestamp,m.localPTS=performance.timeOrigin+performance.now(),typeof a=="number"&&n?.(g(a)),this.mode==="correctly"&&this.shouldRejectOldData(t,r))return console.warn(`[VideoJitterBuffer] Rejecting old data. Expected: (group:${this.lastPoppedGroupId}, object:${this.lastPoppedObjectId}), Got: (group:${t}, object:${r})`),!1;const se={groupId:t,objectId:r,bufferInsertTimestamp:performance.now(),captureTimestampMicros:a,object:m,isEndOfGroup:o.objectStatus===G},de=this.findInsertPos(t,r);return this.buffer.splice(de,0,se),this.buffer.length>this.maxBufferSize&&(console.warn("[VideoJitterBuffer] Buffer full, dropping oldest entry"),this.buffer.shift()),!0}pop(){return this.popWithMetadata()}popWithMetadata(){return this.buffer.length===0?null:this.mode==="buffered"?this.popBufferedMode():this.mode==="fast"?this.popFastMode():this.mode==="normal"?this.popNormalMode():this.popCorrectlyMode()}popBufferedMode(){for(;;){if(this.buffer.length===0)return null;const t=this.buffer[0].groupId;if(this.buffer.some(n=>n.groupId>=t+2n)){for(;this.buffer.length>0&&this.buffer[0].groupId===t;)this.buffer.shift();continue}if(this.buffer.length<=this.bufferedAheadFrames)return null;const o=this.buffer.shift();return o?(this.recordPopResult(o,Date.now()),o):null}}popFastMode(){if(this.buffer.length===0)return null;const t=this.buffer[0].groupId;if(this.buffer.some(n=>n.groupId>t))for(;this.buffer.length>0&&this.buffer[0].groupId===t;)this.buffer.shift();const o=this.buffer.shift();return o?(this.recordPopResult(o,Date.now()),o):null}popNormalMode(){const t=this.buffer[0],r=Date.now();return this.computeDelayMs(t)<this.minDelayMs?null:(this.buffer.shift(),this.recordPopResult(t,r),t)}popCorrectlyMode(){const t=this.getExpectedNextEntry();let r=this.buffer.findIndex(s=>s.groupId===t.groupId&&s.objectId===t.objectId);if(r===-1&&(r=this.findResyncIndex(),r===-1)){if(this.lastPoppedGroupId===null&&this.buffer.length>0){const s=this.buffer.slice(0,5).map(f=>`(g:${f.groupId}, o:${f.objectId})`);console.warn(`[VideoJitterBuffer] Expected first entry not found. Expected: (g:${t.groupId}, o:${t.objectId}), Buffer: [${s.join(", ")}]`)}return null}const o=this.buffer[r],n=Date.now(),i=this.computeDelayMs(o),a=this.lastPopWallTime===null?Number.POSITIVE_INFINITY:n-this.lastPopWallTime;return i<this.minDelayMs||a<N?null:(this.buffer.splice(r,1),this.recordPopResult(o,n),o)}shouldRejectOldData(t,r){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?!1:t<this.lastPoppedGroupId||t===this.lastPoppedGroupId&&r<=this.lastPoppedObjectId}recordPopResult(t,r){this.lastPopWallTime=r,this.lastPoppedGroupId=t.groupId,this.lastPoppedObjectId=t.objectId,t.isEndOfGroup&&this.pendingEndGroupTail.set(t.groupId,t.objectId)}getExpectedNextEntry(){if(this.lastPoppedGroupId===null||this.lastPoppedObjectId===null)return{groupId:0n,objectId:0n};const t=this.pendingEndGroupTail.get(this.lastPoppedGroupId);return t!==void 0&&this.lastPoppedObjectId>=t?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:this.keyframeInterval!==void 0&&this.lastPoppedObjectId===this.keyframeInterval-1n?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:{groupId:this.lastPoppedGroupId,objectId:this.lastPoppedObjectId+1n}}findInsertPos(t,r){for(let o=this.buffer.length-1;o>=0;o--){const n=this.buffer[o];if(n.groupId===t&&n.objectId<r||n.groupId<t)return o+1}return 0}findResyncIndex(){return this.buffer.length===0?-1:this.lastPoppedGroupId===null?0:this.buffer.findIndex(t=>t.objectId===0n&&t.groupId>this.lastPoppedGroupId)}computeDelayMs(t){return typeof t.captureTimestampMicros=="number"?g(t.captureTimestampMicros):performance.now()-t.bufferInsertTimestamp}getBufferedFrameCount(){return this.buffer.length}getMaxBufferSize(){return this.maxBufferSize}}function R(e,t){const r=T(e.locHeader),o=P(r.captureTimestampMicros);return{metadata:{type:t===0n?"key":"delta",timestamp:typeof o=="number"?o:0,duration:null,descriptionBase64:r.videoConfig?_(r.videoConfig):void 0},data:e.objectPayload}}function P(e){if(!(typeof e!="number"||!Number.isFinite(e)||e<0))return e}const V=300;function z(e,t=1e3){let r=0,o=performance.now();return{addBytes(n){r+=n;const i=performance.now();if(i-o>=t){const a=r*8/1e3;e(a),r=0,o=i}}}}const J=z(e=>{self.postMessage({type:"bitrate",kbps:e})}),U=BigInt(V),H={hardwareAcceleration:"prefer-hardware",scalabilityMode:"L1T1"};let c,h=!0,u=null;async function W(e){function t(n){self.postMessage({type:"frame",frame:n,width:n.displayWidth,height:n.displayHeight}),n.close()}const r={output:t,error:n=>{console.warn("[videoDecoder] decoder error",n),c=void 0,d=null}},o=new VideoDecoder(r);return o.configure(e),o}const Y=33,l={maxBufferSize:9e3,mode:"fast",minDelayMs:250,bufferedAheadFrames:5};let p=L(),y={...l};function F(e){const t=e?.mode??l.mode,r=typeof e?.minDelayMs=="number"&&Number.isFinite(e.minDelayMs)&&e.minDelayMs>=0?e.minDelayMs:l.minDelayMs,o=typeof e?.maxBufferSize=="number"&&Number.isFinite(e.maxBufferSize)&&e.maxBufferSize>0?Math.floor(e.maxBufferSize):l.maxBufferSize,n=typeof e?.bufferedAheadFrames=="number"&&Number.isFinite(e.bufferedAheadFrames)&&e.bufferedAheadFrames>0?Math.floor(e.bufferedAheadFrames):l.bufferedAheadFrames;return{mode:t,minDelayMs:r,maxBufferSize:o,bufferedAheadFrames:n}}function L(e){const t=F(e),r=new k(t.maxBufferSize,t.mode,U);return r.setMinDelay(t.minDelayMs),r.setBufferedAheadFrames(t.bufferedAheadFrames),r}function $(e){y=F({...y,...e}),p=L(y)}let d=null,I=null,M=!1;setInterval(()=>{const e=p.popWithMetadata();if(e){if(w("pop"),e.isEndOfGroup)return;Z(e.groupId,e.object,e.captureTimestampMicros)}},Y);function K(e){return e.type==="config"}function q(e){return e.type==="catalog"}self.onmessage=async e=>{if(K(e.data)){$(e.data.config);return}if(q(e.data)){ne(e.data.codec);return}const t={objectId:e.data.subgroupStreamObject.objectId,objectPayloadLength:e.data.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(e.data.subgroupStreamObject.objectPayload),objectStatus:e.data.subgroupStreamObject.objectStatus,locHeader:e.data.subgroupStreamObject.locHeader};J.addBytes(t.objectPayloadLength),p.push(e.data.groupId,t.objectId,t,o=>te(o))&&w("push")};async function Z(e,t,r){const o=t.cachedChunk;Q(o.metadata.type),X(r);const n=ie(o.metadata);if(!n)return;const i=ae(n),a=new EncodedVideoChunk({type:o.metadata.type,timestamp:o.metadata.timestamp,duration:o.metadata.duration??void 0,data:o.data});if(!((!c||c.state==="closed")&&(c=await W(i),d=n,oe(n,i),h=!0,o.metadata.type!=="key"))&&!(h&&o.metadata.type!=="key"))try{await c.decode(a),o.metadata.type==="key"&&(h=!1)}catch(s){if(ee(s)){h=!0,console.warn("[videoDecoder] decode requires key frame; waiting for next key frame",{groupId:e.toString(),objectId:t.objectId.toString(),chunkType:o.metadata.type});return}throw s}}function Q(e){u!==null&&(u+=1),e==="key"&&(typeof u=="number"&&u>0&&self.postMessage({type:"keyframeInterval",media:"video",frames:u}),u=0)}function X(e){if(typeof e!="number")return;const t=g(e);t<0||re(t)}function ee(e){return e instanceof DOMException?e.name==="DataError"&&e.message.includes("A key frame is required"):!1}function te(e){e<0||self.postMessage({type:"receiveLatency",media:"video",ms:e})}function re(e){e<0||self.postMessage({type:"renderingLatency",media:"video",ms:e})}function w(e){self.postMessage({type:"jitterBufferActivity",media:"video",event:e,bufferedFrames:p.getBufferedFrameCount(),capacityFrames:p.getMaxBufferSize()})}function oe(e,t){const r=t.description instanceof Uint8Array?t.description.byteLength:void 0;self.postMessage({type:"decoderConfig",codec:e.codec,descriptionLength:r})}function ne(e){e&&I!==e&&(I=e,d&&d.codec!==e&&console.warn("[videoDecoder] catalog codec changed after decoder initialization; ignoring new codec",{initializedCodec:d.codec,catalogCodec:e}))}function ie(e){if(d)return d;const t=e.codec??I??void 0;return t?(M=!1,{codec:t,descriptionBase64:e.descriptionBase64,avcFormat:e.avcFormat}):(M||(M=!0,console.warn("[videoDecoder] skip decode until catalog codec is available")),null)}function ae(e){if(e.codec.startsWith("avc")){const t=e.descriptionBase64?C(e.descriptionBase64):void 0;return{...H,codec:e.codec,description:t,avc:{format:e.avcFormat??"avc"}}}return{codec:e.codec,description:e.descriptionBase64?C(e.descriptionBase64):void 0}}function C(e){const t=atob(e),r=t.length,o=new Uint8Array(r);for(let n=0;n<r;n++)o[n]=t.charCodeAt(n);return o}})();
