function l(i){const e=[];return typeof i.captureTimestampMicros=="number"&&e.push({type:"captureTimestamp",value:{microsSinceUnixEpoch:i.captureTimestampMicros}}),i.videoConfig&&e.push({type:"videoConfig",value:{data:i.videoConfig}}),i.videoFrameMarking&&e.push({type:"videoFrameMarking",value:{data:i.videoFrameMarking}}),typeof i.audioLevel=="number"&&e.push({type:"audioLevel",value:{level:i.audioLevel}}),{extensions:e}}function I(i){if(i)return new Uint8Array(i)}const y=1e3;function v(){return Math.round((performance.timeOrigin+performance.now())*y)}function C(i){if(typeof i=="bigint")return i;try{return BigInt(i)}catch{throw new Error(`Invalid alias value: ${i}`)}}function a(i){return C(i).toString()}class V{video={groupId:-1n,objectId:0n,subgroups:new Map([[0,{sentAliases:new Set}]])};audio={groupId:0n,objectId:0n,subgroups:new Map([[0,{sentAliases:new Set}]])};audioCodecSent=new Set;videoCodecSent=new Set;ensureVideoSubgroup(e){this.ensureSubgroup(this.video,e)}ensureAudioSubgroup(e){this.ensureSubgroup(this.audio,e)}advanceVideoGroup(){this.video.groupId+=1n,this.video.objectId=0n,this.resetHeaders(this.video)}getVideoGroupId(){return this.video.groupId}getVideoObjectId(){return this.video.objectId}incrementVideoObject(){this.video.objectId+=1n}hasVideoHeaderSent(e,o){return this.hasHeaderSent(this.video,e,o)}markVideoHeaderSent(e,o){this.markHeaderSent(this.video,e,o)}getAudioGroupId(){return this.audio.groupId}advanceAudioGroup(){this.audio.groupId+=1n,this.audio.objectId=0n,this.resetHeaders(this.audio)}getAudioObjectId(){return this.audio.objectId}incrementAudioObject(){this.audio.objectId+=1n}shouldSendAudioHeader(e,o){return!this.hasHeaderSent(this.audio,e,o)}markAudioHeaderSent(e,o){this.markHeaderSent(this.audio,e,o)}shouldSendAudioCodec(e){return!this.audioCodecSent.has(a(e))}markAudioCodecSent(e){this.audioCodecSent.add(a(e))}listVideoSubgroups(){return Array.from(this.video.subgroups.keys())}shouldSendVideoCodec(e){return!this.videoCodecSent.has(a(e))}markVideoCodecSent(e){this.videoCodecSent.add(a(e))}resetAlias(e){const o=a(e);for(const d of this.video.subgroups.values())d.sentAliases.delete(o);for(const d of this.audio.subgroups.values())d.sentAliases.delete(o);this.audioCodecSent.delete(o),this.videoCodecSent.delete(o)}ensureSubgroup(e,o){e.subgroups.has(o)||e.subgroups.set(o,{sentAliases:new Set})}resetHeaders(e){for(const o of e.subgroups.values())o.sentAliases.clear()}hasHeaderSent(e,o,d){return this.ensureSubgroup(e,d),e.subgroups.get(d).sentAliases.has(a(o))}markHeaderSent(e,o,d){this.ensureSubgroup(e,d),e.subgroups.get(d).sentAliases.add(a(o))}}async function A({chunk:i,metadata:e,captureTimestampMicros:o,trackAliases:d,publisherPriority:c,client:n,transportState:u,sender:g}){if(!d.length)return;const r=Number(e?.svc?.temporalLayerId??0);u.ensureVideoSubgroup(r);const h=d.some(s=>u.shouldSendVideoCodec(s)),t=e?.decoderConfig,p=I(t?.description),f=i.type==="key"||h,S=typeof o=="number"&&Number.isFinite(o)?Math.round(o):v(),m=l({captureTimestampMicros:S,videoConfig:f?p:void 0});if(i.type==="key"){u.advanceVideoGroup();for(const s of d)for(const b of u.listVideoSubgroups())await n.sendSubgroupStreamHeaderMessage(s,u.getVideoGroupId(),BigInt(b),c),u.markVideoHeaderSent(s,b)}else for(const s of d)u.hasVideoHeaderSent(s,r)||(await n.sendSubgroupStreamHeaderMessage(s,u.getVideoGroupId(),BigInt(r),c),u.markVideoHeaderSent(s,r));for(const s of d)await g(s,u.getVideoGroupId(),BigInt(r),u.getVideoObjectId(),i,n,m),f&&p&&u.markVideoCodecSent(s);u.incrementVideoObject()}async function H({chunk:i,metadata:e,captureTimestampMicros:o,trackAliases:d,client:c,transportState:n}){if(!d.length)return;const u=0;n.ensureAudioSubgroup(u);for(const t of d)n.shouldSendAudioHeader(t,u)&&(await c.sendSubgroupStreamHeaderMessage(t,n.getAudioGroupId(),BigInt(u),0),n.markAudioHeaderSent(t,u));const g=new Uint8Array(i.byteLength);i.copyTo(g);const r=typeof o=="number"&&Number.isFinite(o)?Math.round(o):v(),h=l({captureTimestampMicros:r});for(const t of d)await c.sendSubgroupStreamObject(t,n.getAudioGroupId(),BigInt(u),n.getAudioObjectId(),void 0,g,h);n.incrementAudioObject()}export{V as M,H as a,A as s};
