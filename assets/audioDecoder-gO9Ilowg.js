(function(){"use strict";function h(e){if(e.byteLength<4)throw new Error("Payload too small to contain metadata");const n=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(0),o=4+n;if(e.byteLength<o)throw new Error("Payload too small to contain metadata");const a=e.slice(4,4+n),r=JSON.parse(new TextDecoder().decode(a)),s=e.slice(4+n);return{metadata:r,data:s}}function b(e){try{return h(e)}catch{return null}}function g(e){if(!e)return{};const t={};for(const n of e.extensions)switch(n.type){case"captureTimestamp":t.captureTimestampMicros=n.value.microsSinceUnixEpoch;break;case"videoConfig":t.videoConfig=n.value.data;break;case"videoFrameMarking":t.videoFrameMarking=n.value.data;break;case"audioLevel":t.audioLevel=n.value.level;break}return t}const y=1800;class T{constructor(t=y,n="ordered"){this.maxBufferSize=t,this.mode=n}buffer=[];hasPoppedOnce=!1;mode="ordered";setMode(t){this.mode=t}push(t,n,o,a){if(!o.objectPayloadLength)return;const r=b(o.objectPayload);if(!r){const p=o.locHeader,l=p?.extensions??[];if(!p||l.length===0)console.debug("[AudioJitterBuffer] Missing metadata and LOC header",{groupId:t,objectId:n,payloadLength:o.objectPayloadLength});else{const F=l.some(U=>U.type==="captureTimestamp");console.debug("[AudioJitterBuffer] Using LOC header fallback",{groupId:t,objectId:n,payloadLength:o.objectPayloadLength,locExtensionCount:l.length,hasCaptureTimestamp:F})}}const s=r??L(o);if(!s){console.debug("[AudioJitterBuffer] Failed to build chunk from payload",{groupId:t,objectId:n,payloadLength:o.objectPayloadLength});return}const d=o;d.cachedChunk=s,d.remotePTS=s.metadata.timestamp,d.localPTS=performance.timeOrigin+performance.now(),a?.(Date.now()-s.metadata.sentAt);const H=performance.now(),N={groupId:t,objectId:n,bufferInsertTimestamp:H,sentAt:s.metadata.sentAt,object:d},v=this.findInsertPos(t,n);this.buffer.splice(v,0,N),this.buffer.length>this.maxBufferSize&&(console.warn("[AudioJitterBuffer] Buffer full, dropping oldest entry"),this.buffer.shift())}pop(){return this.popWithMetadata()}popWithMetadata(){if(this.buffer.length===0)return null;if(this.mode==="latest"){const n=this.buffer.pop();return this.buffer.length=0,n??null}if(!this.hasPoppedOnce){const n=this.buffer.pop();return this.hasPoppedOnce=!0,n??null}const t=this.buffer[0];return this.buffer.shift(),t}findInsertPos(t,n){for(let o=this.buffer.length-1;o>=0;o--){const a=this.buffer[o];if(a.groupId===t&&a.objectId<n||a.groupId<t)return o+1}return 0}}function L(e){const n=g(e.locHeader).captureTimestampMicros,o=typeof n=="number"?Math.floor(n/1e3):Date.now();return{metadata:{type:"key",timestamp:typeof n=="number"?n:0,duration:null,sentAt:o},data:e.objectPayload}}function A(e,t=1e3){let n=0,o=performance.now();return{addBytes(a){n+=a;const r=performance.now();if(r-o>=t){const s=n*8/1e3;e(s),n=0,o=r}}}}const E=A(e=>{self.postMessage({type:"bitrate",media:"audio",kbps:e})}),c={codec:"opus",sampleRate:48e3,numberOfChannels:1};let i,B=null,m=null,u=null;async function w(e,t){function n(r){self.postMessage({type:"audioData",audioData:r}),r.close()}const o={output:n,error:r=>{console.warn("[audioDecoder] decoder error",r)}},a=new AudioDecoder(o);return a.configure(e),m=t,a}const C=5,f=new T(1800,"ordered");setInterval(()=>{const e=f.pop();if(!e)return;const t=e?.object;t&&S(t)},C),self.onmessage=async e=>{if(e.data.type==="config"){const o=e.data.config;(o.mode==="ordered"||o.mode==="latest")&&f.setMode(o.mode);return}const t=e.data,n={objectId:t.subgroupStreamObject.objectId,objectPayloadLength:t.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(t.subgroupStreamObject.objectPayload),objectStatus:t.subgroupStreamObject.objectStatus,locHeader:t.subgroupStreamObject.locHeader};E.addBytes(n.objectPayloadLength),f.push(t.groupId,n.objectId,n,o=>M(o))};async function S(e){const t=e.cachedChunk;O(t.metadata.sentAt);const n=R(t.metadata);if(!n)return;const o=D(n),a=k(n);if(!i||i.state==="closed"||m!==a)try{i&&i.state!=="closed"&&i.close(),i=await w(o,a),B=null,u=n}catch(d){console.error("[audioDecoder] configure failed",d);return}const r=_(t.metadata.timestamp),s=new EncodedAudioChunk({type:t.metadata.type,timestamp:r,duration:t.metadata.duration??void 0,data:t.data});await i.decode(s)}function O(e){P(Date.now()-e)}function M(e){e<0||self.postMessage({type:"receiveLatency",media:"audio",ms:e})}function P(e){e<0||self.postMessage({type:"renderingLatency",media:"audio",ms:e})}function _(e){return 0}function R(e){if(!(e.codec||e.descriptionBase64||e.sampleRate||e.channels)&&!u)return{codec:c.codec,sampleRate:c.sampleRate,channels:c.numberOfChannels};const n=e.codec??(e.descriptionBase64?"mp4a.40.2":void 0)??u?.codec??c.codec,o=e.sampleRate??u?.sampleRate??c.sampleRate,a=e.channels??u?.channels??c.numberOfChannels,r=e.descriptionBase64??u?.descriptionBase64;return{codec:n,sampleRate:o,channels:a,descriptionBase64:r}}function D(e){if(e.codec.startsWith("mp4a")){const t=e.descriptionBase64?j(e.descriptionBase64):void 0;return{codec:e.codec,sampleRate:e.sampleRate,numberOfChannels:e.channels,description:t}}return{codec:c.codec,sampleRate:e.sampleRate,numberOfChannels:e.channels}}function j(e){const t=atob(e),n=t.length,o=new Uint8Array(n);for(let a=0;a<n;a++)o[a]=t.charCodeAt(a);return o}function k(e){const t=e.descriptionBase64??"";return`${e.codec}:${e.sampleRate}:${e.channels}:${t}`}})();
