import{M as T}from"./moqtClient-bBn0xwEM.js";/* empty css              */import{s as O,a as L,M as C}from"./audioTransport-BIv6jwQk.js";import{M as E,a as N,b as j,c as A}from"./catalog-BYlufEzj.js";const B="secret";function P(e,t=1e3){let n=0,a=performance.now();return{addBytes(o){n+=o;const i=performance.now();if(i-a>=t){const r=n*8/1e6;console.log(`${e}: ${r.toFixed(2)} Mbps`),n=0,a=i}}}}const U=P("chunkData bitrate"),v=new Map;async function H(e,t,n,a,o,i,r){console.debug("[MediaPublisher] sendVideoObjectMessage",{trackAlias:e.toString(),groupId:t.toString(),subgroupId:n.toString(),objectId:a.toString(),byteLength:o.byteLength});const s=v.get(e);if(s&&s.groupId!==t){const d=s.lastObjectId+1n;await i.sendSubgroupStreamObject(e,s.groupId,0n,d,3,new Uint8Array(0),void 0),console.log(`[MediaPublisher] Sent EndOfGroup trackAlias=${e} groupId=${s.groupId} subgroupId=0 objectId=${d}`)}U.addBytes(o.byteLength);const c=new Uint8Array(o.byteLength);o.copyTo(c),await i.sendSubgroupStreamObject(BigInt(e),t,n,a,void 0,c,r),v.set(e,{groupId:t,lastObjectId:a})}const g=()=>document.getElementById("form"),V=300;let b=null;const u=new T,I=new C,k=new Set;function M(){const e=u.getRawClient();if(!e)throw new Error("MOQT client not connected");return e}function D(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const t={audio:!0,video:{width:{exact:1920},height:{exact:1080}}};b=await navigator.mediaDevices.getUserMedia(t);const n=document.getElementById("video");n.srcObject=b})}const S=new Worker(new URL("/moq-wasm/assets/videoEncoder-JVMrb9wg.js",import.meta.url),{type:"module"}),h=E.map(e=>({bitrate:e.bitrate,trackName:e.trackName,worker:new Worker(new URL("/moq-wasm/assets/audioEncoder-CobdGwD1.js",import.meta.url),{type:"module"})}));function y(e){return e.split("/").map(t=>t.trim()).filter(t=>t.length>0)}function R(e){return Array.from(e["forwarding-preference"]).filter(t=>t.checked)[0].value}function _(e){return e===N}function G(e){return A.some(t=>t.trackName===e)}function q(e){return E.some(t=>t.trackName===e)}function x(e,t){const n=new Set;for(const a of A)for(const o of e.getTrackSubscribers(t,a.trackName))n.add(o.toString());return Array.from(n,a=>BigInt(a))}function F(e,t,n){return Array.from(e.getTrackSubscribers(t,n),a=>BigInt(a))}async function $(e,t,n){const a=t.toString();if(k.has(a))return;const o=new TextEncoder().encode(j(n));await e.sendSubgroupStreamHeaderMessage(t,0n,0n,0),await e.sendSubgroupStreamObject(t,0n,0n,0n,void 0,o,void 0),k.add(a),console.info("[MediaPublisher] sent catalog",{trackAlias:a,trackNamespace:n})}function W(){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const t=g(),n=new BigUint64Array("0xff00000A".split(",").map(BigInt)),a=BigInt(t["max-subscribe-id"].value);await u.sendSetupMessage(n,a)})}function K(){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const t=g(),n=y(t["announce-track-namespace"].value);await u.announce(n,B)})}function J(){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(console.log("clicked sendSubgroupObjectBtn"),b==null){console.error("mediaStream is null");return}let t;try{t=M()}catch(r){console.error(r);return}S.onmessage=async r=>{const s=r.data;if(s.type!=="chunk")return;const{chunk:c,metadata:d,captureTimestampMicros:l}=s;console.debug("[MediaPublisher] video chunk",{byteLength:c.byteLength,type:c.type,timestamp:c.timestamp});const m=g(),p=y(m["announce-track-namespace"].value),w=Number(m["video-publisher-priority"].value),f=x(t,p);f.length&&await O({chunk:c,metadata:d,captureTimestampMicros:l,trackAliases:f,publisherPriority:w,client:t,transportState:I,sender:H})};for(const r of h)r.worker.onmessage=async s=>{const c=s.data;if(c.type!=="chunk")return;const{chunk:d,metadata:l,captureTimestampMicros:m}=c,p=g(),w=y(p["announce-track-namespace"].value),f=F(t,w,r.trackName);f.length&&await L({chunk:d,metadata:l,captureTimestampMicros:m,trackAliases:f,client:t,transportState:I})};const[n]=b.getVideoTracks(),o=new MediaStreamTrackProcessor({track:n}).readable;S.postMessage({type:"keyframeInterval",keyframeInterval:V}),S.postMessage({type:"videoStream",videoStream:o},[o]);const[i]=b.getAudioTracks();h.forEach((r,s)=>{r.worker.postMessage({type:"config",config:{bitrate:r.bitrate}});const c=s===0?i:i.clone(),l=new MediaStreamTrackProcessor({track:c}).readable;r.worker.postMessage({type:"audioStream",audioStream:l},[l])})})}function Q(){W(),K(),J()}function Y(){u.setOnServerSetupHandler(e=>{console.log({serverSetup:e})}),u.setOnAnnounceHandler(async e=>{console.log({announceMessage:e}),await M().sendAnnounceOkMessage(e.trackNamespace)}),u.setOnSubscribeResponseHandler(e=>{console.log({announceResponseMessage:e})}),u.setOnIncomingSubscribeHandler(async({subscribe:e,isSuccess:t,code:n,respondOk:a,respondError:o})=>{console.log({subscribeMessage:e});const i=g(),r=R(i),s=y(i["announce-track-namespace"].value),c=e.trackNamespace??[],d=e.trackName??"",l=c.join("/")===s.join("/");if(t){if(!l){await o(404n,"unknown namespace");return}if(_(d)){await a(0n,B,"subgroup");const p=M();await $(p,BigInt(e.trackAlias),s);return}if(G(d)||q(d)){await a(0n,B,r);return}await o(404n,"unknown track");return}const m=`subscribe error: code=${n}`;await o(BigInt(n),m)})}function z(){document.getElementById("closeBtn").addEventListener("click",async()=>{await u.disconnect(),k.clear()})}D();Y();z();const X=document.getElementById("connectBtn");X.addEventListener("click",async()=>{const t=g().url.value;await u.connect(t,{sendSetup:!1}),k.clear(),Q()});
