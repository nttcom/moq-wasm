function f(i){const e=[];return typeof i.captureTimestampMicros=="number"&&e.push({type:"captureTimestamp",value:{microsSinceUnixEpoch:i.captureTimestampMicros}}),i.videoConfig&&e.push({type:"videoConfig",value:{data:i.videoConfig}}),i.videoFrameMarking&&e.push({type:"videoFrameMarking",value:{data:i.videoFrameMarking}}),typeof i.audioLevel=="number"&&e.push({type:"audioLevel",value:{level:i.audioLevel}}),{extensions:e}}function v(i){if(i)return new Uint8Array(i)}function S(i){if(typeof i=="bigint")return i;try{return BigInt(i)}catch{throw new Error(`Invalid alias value: ${i}`)}}function a(i){return S(i).toString()}class m{video={groupId:-1n,objectId:0n,subgroups:new Map([[0,{sentAliases:new Set}]])};audio={groupId:0n,objectId:0n,subgroups:new Map([[0,{sentAliases:new Set}]])};audioCodecSent=new Set;videoCodecSent=new Set;ensureVideoSubgroup(e){this.ensureSubgroup(this.video,e)}ensureAudioSubgroup(e){this.ensureSubgroup(this.audio,e)}advanceVideoGroup(){this.video.groupId+=1n,this.video.objectId=0n,this.resetHeaders(this.video)}getVideoGroupId(){return this.video.groupId}getVideoObjectId(){return this.video.objectId}incrementVideoObject(){this.video.objectId+=1n}hasVideoHeaderSent(e,o){return this.hasHeaderSent(this.video,e,o)}markVideoHeaderSent(e,o){this.markHeaderSent(this.video,e,o)}getAudioGroupId(){return this.audio.groupId}getAudioObjectId(){return this.audio.objectId}incrementAudioObject(){this.audio.objectId+=1n}shouldSendAudioHeader(e,o){return!this.hasHeaderSent(this.audio,e,o)}markAudioHeaderSent(e,o){this.markHeaderSent(this.audio,e,o)}shouldSendAudioCodec(e){return!this.audioCodecSent.has(a(e))}markAudioCodecSent(e){this.audioCodecSent.add(a(e))}listVideoSubgroups(){return Array.from(this.video.subgroups.keys())}shouldSendVideoCodec(e){return!this.videoCodecSent.has(a(e))}markVideoCodecSent(e){this.videoCodecSent.add(a(e))}resetAlias(e){const o=a(e);for(const u of this.video.subgroups.values())u.sentAliases.delete(o);for(const u of this.audio.subgroups.values())u.sentAliases.delete(o);this.audioCodecSent.delete(o),this.videoCodecSent.delete(o)}ensureSubgroup(e,o){e.subgroups.has(o)||e.subgroups.set(o,{sentAliases:new Set})}resetHeaders(e){for(const o of e.subgroups.values())o.sentAliases.clear()}hasHeaderSent(e,o,u){return this.ensureSubgroup(e,u),e.subgroups.get(u).sentAliases.has(a(o))}markHeaderSent(e,o,u){this.ensureSubgroup(e,u),e.subgroups.get(u).sentAliases.add(a(o))}}async function I({chunk:i,metadata:e,trackAliases:o,publisherPriority:u,client:s,transportState:d,sender:c}){if(!o.length)return;const r=Number(e?.svc?.temporalLayerId??0);d.ensureVideoSubgroup(r);const t=o.some(n=>d.shouldSendVideoCodec(n)),b=e?.decoderConfig,g=v(b?.description),h=i.type==="key"||t,l=f({captureTimestampMicros:Date.now()*1e3,videoConfig:h?g:void 0});if(i.type==="key"){d.advanceVideoGroup();for(const n of o)for(const p of d.listVideoSubgroups())await s.sendSubgroupStreamHeaderMessage(n,d.getVideoGroupId(),BigInt(p),u),d.markVideoHeaderSent(n,p)}else for(const n of o)d.hasVideoHeaderSent(n,r)||(await s.sendSubgroupStreamHeaderMessage(n,d.getVideoGroupId(),BigInt(r),u),d.markVideoHeaderSent(n,r));for(const n of o)await c(n,d.getVideoGroupId(),BigInt(r),d.getVideoObjectId(),i,s,l),h&&g&&d.markVideoCodecSent(n);d.incrementVideoObject()}async function V({chunk:i,metadata:e,trackAliases:o,client:u,transportState:s}){if(!o.length)return;const d=0;s.ensureAudioSubgroup(d);for(const t of o)s.shouldSendAudioHeader(t,d)&&(await u.sendSubgroupStreamHeaderMessage(t,s.getAudioGroupId(),BigInt(d),0),s.markAudioHeaderSent(t,d));const c=new Uint8Array(i.byteLength);i.copyTo(c);const r=f({captureTimestampMicros:Date.now()*1e3});for(const t of o)await u.sendSubgroupStreamObject(t,s.getAudioGroupId(),BigInt(d),s.getAudioObjectId(),void 0,c,r);s.incrementAudioObject()}const y=300;export{y as K,m as M,V as a,I as s};
