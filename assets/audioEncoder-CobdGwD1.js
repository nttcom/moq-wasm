(function(){"use strict";function c(e,o=1e3){let t=0,i=performance.now();return{addBytes(d){t+=d;const u=performance.now();if(u-i>=o){const b=t*8/1e3;e(b),t=0,i=u}}}}const f=1e3;function p(){return Math.round((performance.timeOrigin+performance.now())*f)}let r,a=null,n={codec:"opus",sampleRate:48e3,numberOfChannels:1,bitrate:64e3};const s=new Map,l=c(e=>{self.postMessage({type:"bitrate",media:"audio",kbps:e})});function m(e,o){l.addBytes(e.byteLength),console.debug("sendAudioChunkMessage",e,o),a===null&&(a=e.timestamp,console.info("[audioEncoder] Set timestamp offset:",a));const t=e.timestamp-a,i=new ArrayBuffer(e.byteLength);e.copyTo(i);const d=new EncodedAudioChunk({type:e.type,timestamp:t,duration:e.duration??void 0,data:i}),u=E(e.timestamp);self.postMessage({type:"chunk",chunk:d,metadata:o,captureTimestampMicros:u})}async function g(){const e={output:m,error:t=>{console.log(t.message)}},o=new AudioEncoder(e);try{if(!(await AudioEncoder.isConfigSupported(n)).supported){self.postMessage({type:"configError",media:"audio",reason:"unsupported",config:n});return}}catch{self.postMessage({type:"configError",media:"audio",reason:"unsupported",config:n});return}return o.configure(n),console.info("[audioEncoder] initialized",n),o}async function y(e){if(a=null,s.clear(),r||(r=await g()),!r)return;const o=e.getReader();for(;;){const t=await o.read();if(t.done)break;const i=t.value;M(i.timestamp,p()),r.encode(i),i.close()}}function M(e,o){if(Number.isFinite(e)&&(s.set(e,o),s.size>1024)){const t=s.keys().next().value;typeof t=="number"&&s.delete(t)}}function E(e){if(!Number.isFinite(e))return;const o=s.get(e);if(o!==void 0)return s.delete(e),o}self.onmessage=async e=>{if(e.data.type==="config"){const t=e.data.config;if(n={...n,...t},r&&r.state!=="closed")try{if(!(await AudioEncoder.isConfigSupported(n)).supported){self.postMessage({type:"configError",media:"audio",reason:"unsupported",config:n});return}r.configure(n),console.info("[audioEncoder] reconfigured",n)}catch{self.postMessage({type:"configError",media:"audio",reason:"unsupported",config:n});return}return}const o=e.data.audioStream;if(!o){console.error("MediaStreamTrack が渡されていません");return}await y(o)}})();
