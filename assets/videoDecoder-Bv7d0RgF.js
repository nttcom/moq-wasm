(function(){"use strict";function G(e){if(e.byteLength<4)throw new Error("Payload too small to contain metadata");const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(0),n=4+o;if(e.byteLength<n)throw new Error("Payload too small to contain metadata");const r=e.slice(4,4+o),i=JSON.parse(new TextDecoder().decode(r)),a=e.slice(4+o);return{metadata:i,data:a}}const L=250,_=5,N=9e3,v=3,R=20;class ${constructor(t=N,o="fast",n){this.maxBufferSize=t,this.mode=o,this.keyframeInterval=typeof n=="number"?BigInt(n):n??void 0}buffer=[];minDelayMs=L;lastPoppedGroupId=null;lastPoppedObjectId=null;keyframeInterval;lastPopWallTime=null;pendingEndGroupTail=new Map;bufferedAheadFrames=_;setMinDelay(t){t<0||(this.minDelayMs=t)}setBufferedAheadFrames(t){!Number.isFinite(t)||t<=0||(this.bufferedAheadFrames=Math.max(1,Math.floor(t)))}push(t,o,n,r){if(!n.objectPayloadLength)return;const i=G(n.objectPayload);if(!i)return;const a=n;if(a.cachedChunk=i,a.remotePTS=i.metadata.timestamp,a.localPTS=performance.timeOrigin+performance.now(),typeof i.metadata.sentAt=="number"&&r?.(Date.now()-i.metadata.sentAt),this.mode==="correctly"&&this.shouldRejectOldData(t,o)){console.warn(`[VideoJitterBuffer] Rejecting old data. Expected: (group:${this.lastPoppedGroupId}, object:${this.lastPoppedObjectId}), Got: (group:${t}, object:${o})`);return}const u={groupId:t,objectId:o,bufferInsertTimestamp:performance.now(),sentAt:i.metadata.sentAt,object:a,isEndOfGroup:n.objectStatus===v},c=this.findInsertPos(t,o);this.buffer.splice(c,0,u),this.buffer.length>this.maxBufferSize&&(console.warn("[VideoJitterBuffer] Buffer full, dropping oldest entry"),this.buffer.shift())}pop(){return this.popWithMetadata()}popWithMetadata(){return this.buffer.length===0?null:this.mode==="buffered"?this.popBufferedMode():this.mode==="fast"?this.popFastMode():this.mode==="normal"?this.popNormalMode():this.popCorrectlyMode()}popBufferedMode(){for(;;){if(this.buffer.length===0)return null;const t=this.buffer[0].groupId;if(this.buffer.some(r=>r.groupId>=t+2n)){for(;this.buffer.length>0&&this.buffer[0].groupId===t;)this.buffer.shift();continue}if(this.buffer.length<=this.bufferedAheadFrames)return null;const n=this.buffer.shift();return n?(this.recordPopResult(n,Date.now()),n):null}}popFastMode(){if(this.buffer.length===0)return null;const t=this.buffer[0].groupId;if(this.buffer.some(r=>r.groupId>t))for(;this.buffer.length>0&&this.buffer[0].groupId===t;)this.buffer.shift();const n=this.buffer.shift();return n?(this.recordPopResult(n,Date.now()),n):null}popNormalMode(){const t=this.buffer[0],o=Date.now(),n=t.sentAt;return o-n<this.minDelayMs?null:(this.buffer.shift(),this.recordPopResult(t,o),t)}popCorrectlyMode(){const t=this.getExpectedNextEntry();let o=this.buffer.findIndex(c=>c.groupId===t.groupId&&c.objectId===t.objectId);if(o===-1&&(o=this.findResyncIndex(),o===-1)){if(this.lastPoppedGroupId===null&&this.buffer.length>0){const c=this.buffer.slice(0,5).map(m=>`(g:${m.groupId}, o:${m.objectId})`);console.warn(`[VideoJitterBuffer] Expected first entry not found. Expected: (g:${t.groupId}, o:${t.objectId}), Buffer: [${c.join(", ")}]`)}return null}const n=this.buffer[o],r=Date.now(),i=n.sentAt,a=r-i,u=this.lastPopWallTime===null?Number.POSITIVE_INFINITY:r-this.lastPopWallTime;return a<this.minDelayMs||u<R?null:(this.buffer.splice(o,1),this.recordPopResult(n,r),n)}shouldRejectOldData(t,o){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?!1:t<this.lastPoppedGroupId||t===this.lastPoppedGroupId&&o<=this.lastPoppedObjectId}recordPopResult(t,o){this.lastPopWallTime=o,this.lastPoppedGroupId=t.groupId,this.lastPoppedObjectId=t.objectId,t.isEndOfGroup&&this.pendingEndGroupTail.set(t.groupId,t.objectId)}getExpectedNextEntry(){if(this.lastPoppedGroupId===null||this.lastPoppedObjectId===null)return{groupId:0n,objectId:0n};const t=this.pendingEndGroupTail.get(this.lastPoppedGroupId);return t!==void 0&&this.lastPoppedObjectId>=t?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:this.keyframeInterval!==void 0&&this.lastPoppedObjectId===this.keyframeInterval-1n?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:{groupId:this.lastPoppedGroupId,objectId:this.lastPoppedObjectId+1n}}findInsertPos(t,o){for(let n=this.buffer.length-1;n>=0;n--){const r=this.buffer[n];if(r.groupId===t&&r.objectId<o||r.groupId<t)return n+1}return 0}findResyncIndex(){return this.buffer.length===0?-1:this.lastPoppedGroupId===null?0:this.buffer.findIndex(t=>t.objectId===0n&&t.groupId>this.lastPoppedGroupId)}}const V=300;function O(e,t=1e3){let o=0,n=performance.now();return{addBytes(r){o+=r;const i=performance.now();if(i-n>=t){const a=o*8/1e3;e(a),o=0,n=i}}}}const k=O(e=>{self.postMessage({type:"bitrate",kbps:e})}),E=BigInt(V),z={codec:"avc1.640032",hardwareAcceleration:"prefer-hardware",scalabilityMode:"L1T1"};let f;async function T(e){function t(r){console.debug("[videoDecoder] decoded frame",{timestamp:r.timestamp,duration:r.duration??null,codedWidth:r.codedWidth,codedHeight:r.codedHeight,displayWidth:r.displayWidth,displayHeight:r.displayHeight}),self.postMessage({type:"frame",frame:r,width:r.displayWidth,height:r.displayHeight}),r.close()}const o={output:t,error:r=>{console.log(r.message),f=void 0,s=null}},n=new VideoDecoder(o);return VideoDecoder.isConfigSupported(e).then(r=>{console.log("[videoDecoder] config supported",r)}).catch(r=>{console.warn("[videoDecoder] config support check failed",r)}),n.configure(e),console.info("[videoDecoder] (re)initializing decoder with config:",e),n}const U=33,h={maxBufferSize:9e3,mode:"fast",minDelayMs:250,bufferedAheadFrames:5};let b=w(),g={...h};function M(e){const t=e?.mode??h.mode,o=typeof e?.minDelayMs=="number"&&Number.isFinite(e.minDelayMs)&&e.minDelayMs>=0?e.minDelayMs:h.minDelayMs,n=typeof e?.maxBufferSize=="number"&&Number.isFinite(e.maxBufferSize)&&e.maxBufferSize>0?Math.floor(e.maxBufferSize):h.maxBufferSize,r=typeof e?.bufferedAheadFrames=="number"&&Number.isFinite(e.bufferedAheadFrames)&&e.bufferedAheadFrames>0?Math.floor(e.bufferedAheadFrames):h.bufferedAheadFrames;return{mode:t,minDelayMs:o,maxBufferSize:n,bufferedAheadFrames:r}}function w(e){const t=M(e),o=new $(t.maxBufferSize,t.mode,E);return o.setMinDelay(t.minDelayMs),o.setBufferedAheadFrames(t.bufferedAheadFrames),o}function H(e){g=M({...g,...e}),b=w(g)}let d=null,y=!1,s=null,l=null,I=null,A=null,j=!1,p=null;function W(e,t,o){p&&e<p.timestamp&&console.warn(`[videoDecoder] timestamp regression detected: prev=${p.timestamp} (group=${p.groupId.toString()} object=${p.objectId.toString()}) current=${e} (group=${t.toString()} object=${o.toString()})`),A=e,p={timestamp:e,groupId:t,objectId:o}}function J(e,t){if(!d){(e!==0n||t!==0n)&&console.warn(`[Video] First frame must be groupId=0, objectId=0 (keyframe). Got: groupId=${e}, objectId=${t}`);return}if(e!==d.groupId){if(!y){const o=E-1n;d.objectId!==o&&console.debug(`[Video] Group ended with unexpected objectId. Expected: ${o}, Got: ${d.objectId}, Group: ${d.groupId} -> ${e}`)}t!==0n&&console.warn(`[Video] New group should start with objectId 0. Got: ${t}, GroupId: ${e}`);return}t!==d.objectId+1n&&console.warn(`[Video] Non-sequential objectId detected. Expected: ${d.objectId+1n}, Got: ${t}, Gap: ${t-d.objectId-1n}`)}function Y(e,t){y=!1,d={groupId:e,objectId:t}}function Z(){y=!0}setInterval(()=>{const e=b.popWithMetadata();if(e){if(e.isEndOfGroup){Z();return}Q(e.groupId,e.object)}},U);function K(e){return e.type==="config"}function q(e){return e.type==="catalog"}self.onmessage=async e=>{if(K(e.data)){H(e.data.config);return}if(q(e.data)){oe(e.data.codec);return}const t={objectId:e.data.subgroupStreamObject.objectId,objectPayloadLength:e.data.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(e.data.subgroupStreamObject.objectPayload),objectStatus:e.data.subgroupStreamObject.objectStatus};k.addBytes(t.objectPayloadLength),b.push(e.data.groupId,t.objectId,t,o=>ee(o))};async function Q(e,t){J(e,t.objectId),Y(e,t.objectId);const o=t.cachedChunk;X(o.metadata.sentAt);const n=ne(o.metadata);if(!n)return;if(o.metadata.type==="key"){const u=ie(o.data),c=A,m=c!==null?o.metadata.timestamp-c:null;console.debug("[videoDecoder] keyframe timestamp",{groupId:e.toString(),objectId:t.objectId.toString(),timestamp:o.metadata.timestamp,duration:o.metadata.duration??null,delta:m}),console.debug("[videoDecoder] keyframe payload",{length:o.data.byteLength,head:u.head,hasStartCode:u.hasStartCode,startCodeAtZero:u.startCodeAtZero,nalTypes:u.nalSummary})}W(o.metadata.timestamp,e,t.objectId);const r=B(n),i=P(n);if(i&&o.metadata.type!=="key"){l=n;return}l&&o.metadata.type==="key"&&(P(l)&&await D(B(l),l),l=null);const a=new EncodedVideoChunk({type:o.metadata.type,timestamp:o.metadata.timestamp,duration:o.metadata.duration??void 0,data:o.data});(!f||f.state==="closed")&&(f=await T(r),s=n,S(n,r),o.metadata.type!=="key")||i&&(await D(r,n),o.metadata.type!=="key")||await f.decode(a)}async function D(e,t){try{f?.close()}catch(o){console.warn("[videoDecoder] failed to close before reconfigure",o)}f=await T(e),console.log("[videoDecoder] reinitialize with config:",e),s=t,S(t,e)}function X(e){if(typeof e!="number")return;const t=Date.now()-e;t<0||te(t)}function ee(e){e<0||self.postMessage({type:"receiveLatency",media:"video",ms:e})}function te(e){e<0||self.postMessage({type:"renderingLatency",media:"video",ms:e})}function S(e,t){const o=t.description instanceof Uint8Array?t.description.byteLength:void 0;self.postMessage({type:"decoderConfig",codec:e.codec,descriptionLength:o})}function oe(e){e&&I!==e&&(I=e,s&&s.codec!==e&&(l={codec:e,descriptionBase64:s.descriptionBase64,avcFormat:s.avcFormat}))}function ne(e){if(!(e.codec||e.descriptionBase64||e.avcFormat)&&!s)return null;const o=e.codec??s?.codec??I??void 0,n=e.descriptionBase64??s?.descriptionBase64,r=e.avcFormat??s?.avcFormat;return o?{codec:o,descriptionBase64:n,avcFormat:r}:null}function B(e){if(e.codec.startsWith("avc")){const t=e.descriptionBase64?F(e.descriptionBase64):void 0;return re(t),{...z,codec:e.codec,description:t,avc:{format:e.avcFormat??"avc"}}}return{codec:e.codec,description:e.descriptionBase64?F(e.descriptionBase64):void 0}}function P(e){return s?s.codec!==e.codec||s.descriptionBase64!==e.descriptionBase64||s.avcFormat!==e.avcFormat:!0}function F(e){const t=atob(e),o=t.length,n=new Uint8Array(o);for(let r=0;r<o;r++)n[r]=t.charCodeAt(r);return n}function re(e){if(!e||j)return;const t=C(e,8);console.log("[videoDecoder] description bytes",{length:e.byteLength,head:t}),j=!0}function C(e,t){const o=[],n=Math.min(e.byteLength,t);for(let r=0;r<n;r+=1)o.push(e[r].toString(16).padStart(2,"0").toUpperCase());return o.join(" ")}function ie(e){const t=C(e,12),o=se(e);return{head:t,hasStartCode:o.hasStartCode,startCodeAtZero:o.startCodeAtZero,nalSummary:o.types.length?o.types.join(","):"none"}}function se(e){const t=x(e,0);if(!t)return{hasStartCode:!1,startCodeAtZero:!1,types:[]};const o=[];let n=t.index+t.length,r=n;for(;;){const i=x(e,r);if((i?i.index:e.length)>n&&o.push(e[n]&31),!i)break;n=i.index+i.length,r=n}return{hasStartCode:!0,startCodeAtZero:t.index===0,types:o}}function x(e,t){for(let o=t;o+3<=e.length;o+=1)if(e[o]===0&&e[o+1]===0){if(e[o+2]===1)return{index:o,length:3};if(o+3<e.length&&e[o+2]===0&&e[o+3]===1)return{index:o,length:4}}return null}})();
