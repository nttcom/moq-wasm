(function(){"use strict";function l(o){if(o.byteLength<4)throw new Error("Payload too small to contain metadata");const t=new DataView(o.buffer,o.byteOffset,o.byteLength).getUint32(0),n=4+t;if(o.byteLength<n)throw new Error("Payload too small to contain metadata");const r=o.slice(4,4+t),s=JSON.parse(new TextDecoder().decode(r)),d=o.slice(4+t);return{metadata:s,data:d}}const p=50,h=1800,b=500,I=3;class m{constructor(e=h,t,n){this.maxBufferSize=e,this.mode=t,this.keyframeInterval=typeof n=="number"?BigInt(n):n??void 0}buffer=[];minDelayMs=p;lastPoppedGroupId=null;lastPoppedObjectId=null;keyframeInterval;setMinDelay(e){!Number.isFinite(e)||e<0||(this.minDelayMs=e)}push(e,t,n){if(!n.objectPayloadLength)return;const r=l(n.objectPayload);if(!r)return;const s=n;if(s.cachedChunk=r,s.remotePTS=r.metadata.timestamp,s.localPTS=performance.timeOrigin+performance.now(),this.mode==="video_correctly"&&this.shouldRejectOldData(e,t)){console.warn(`[JitterBuffer] Rejecting old data. Expected: (group:${this.lastPoppedGroupId}, object:${this.lastPoppedObjectId}), Got: (group:${e}, object:${t})`);return}const d={groupId:e,objectId:t,bufferInsertTimestamp:performance.now(),sentAt:r.metadata.sentAt,object:s,isEndOfGroup:n.objectStatus===I},S=this.findInsertPos(e,t);this.buffer.splice(S,0,d),this.mode==="audio"&&this.dropStaleEntries(b),this.buffer.length>this.maxBufferSize&&(console.warn("JitterBuffer is full, removing the oldest element"),this.buffer.shift())}shouldRejectOldData(e,t){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?!1:e<this.lastPoppedGroupId||e===this.lastPoppedGroupId&&t<=this.lastPoppedObjectId}pop(){return this.popWithMetadata()}popWithMetadata(){return this.buffer.length===0?null:this.mode==="video_normal"||this.mode==="audio"?this.popNormalMode():this.popCorrectlyMode()}popNormalMode(){const e=this.buffer[0];return performance.now()-e.bufferInsertTimestamp<this.minDelayMs?null:(this.buffer.shift(),this.recordPopResult(e),e)}popCorrectlyMode(){const e=this.getExpectedNextEntry();let t=this.buffer.findIndex(s=>s.groupId===e.groupId&&s.objectId===e.objectId);if(t===-1&&(t=this.findResyncIndex(),t===-1)){if(this.lastPoppedGroupId===null&&this.buffer.length>0){const s=this.buffer.slice(0,5).map(d=>`(g:${d.groupId}, o:${d.objectId})`);console.warn(`[JitterBuffer] Expected first entry not found. Expected: (g:${e.groupId}, o:${e.objectId}), Buffer: [${s.join(", ")}]`)}return null}const n=this.buffer[t];return performance.now()-n.bufferInsertTimestamp<this.minDelayMs?null:(this.buffer.splice(t,1),this.recordPopResult(n),n)}recordPopResult(e){this.lastPoppedGroupId=e.groupId,this.lastPoppedObjectId=e.objectId,e.isEndOfGroup&&(this.lastPoppedGroupId=e.groupId+1n,this.lastPoppedObjectId=-1n)}getExpectedNextEntry(){return this.lastPoppedGroupId===null||this.lastPoppedObjectId===null?{groupId:0n,objectId:0n}:this.keyframeInterval!==void 0&&this.lastPoppedObjectId===this.keyframeInterval-1n?{groupId:this.lastPoppedGroupId+1n,objectId:0n}:{groupId:this.lastPoppedGroupId,objectId:this.lastPoppedObjectId+1n}}findInsertPos(e,t){for(let n=this.buffer.length-1;n>=0;n--){const r=this.buffer[n];if(r.groupId===e&&r.objectId<t||r.groupId<e)return n+1}return 0}findResyncIndex(){return this.buffer.length===0?-1:this.lastPoppedGroupId===null?0:this.buffer.findIndex(e=>e.objectId===0n&&e.groupId>this.lastPoppedGroupId)}dropStaleEntries(e){const t=Date.now();for(;this.buffer.length>0;){const n=this.buffer[0];if(t-n.sentAt<=e)break;this.buffer.shift()}}}const g=300;function E(o,e=1e3){let t=0,n=performance.now();return{addBytes(r){t+=r;const s=performance.now();if(s-n>=e){const d=t*8/1e3;o(d),t=0,n=s}}}}const y=E(o=>{self.postMessage({type:"bitrate",kbps:o})}),f=BigInt(g),j={codec:"avc1.640028",avc:{format:"annexb"},hardwareAcceleration:"prefer-hardware",width:1920,height:1080,scalabilityMode:"L1T1"};let a;async function P(){function o(n){self.postMessage({type:"frame",frame:n}),n.close()}const e={output:o,error:n=>{console.log(n.message),a=void 0}},t=new VideoDecoder(e);return t.configure(j),t}const T=5,u=new m(1800,"video_correctly",f);let i=null,c=!1;function w(o,e){if(!i){(o!==0n||e!==0n)&&console.warn(`[Video] First frame must be groupId=0, objectId=0 (keyframe). Got: groupId=${o}, objectId=${e}`);return}if(o!==i.groupId){if(!c){const t=f-1n;i.objectId!==t&&console.debug(`[Video] Group ended with unexpected objectId. Expected: ${t}, Got: ${i.objectId}, Group: ${i.groupId} -> ${o}`)}e!==0n&&console.warn(`[Video] New group should start with objectId 0. Got: ${e}, GroupId: ${o}`);return}e!==i.objectId+1n&&console.warn(`[Video] Non-sequential objectId detected. Expected: ${i.objectId+1n}, Got: ${e}, Gap: ${e-i.objectId-1n}`)}function _(o,e){c=!1,i={groupId:o,objectId:e}}function G(){c=!0}setInterval(()=>{const o=u.popWithMetadata();if(o){if(o.isEndOfGroup){G();return}M(o.groupId,o.object)}},T),self.onmessage=async o=>{const e={objectId:o.data.subgroupStreamObject.objectId,objectPayloadLength:o.data.subgroupStreamObject.objectPayloadLength,objectPayload:new Uint8Array(o.data.subgroupStreamObject.objectPayload),objectStatus:o.data.subgroupStreamObject.objectStatus};y.addBytes(e.objectPayloadLength),u.push(o.data.groupId,e.objectId,e)};async function M(o,e){w(o,e.objectId),_(o,e.objectId);const t=e.cachedChunk;L(t.metadata.sentAt,"video");const n=new EncodedVideoChunk({type:t.metadata.type,timestamp:t.metadata.timestamp,duration:t.metadata.duration??void 0,data:t.data});(!a||a.state==="closed")&&(a=await P(),t.metadata.type!=="key")||await a.decode(n)}function L(o,e){if(typeof o!="number")return;const t=Date.now()-o;!Number.isFinite(t)||t<0||self.postMessage({type:"latency",media:e,ms:t})}})();
