import{_ as v,M as k}from"./moqt_client_sample-14fa4cf3.js";const f=900,B="secret";function I(e){const t={type:e.type,timestamp:e.timestamp,duration:e.duration??0},n=JSON.stringify(t),o=new TextEncoder().encode(n),s=o.length,a=new Uint8Array(e.byteLength);e.copyTo(a);const r=4+s+a.length,c=new Uint8Array(r);return new DataView(c.buffer).setUint32(0,s),c.set(o,4),c.set(a,4+s),c}function S(){let e=0,t=performance.now();return{addBytes(n){e+=n;const o=performance.now();if(o-t>=1e3){const s=e*8/1e6;console.log(`chunkData bitrate: ${s.toFixed(2)} Mbps`),e=0,t=o}}}}const w=S();let m={groupId:BigInt(0),subgroupId:BigInt(0),objectId:BigInt(0)};async function j(e,t,n,o,s,a){w.addBytes(s.byteLength);const r=I(s);await a.sendSubgroupStreamObject(BigInt(e),t,n,o,void 0,r),t>m.groupId&&(await a.sendSubgroupStreamObject(BigInt(e),m.groupId,BigInt(0),BigInt(f),3,Uint8Array.from([])),console.log("send Object(ObjectStatus=EndOfGroup)")),m={groupId:t,subgroupId:n,objectId:o}}async function A(e,t,n,o,s,a){const r=I(s);await a.sendSubgroupStreamObject(BigInt(e),t,n,o,void 0,r)}const u=()=>document.getElementById("form");let l=null;function E(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const t={audio:!0,video:{width:{exact:1920},height:{exact:1080}}};l=await navigator.mediaDevices.getUserMedia(t);const n=document.getElementById("video");n.srcObject=l})}const d={video:{objectId:0n,groupId:-1n,subgroups:{0:{}}},audio:{objectId:0n,groupId:0n,subgroups:{0:{isSendedSubgroupHeader:!1}}}},b=new Worker(new URL("/moq-wasm/assets/videoEncoder-abed5da4.js",self.location),{type:"module"});async function M(e,t,n){const o=u(),s=o["video-object-track-alias"].value,a=o["video-publisher-priority"].value;if(e.type==="key"){d.video.groupId++,d.video.objectId=BigInt(0);const r=Object.keys(d.video.subgroups).map(BigInt);for(const c of r)await n.sendSubgroupStreamHeaderMessage(BigInt(s),d.video.groupId,c,a),console.log("send subgroup stream header")}j(s,d.video.groupId,BigInt(t==null?void 0:t.svc.temporalLayerId),d.video.objectId,e,n),d.video.objectId++}const y=new Worker(new URL("/moq-wasm/assets/audioEncoder-0254ff8a.js",self.location),{type:"module"});async function h(e,t,n){const o=u(),s=o["audio-object-track-alias"].value,a=o["audio-publisher-priority"].value,r=0;d.audio.subgroups[r].isSendedSubgroupHeader||(await n.sendSubgroupStreamHeaderMessage(BigInt(s),d.audio.groupId,BigInt(r),a),console.log("send subgroup stream header"),d.audio.subgroups[r].isSendedSubgroupHeader=!0),A(s,d.audio.groupId,BigInt(r),d.audio.objectId,e,n),d.audio.objectId++}function O(e){e.onSetup(async t=>{console.log({serverSetup:t})}),e.onAnnounce(async t=>{console.log({announceMessage:t});const n=t.track_namespace;await e.sendAnnounceOkMessage(n)}),e.onAnnounceResponse(async t=>{console.log({announceResponseMessage:t})}),e.onSubscribe(async(t,n,o)=>{console.log({subscribeMessage:t});const s=u(),a=BigInt(t.subscribe_id),r=BigInt(t.track_alias);if(console.log("subscribeId",a,"trackAlias",r),n){const c=0n,i=Array.from(s["forwarding-preference"]).filter(g=>g.checked)[0].value;await e.sendSubscribeOkMessage(a,c,B,i)}else{const c="subscribe error";await e.sendSubscribeErrorMessage(t.subscribe_id,o,c)}})}function L(e){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const n=u(),o=new BigUint64Array("0xff00000A".split(",").map(BigInt)),s=BigInt(n["max-subscribe-id"].value);await e.sendSetupMessage(o,s)})}function T(e){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const o=u()["announce-track-namespace"].value.split("/");await e.sendAnnounceMessage(o,B)})}function U(e){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(console.log("clicked sendSubgroupObjectBtn"),l==null){console.error("mediaStream is null");return}b.onmessage=async i=>{const{chunk:g,metadata:p}=i.data;M(g,p,e)},y.onmessage=async i=>{const{chunk:g,metadata:p}=i.data;h(g,p,e)};const[n]=l.getVideoTracks(),s=new MediaStreamTrackProcessor({track:n}).readable;b.postMessage({type:"keyframeInterval",keyframeInterval:f}),b.postMessage({type:"videoStream",videoStream:s},[s]);const[a]=l.getAudioTracks(),c=new MediaStreamTrackProcessor({track:a}).readable;y.postMessage({type:"audioStream",audioStream:c},[c])})}function C(e){L(e),T(e),U(e)}v().then(async()=>{E(),document.getElementById("connectBtn").addEventListener("click",async()=>{const n=u().url.value,o=new k(n);O(o),C(o),await o.start()})});
