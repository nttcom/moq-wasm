(function(){"use strict";function p(e,o=1e3){let t=0,r=performance.now();return{addBytes(n){t+=n;const s=performance.now();if(s-r>=o){const h=t*8/1e3;e(h),t=0,r=s}}}}const m=1e3;function g(){return Math.round((performance.timeOrigin+performance.now())*m)}let i,d,u=null,c=null;const a=new Map,y=p(e=>{self.postMessage({type:"bitrate",kbps:e})});function v(e,o){y.addBytes(e.byteLength),c===null&&(c=e.timestamp,console.info("[videoEncoder] Set timestamp offset:",c));const t=e.timestamp-c,r=new ArrayBuffer(e.byteLength);e.copyTo(r);const n=new EncodedVideoChunk({type:e.type,timestamp:t,duration:e.duration??void 0,data:r}),s=w(e.timestamp);self.postMessage({type:"chunk",chunk:n,metadata:o,captureTimestampMicros:s})}async function f(){const e={output:v,error:r=>{console.log(r.message)}},o=u??M();try{if(!(await VideoEncoder.isConfigSupported(o)).supported){self.postMessage({type:"configError",reason:"unsupported",config:o});return}}catch{self.postMessage({type:"configError",reason:"unsupported",config:o});return}const t=new VideoEncoder(e);try{t.configure(o)}catch(r){console.error("[videoEncoder] configure failed",r),self.postMessage({type:"configError",reason:"unsupported",config:o});return}return console.info("[videoEncoder] initialized",o),t}async function b(e){let o=0;if(c=null,a.clear(),console.log("initializeVideoEncoder"),i=await f(),!i)return;const t=e.getReader();for(;;){const r=await t.read();if(r.done)break;const n=r.value;if((!i||i.state==="closed")&&(console.log("Re-initialize video encoder"),i=await f(),o=0,a.clear(),!i)){console.error("Failed to initialize video encoder, dropping frame"),n.close();continue}if(i.encodeQueueSize>10){console.error("videoEncoder.encodeQueueSize > 10",i.encodeQueueSize),n.close();continue}const s=o%d==0;E(n.timestamp,g()),i.encode(n,{keyFrame:s}),o++,n.close()}}function E(e,o){if(!(typeof e!="number"||!Number.isFinite(e))&&(a.set(e,o),a.size>1024)){const t=a.keys().next().value;typeof t=="number"&&a.delete(t)}}function w(e){if(!Number.isFinite(e))return;const o=a.get(e);if(o!==void 0)return a.delete(e),o}self.onmessage=async e=>{if(console.debug("videoEncoder worker received message",e.data),e.data.type==="keyframeInterval")d=e.data.keyframeInterval;else if(e.data.type==="encoderConfig"){const o=l(e.data.config);if(u=o,i&&i.state!=="closed")try{i.configure(o),console.info("[videoEncoder] reconfigured",o)}catch(t){console.error("[videoEncoder] reconfigure failed",t),self.postMessage({type:"configError",reason:"reconfigure_failed",config:o})}}else if(e.data.type==="videoStream"){const o=e.data.videoStream;if(!o){console.error("MediaStreamTrack が渡されていません");return}await b(o)}};function l(e){return{codec:e.codec,avc:e.codec.startsWith("avc")?{format:"annexb"}:void 0,width:e.width,height:e.height,bitrate:e.bitrate,framerate:30,scalabilityMode:"L1T1",latencyMode:"realtime"}}function M(){return l({codec:"avc1.640032",width:1280,height:720,bitrate:1e6})}})();
