import{M as A,p as M}from"./moqtClient-zrBAeNrX.js";/* empty css              */import{e as H,d as D,f as x}from"./catalog-BYlufEzj.js";const v="secret",g=()=>document.getElementById("form");function k(e){const t=Array.isArray(e?.extensions)?e.extensions??[]:[],o=n=>t.some(a=>typeof a=="object"&&a!==null&&a.type===n);return{present:!!e,extensionCount:t.length,hasCaptureTimestamp:o("captureTimestamp"),hasVideoConfig:o("videoConfig"),hasVideoFrameMarking:o("videoFrameMarking"),hasAudioLevel:o("audioLevel")}}const i=new A,j=new Worker(new URL("/moq-wasm/assets/audioDecoder-gO9Ilowg.js",import.meta.url),{type:"module"}),y=new Worker(new URL("/moq-wasm/assets/videoDecoder-DbPKuoFa.js",import.meta.url),{type:"module"});let S=!1,B=!1,I=!1,l=[],m=[],f=null,p=null;function $(e){const t=e.split(",").map(o=>o.trim()).filter(o=>o.length>0).map(o=>BigInt(o));return new BigUint64Array(t)}function L(e){return e.split("/").map(t=>t.trim()).filter(t=>t.length>0)}function r(e){const t=document.getElementById("catalog-track-status");if(!t)return;const o=e.trim();t.textContent=o,t.style.display=o.length>0?"":"none"}function u(e){const t=e==="video"?"selected-video-track":"selected-audio-track";return document.getElementById(t)}function W(e){return e==="video"?l:m}function P(e){return e==="video"?f:p}function E(e,t){e==="video"?f=t:p=t}function b(e,t){E(e,t);const o=u(e);if(o&&t&&(o.value=t),e!=="video")return;const n=l.find(a=>a.name===t);t&&y.postMessage({type:"catalog",codec:n?.codec??x})}function V(e,t){if(t==="video"){const a=typeof e.width=="number"&&typeof e.height=="number"?` (${e.width}x${e.height})`:"";return`${e.label}${a}`}const o=[];e.codec&&o.push(e.codec),typeof e.samplerate=="number"&&o.push(`${e.samplerate}Hz`),e.channelConfig&&o.push(e.channelConfig),typeof e.bitrate=="number"&&o.push(`${Math.round(e.bitrate/1e3)}kbps`);const n=o.length>0?` (${o.join(", ")})`:"";return`${e.label}${n}`}function w(e){const t=u(e);if(!t)return!1;t.innerHTML="";const o=W(e),a=e==="video"?"Catalog video tracks are not loaded yet":"Catalog audio tracks are not loaded yet";if(!o.length){const s=document.createElement("option");return s.value="",s.textContent=a,s.disabled=!0,s.selected=!0,t.appendChild(s),b(e,null),!1}let c=P(e);(!c||!o.some(s=>s.name===c))&&(c=o[0].name,E(e,c));for(const s of o){const d=document.createElement("option");d.value=s.name,d.textContent=V(s,e),d.selected=s.name===c,t.appendChild(d)}return b(e,c),!0}function C(){const e=w("video"),t=w("audio");if(!e&&!t){r("");return}r(`Catalog loaded: video=${l.length}, audio=${m.length}`)}function U(){const e=u("video");e&&e.addEventListener("change",()=>{const o=e.value.trim();b("video",o.length>0?o:null)});const t=u("audio");t&&t.addEventListener("change",()=>{const o=t.value.trim();b("audio",o.length>0?o:null)})}function _(e){i.setOnSubgroupObjectHandler(e,(t,o)=>{const n=new TextDecoder().decode(new Uint8Array(o.objectPayload));try{const a=M(n);l=H(a),m=D(a),C()}catch(a){console.error("[MediaSubscriber] failed to parse catalog",a),r("Catalog parse failed")}})}function F(){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const t=g(),o=$("0xff00000A"),n=BigInt(t["max-subscribe-id"].value);await i.sendSetupMessage(o,n)})}function z(){document.getElementById("sendCatalogSubscribeBtn").addEventListener("click",async()=>{const t=g(),o=L(t["subscribe-track-namespace"].value),n=t["catalog-track-name"].value.trim(),a=BigInt(t["catalog-subscribe-id"].value),c=BigInt(t["catalog-track-alias"].value);if(!n){r("Catalog track is required");return}_(c),await i.subscribe(a,c,o,n,v),r(`Catalog subscribed: ${n}`)})}function q(){document.getElementById("sendSubscribeBtn").addEventListener("click",async()=>{const t=g(),o=L(t["subscribe-track-namespace"].value),n=f??"",a=p??"",c=BigInt(t["video-subscribe-id"].value),s=BigInt(t["video-track-alias"].value),d=BigInt(t["audio-subscribe-id"].value),h=BigInt(t["audio-track-alias"].value);if(!n||!a){r("Select video and audio tracks from catalog first");return}T("video",s),await i.subscribe(c,s,o,n,v),T("audio",h),await i.subscribe(d,h,o,a,v),r(`Subscribed video=${n}, audio=${a}`)})}function N(){if(S)return;S=!0;const e=new MediaStreamTrackGenerator({kind:"audio"}),t=e.writable.getWriter(),o=new MediaStream([e]),n=document.getElementById("audio");n.srcObject=o,j.onmessage=async a=>{const c=a.data;if(c.type!=="audioData"){console.debug("[MediaSubscriber] audio worker event",c);return}await t.ready,await t.write(c.audioData),await n.play()}}function G(){if(B)return;B=!0;const e=new MediaStreamTrackGenerator({kind:"video"}),t=e.writable.getWriter(),o=new MediaStream([e]),n=document.getElementById("video");n.srcObject=o,y.onmessage=async a=>{const c=a.data;if(c.type!=="frame"){console.debug("[MediaSubscriber] video worker event",c);return}const s=c.frame;await t.ready,await t.write(s),s.close(),await n.play()}}function T(e,t){const o=t;if(e==="audio"){N(),i.setOnSubgroupObjectHandler(o,(n,a)=>{const c=new Uint8Array(a.objectPayload),s=k(a.locHeader);s.present&&s.extensionCount>0&&console.debug("[MediaSubscriber] LoC object (audio)",{trackAlias:o.toString(),groupId:n,objectId:a.objectId,loc:s}),console.debug("[MediaSubscriber] recv audio object",{groupId:n,objectId:a.objectId,payloadLength:a.objectPayloadLength,payloadByteLength:c.byteLength,status:a.objectStatus,loc:s}),j.postMessage({groupId:n,subgroupStreamObject:{objectId:a.objectId,objectPayloadLength:a.objectPayloadLength,objectPayload:c,objectStatus:a.objectStatus,locHeader:a.locHeader}},[c.buffer])});return}G(),i.setOnSubgroupObjectHandler(o,(n,a)=>{const c=new Uint8Array(a.objectPayload),s=k(a.locHeader);s.present&&s.extensionCount>0&&console.debug("[MediaSubscriber] LoC object (video)",{trackAlias:o.toString(),groupId:n,objectId:a.objectId,loc:s}),console.debug("[MediaSubscriber] recv video object",{groupId:n,objectId:a.objectId,payloadLength:a.objectPayloadLength,payloadByteLength:c.byteLength,status:a.objectStatus,loc:s}),y.postMessage({groupId:n,subgroupStreamObject:{objectId:a.objectId,objectPayloadLength:a.objectPayloadLength,objectPayload:c,objectStatus:a.objectStatus,locHeader:a.locHeader}},[c.buffer])})}i.setOnServerSetupHandler(e=>{console.log({serverSetup:e})});i.setOnSubscribeResponseHandler(e=>{console.log({subscribeResponse:e})});function R(){document.getElementById("closeBtn").addEventListener("click",async()=>{await i.disconnect(),i.clearSubgroupObjectHandlers(),l=[],m=[],f=null,p=null,C(),r("Disconnected")})}function K(){I||(F(),z(),q(),U(),R(),I=!0)}const J=document.getElementById("connectBtn");J.addEventListener("click",async()=>{const t=g().url.value;await i.connect(t,{sendSetup:!1}),r("Connected")});K();C();
