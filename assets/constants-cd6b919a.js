var p=Object.defineProperty;var c=(s,e,o)=>e in s?p(s,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[e]=o;var t=(s,e,o)=>(c(s,typeof e!="symbol"?e+"":e,o),o);function I(s){if(typeof s=="bigint")return s;try{return BigInt(s)}catch{throw new Error(`Invalid alias value: ${s}`)}}function a(s){return I(s).toString()}class l{constructor(){t(this,"video",{groupId:-1n,objectId:0n,subgroups:new Map([[0,{sentAliases:new Set}]])});t(this,"audio",{groupId:0n,objectId:0n,subgroups:new Map([[0,{sentAliases:new Set}]])})}ensureVideoSubgroup(e){this.ensureSubgroup(this.video,e)}ensureAudioSubgroup(e){this.ensureSubgroup(this.audio,e)}advanceVideoGroup(){this.video.groupId+=1n,this.video.objectId=0n,this.resetHeaders(this.video)}getVideoGroupId(){return this.video.groupId}getVideoObjectId(){return this.video.objectId}incrementVideoObject(){this.video.objectId+=1n}hasVideoHeaderSent(e,o){return this.hasHeaderSent(this.video,e,o)}markVideoHeaderSent(e,o){this.markHeaderSent(this.video,e,o)}getAudioGroupId(){return this.audio.groupId}getAudioObjectId(){return this.audio.objectId}incrementAudioObject(){this.audio.objectId+=1n}shouldSendAudioHeader(e,o){return!this.hasHeaderSent(this.audio,e,o)}markAudioHeaderSent(e,o){this.markHeaderSent(this.audio,e,o)}listVideoSubgroups(){return Array.from(this.video.subgroups.keys())}resetAlias(e){const o=a(e);for(const i of this.video.subgroups.values())i.sentAliases.delete(o);for(const i of this.audio.subgroups.values())i.sentAliases.delete(o)}ensureSubgroup(e,o){e.subgroups.has(o)||e.subgroups.set(o,{sentAliases:new Set})}resetHeaders(e){for(const o of e.subgroups.values())o.sentAliases.clear()}hasHeaderSent(e,o,i){return this.ensureSubgroup(e,i),e.subgroups.get(i).sentAliases.has(a(o))}markHeaderSent(e,o,i){this.ensureSubgroup(e,i),e.subgroups.get(i).sentAliases.add(a(o))}}async function S({chunk:s,metadata:e,trackAliases:o,publisherPriority:i,client:n,transportState:u,sender:h}){var g;if(!o.length)return;const d=Number(((g=e==null?void 0:e.svc)==null?void 0:g.temporalLayerId)??0);if(u.ensureVideoSubgroup(d),s.type==="key"){u.advanceVideoGroup();for(const r of o)for(const b of u.listVideoSubgroups())await n.sendSubgroupStreamHeaderMessage(r,u.getVideoGroupId(),BigInt(b),i),u.markVideoHeaderSent(r,b)}else for(const r of o)u.hasVideoHeaderSent(r,d)||(await n.sendSubgroupStreamHeaderMessage(r,u.getVideoGroupId(),BigInt(d),i),u.markVideoHeaderSent(r,d));for(const r of o)await h(r,u.getVideoGroupId(),BigInt(d),u.getVideoObjectId(),s,n);u.incrementVideoObject()}const V=300;export{V as K,l as M,S as s};
