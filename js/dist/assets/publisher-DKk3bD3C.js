import{_ as j,M as O}from"./moqt_client_sample-Cp6SEKRE.js";const f=900,C="secret";async function L(n,o,s,c,r,e,i){var a,v,B,k,S,I,A,h,w;const t=new Uint8Array(r.byteLength);r.copyTo(t);const d={type:r.type,timestamp:r.timestamp,duration:r.duration,byteLength:r.byteLength,data:Array.from(t),decoderConfig:{codec:(a=e==null?void 0:e.decoderConfig)==null?void 0:a.codec,codedHeight:(v=e==null?void 0:e.decoderConfig)==null?void 0:v.codedHeight,codedWidth:(B=e==null?void 0:e.decoderConfig)==null?void 0:B.codedWidth,colorSpace:(k=e==null?void 0:e.decoderConfig)==null?void 0:k.colorSpace,description:(S=e==null?void 0:e.decoderConfig)==null?void 0:S.description,displayAspectHeight:(I=e==null?void 0:e.decoderConfig)==null?void 0:I.displayAspectHeight,displayAspectWidth:(A=e==null?void 0:e.decoderConfig)==null?void 0:A.displayAspectWidth,hardwareAcceleration:(h=e==null?void 0:e.decoderConfig)==null?void 0:h.hardwareAcceleration,optimizeForLatency:(w=e==null?void 0:e.decoderConfig)==null?void 0:w.optimizeForLatency},temporalLayer:e==null?void 0:e.temporalLayerId},g=new TextEncoder,y=JSON.stringify({chunk:d}),M=g.encode(y);await i.sendSubgroupStreamObject(BigInt(n),o,s,c,void 0,M),c===BigInt(f-1)&&(await i.sendSubgroupStreamObject(BigInt(n),o,s,BigInt(f),3,Uint8Array.from([])),console.log("send Object(ObjectStatus=EndOfGroup)"))}const p=()=>document.getElementById("form");let l=null;function m(){document.getElementById("startGetUserMediaBtn").addEventListener("click",async()=>{const o={audio:!0,video:{width:{exact:1920},height:{exact:1080}}};l=await navigator.mediaDevices.getUserMedia(o);const s=document.getElementById("video");s.srcObject=l})}const u={video:{objectId:0n,groupId:-1n,subgroups:{0:{},1:{},2:{}}}},b=new Worker("videoEncoder.ts");async function T(n,o,s){const c=p(),r=c["video-object-track-alias"].value,e=c["video-publisher-priority"].value;if(n.type==="key"){u.video.groupId++,u.video.objectId=BigInt(0);const i=Object.keys(u.video.subgroups).map(BigInt);for(const t of i)await s.sendSubgroupStreamHeaderMessage(BigInt(r),u.video.groupId,t,e),console.log("send subgroup stream header")}L(r,u.video.groupId,BigInt(o==null?void 0:o.svc.temporalLayerId),u.video.objectId,n,o,s),u.video.objectId++}const E=new Worker("audioEncoder.ts");function P(n){n.onSetup(async o=>{console.log({serverSetup:o})}),n.onAnnounce(async o=>{console.log({announceMessage:o});const s=o.track_namespace;await n.sendAnnounceOkMessage(s)}),n.onAnnounceResponce(async o=>{console.log({announceResponceMessage:o})}),n.onSubscribe(async(o,s,c)=>{console.log({subscribeMessage:o});const r=p(),e=BigInt(o.subscribe_id),i=BigInt(o.track_alias);if(console.log("subscribeId",e,"trackAlias",i),s){const t=0n,d=Array.from(r["forwarding-preference"]).filter(g=>g.checked)[0].value;await n.sendSubscribeOkMessage(e,t,C,d)}else await n.sendSubscribeErrorMessage(o.subscribe_id,c,"subscribe error")})}function H(n){document.getElementById("sendSetupBtn").addEventListener("click",async()=>{const s=p(),c=new BigUint64Array("0xff00000A".split(",").map(BigInt)),r=BigInt(s["max-subscribe-id"].value);await n.sendSetupMessage(c,r)})}function U(n){document.getElementById("sendAnnounceBtn").addEventListener("click",async()=>{const c=p()["announce-track-namespace"].value.split("/");await n.sendAnnounceMessage(c,C)})}function _(n){document.getElementById("sendSubgroupObjectBtn").addEventListener("click",async()=>{if(l==null){console.error("mediaStream is null");return}b.onmessage=async d=>{const{chunk:g,metadata:y}=d.data;T(g,y,n)},E.onmessage=async d=>{const{chunk:g,metadata:y}=d.data};const[s]=l.getVideoTracks(),r=new MediaStreamTrackProcessor({track:s}).readable;b.postMessage({type:"keyframeInterval",keyframeInterval:f}),b.postMessage({type:"videoStream",videoStream:r},[r]);const[e]=l.getAudioTracks(),t=new MediaStreamTrackProcessor({track:e}).readable;E.postMessage({type:"audioStream",audioStream:t},[t])})}function W(n){H(n),U(n),_(n)}j().then(async()=>{m(),document.getElementById("connectBtn").addEventListener("click",async()=>{const s=p().url.value,c=new O(s);P(c),W(c),await c.start()})});
